var En=Object.defineProperty,Gn=Object.defineProperties;var wn=Object.getOwnPropertyDescriptors;var Ht=Object.getOwnPropertySymbols;var Un=Object.prototype.hasOwnProperty,Xn=Object.prototype.propertyIsEnumerable;var Vt=(a,e,t)=>e in a?En(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,ht=(a,e)=>{for(var t in e||(e={}))Un.call(e,t)&&Vt(a,t,e[t]);if(Ht)for(var t of Ht(e))Xn.call(e,t)&&Vt(a,t,e[t]);return a},Yt=(a,e)=>Gn(a,wn(e));import{E as Dn,V as D,M as Me,a as Fe,Q as Wt,b as Qt,c as V,D as Cn,F as Ee,H as xt,R as Lt,U as et,d as kn,e as At,L as gt,f as ye,g as Kt,N as vt,h as _t,C,i as On,B as Ge,j as ie,k as tt,l as Zt,A as zn,m as Bn,n as Hn,P as jt,o as we,p as qt,q as Le,r as nt,s as Vn,t as Yn,u as Wn,v as Ue,w as Xe,x as Tt,y as St,z as Qn,I as Kn,G as Zn,J as jn,K as qn,O as Jt,W as Jn,X as $n,Y as Mt,Z as $t,_ as ea,$ as ta,T as na,a0 as aa,a1 as ia,a2 as sa,a3 as oa,a4 as ra,a5 as la,a6 as ca,a7 as ua,a8 as fa,a9 as en,aa as da,ab as pa,ac as ma,ad as ha,ae as Ft,af as xa,ag as La,ah as Aa,ai as ga,aj as va,ak as _a,al as Ta,am as Sa,an as Ma,ao as Fa,ap as ya,aq as tn,ar as ba,as as Ia}from"./vendor.fd21b549.js";const Na=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerpolicy&&(s.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?s.credentials="include":i.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(i){if(i.ep)return;i.ep=!0;const s=t(i);fetch(i.href,s)}};Na();const nn={type:"change"},yt={type:"start"},bt={type:"end"};class Ds extends Dn{constructor(e,t){super();t===void 0&&console.warn('THREE.OrbitControls: The second parameter "domElement" is now mandatory.'),t===document&&console.error('THREE.OrbitControls: "document" should not be used as the target "domElement". Please use "renderer.domElement" instead.'),this.object=e,this.domElement=t,this.domElement.style.touchAction="none",this.enabled=!0,this.target=new D,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:Me.ROTATE,MIDDLE:Me.DOLLY,RIGHT:Me.PAN},this.touches={ONE:Fe.ROTATE,TWO:Fe.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this.getPolarAngle=function(){return r.phi},this.getAzimuthalAngle=function(){return r.theta},this.getDistance=function(){return this.object.position.distanceTo(this.target)},this.listenToKeyEvents=function(m){m.addEventListener("keydown",qe),this._domElementKeyEvents=m},this.saveState=function(){n.target0.copy(n.target),n.position0.copy(n.object.position),n.zoom0=n.object.zoom},this.reset=function(){n.target.copy(n.target0),n.object.position.copy(n.position0),n.object.zoom=n.zoom0,n.object.updateProjectionMatrix(),n.dispatchEvent(nn),n.update(),s=i.NONE},this.update=function(){const m=new D,b=new Wt().setFromUnitVectors(e.up,new D(0,1,0)),O=b.clone().invert(),H=new D,Y=new Wt,ae=2*Math.PI;return function(){const Je=n.object.position;m.copy(Je).sub(n.target),m.applyQuaternion(b),r.setFromVector3(m),n.autoRotate&&s===i.NONE&&y(I()),n.enableDamping?(r.theta+=l.theta*n.dampingFactor,r.phi+=l.phi*n.dampingFactor):(r.theta+=l.theta,r.phi+=l.phi);let $=n.minAzimuthAngle,q=n.maxAzimuthAngle;return isFinite($)&&isFinite(q)&&($<-Math.PI?$+=ae:$>Math.PI&&($-=ae),q<-Math.PI?q+=ae:q>Math.PI&&(q-=ae),$<=q?r.theta=Math.max($,Math.min(q,r.theta)):r.theta=r.theta>($+q)/2?Math.max($,r.theta):Math.min(q,r.theta)),r.phi=Math.max(n.minPolarAngle,Math.min(n.maxPolarAngle,r.phi)),r.makeSafe(),r.radius*=c,r.radius=Math.max(n.minDistance,Math.min(n.maxDistance,r.radius)),n.enableDamping===!0?n.target.addScaledVector(u,n.dampingFactor):n.target.add(u),m.setFromSpherical(r),m.applyQuaternion(O),Je.copy(n.target).add(m),n.object.lookAt(n.target),n.enableDamping===!0?(l.theta*=1-n.dampingFactor,l.phi*=1-n.dampingFactor,u.multiplyScalar(1-n.dampingFactor)):(l.set(0,0,0),u.set(0,0,0)),c=1,f||H.distanceToSquared(n.object.position)>o||8*(1-Y.dot(n.object.quaternion))>o?(n.dispatchEvent(nn),H.copy(n.object.position),Y.copy(n.object.quaternion),f=!1,!0):!1}}(),this.dispose=function(){n.domElement.removeEventListener("contextmenu",ne),n.domElement.removeEventListener("pointerdown",Ke),n.domElement.removeEventListener("pointercancel",Ze),n.domElement.removeEventListener("wheel",je),n.domElement.removeEventListener("pointermove",Ne),n.domElement.removeEventListener("pointerup",Pe),n._domElementKeyEvents!==null&&n._domElementKeyEvents.removeEventListener("keydown",qe)};const n=this,i={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6};let s=i.NONE;const o=1e-6,r=new Qt,l=new Qt;let c=1;const u=new D;let f=!1;const d=new V,p=new V,h=new V,L=new V,x=new V,g=new V,M=new V,A=new V,T=new V,S=[],F={};function I(){return 2*Math.PI/60/60*n.autoRotateSpeed}function P(){return Math.pow(.95,n.zoomSpeed)}function y(m){l.theta-=m}function E(m){l.phi-=m}const _=function(){const m=new D;return function(O,H){m.setFromMatrixColumn(H,0),m.multiplyScalar(-O),u.add(m)}}(),N=function(){const m=new D;return function(O,H){n.screenSpacePanning===!0?m.setFromMatrixColumn(H,1):(m.setFromMatrixColumn(H,0),m.crossVectors(n.object.up,m)),m.multiplyScalar(O),u.add(m)}}(),w=function(){const m=new D;return function(O,H){const Y=n.domElement;if(n.object.isPerspectiveCamera){const ae=n.object.position;m.copy(ae).sub(n.target);let he=m.length();he*=Math.tan(n.object.fov/2*Math.PI/180),_(2*O*he/Y.clientHeight,n.object.matrix),N(2*H*he/Y.clientHeight,n.object.matrix)}else n.object.isOrthographicCamera?(_(O*(n.object.right-n.object.left)/n.object.zoom/Y.clientWidth,n.object.matrix),N(H*(n.object.top-n.object.bottom)/n.object.zoom/Y.clientHeight,n.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),n.enablePan=!1)}}();function B(m){n.object.isPerspectiveCamera?c/=m:n.object.isOrthographicCamera?(n.object.zoom=Math.max(n.minZoom,Math.min(n.maxZoom,n.object.zoom*m)),n.object.updateProjectionMatrix(),f=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),n.enableZoom=!1)}function G(m){n.object.isPerspectiveCamera?c*=m:n.object.isOrthographicCamera?(n.object.zoom=Math.max(n.minZoom,Math.min(n.maxZoom,n.object.zoom/m)),n.object.updateProjectionMatrix(),f=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),n.enableZoom=!1)}function Q(m){d.set(m.clientX,m.clientY)}function k(m){M.set(m.clientX,m.clientY)}function X(m){L.set(m.clientX,m.clientY)}function fe(m){p.set(m.clientX,m.clientY),h.subVectors(p,d).multiplyScalar(n.rotateSpeed);const b=n.domElement;y(2*Math.PI*h.x/b.clientHeight),E(2*Math.PI*h.y/b.clientHeight),d.copy(p),n.update()}function j(m){A.set(m.clientX,m.clientY),T.subVectors(A,M),T.y>0?B(P()):T.y<0&&G(P()),M.copy(A),n.update()}function me(m){x.set(m.clientX,m.clientY),g.subVectors(x,L).multiplyScalar(n.panSpeed),w(g.x,g.y),L.copy(x),n.update()}function z(m){m.deltaY<0?G(P()):m.deltaY>0&&B(P()),n.update()}function te(m){let b=!1;switch(m.code){case n.keys.UP:w(0,n.keyPanSpeed),b=!0;break;case n.keys.BOTTOM:w(0,-n.keyPanSpeed),b=!0;break;case n.keys.LEFT:w(n.keyPanSpeed,0),b=!0;break;case n.keys.RIGHT:w(-n.keyPanSpeed,0),b=!0;break}b&&(m.preventDefault(),n.update())}function K(){if(S.length===1)d.set(S[0].pageX,S[0].pageY);else{const m=.5*(S[0].pageX+S[1].pageX),b=.5*(S[0].pageY+S[1].pageY);d.set(m,b)}}function re(){if(S.length===1)L.set(S[0].pageX,S[0].pageY);else{const m=.5*(S[0].pageX+S[1].pageX),b=.5*(S[0].pageY+S[1].pageY);L.set(m,b)}}function Be(){const m=S[0].pageX-S[1].pageX,b=S[0].pageY-S[1].pageY,O=Math.sqrt(m*m+b*b);M.set(0,O)}function He(){n.enableZoom&&Be(),n.enablePan&&re()}function Ve(){n.enableZoom&&Be(),n.enableRotate&&K()}function Ye(m){if(S.length==1)p.set(m.pageX,m.pageY);else{const O=Re(m),H=.5*(m.pageX+O.x),Y=.5*(m.pageY+O.y);p.set(H,Y)}h.subVectors(p,d).multiplyScalar(n.rotateSpeed);const b=n.domElement;y(2*Math.PI*h.x/b.clientHeight),E(2*Math.PI*h.y/b.clientHeight),d.copy(p)}function We(m){if(S.length===1)x.set(m.pageX,m.pageY);else{const b=Re(m),O=.5*(m.pageX+b.x),H=.5*(m.pageY+b.y);x.set(O,H)}g.subVectors(x,L).multiplyScalar(n.panSpeed),w(g.x,g.y),L.copy(x)}function Qe(m){const b=Re(m),O=m.pageX-b.x,H=m.pageY-b.y,Y=Math.sqrt(O*O+H*H);A.set(0,Y),T.set(0,Math.pow(A.y/M.y,n.zoomSpeed)),B(T.y),M.copy(A)}function rt(m){n.enableZoom&&Qe(m),n.enablePan&&We(m)}function lt(m){n.enableZoom&&Qe(m),n.enableRotate&&Ye(m)}function Ke(m){n.enabled!==!1&&(S.length===0&&(n.domElement.setPointerCapture(m.pointerId),n.domElement.addEventListener("pointermove",Ne),n.domElement.addEventListener("pointerup",Pe)),pt(m),m.pointerType==="touch"?_e(m):ct(m))}function Ne(m){n.enabled!==!1&&(m.pointerType==="touch"?dt(m):ut(m))}function Pe(m){n.enabled!==!1&&(m.pointerType==="touch"?le():ft(),Te(m),S.length===0&&(n.domElement.releasePointerCapture(m.pointerId),n.domElement.removeEventListener("pointermove",Ne),n.domElement.removeEventListener("pointerup",Pe)))}function Ze(m){Te(m)}function ct(m){let b;switch(m.button){case 0:b=n.mouseButtons.LEFT;break;case 1:b=n.mouseButtons.MIDDLE;break;case 2:b=n.mouseButtons.RIGHT;break;default:b=-1}switch(b){case Me.DOLLY:if(n.enableZoom===!1)return;k(m),s=i.DOLLY;break;case Me.ROTATE:if(m.ctrlKey||m.metaKey||m.shiftKey){if(n.enablePan===!1)return;X(m),s=i.PAN}else{if(n.enableRotate===!1)return;Q(m),s=i.ROTATE}break;case Me.PAN:if(m.ctrlKey||m.metaKey||m.shiftKey){if(n.enableRotate===!1)return;Q(m),s=i.ROTATE}else{if(n.enablePan===!1)return;X(m),s=i.PAN}break;default:s=i.NONE}s!==i.NONE&&n.dispatchEvent(yt)}function ut(m){if(n.enabled!==!1)switch(s){case i.ROTATE:if(n.enableRotate===!1)return;fe(m);break;case i.DOLLY:if(n.enableZoom===!1)return;j(m);break;case i.PAN:if(n.enablePan===!1)return;me(m);break}}function ft(m){n.dispatchEvent(bt),s=i.NONE}function je(m){n.enabled===!1||n.enableZoom===!1||s!==i.NONE&&s!==i.ROTATE||(m.preventDefault(),n.dispatchEvent(yt),z(m),n.dispatchEvent(bt))}function qe(m){n.enabled===!1||n.enablePan===!1||te(m)}function _e(m){switch(Se(m),S.length){case 1:switch(n.touches.ONE){case Fe.ROTATE:if(n.enableRotate===!1)return;K(),s=i.TOUCH_ROTATE;break;case Fe.PAN:if(n.enablePan===!1)return;re(),s=i.TOUCH_PAN;break;default:s=i.NONE}break;case 2:switch(n.touches.TWO){case Fe.DOLLY_PAN:if(n.enableZoom===!1&&n.enablePan===!1)return;He(),s=i.TOUCH_DOLLY_PAN;break;case Fe.DOLLY_ROTATE:if(n.enableZoom===!1&&n.enableRotate===!1)return;Ve(),s=i.TOUCH_DOLLY_ROTATE;break;default:s=i.NONE}break;default:s=i.NONE}s!==i.NONE&&n.dispatchEvent(yt)}function dt(m){switch(Se(m),s){case i.TOUCH_ROTATE:if(n.enableRotate===!1)return;Ye(m),n.update();break;case i.TOUCH_PAN:if(n.enablePan===!1)return;We(m),n.update();break;case i.TOUCH_DOLLY_PAN:if(n.enableZoom===!1&&n.enablePan===!1)return;rt(m),n.update();break;case i.TOUCH_DOLLY_ROTATE:if(n.enableZoom===!1&&n.enableRotate===!1)return;lt(m),n.update();break;default:s=i.NONE}}function le(m){n.dispatchEvent(bt),s=i.NONE}function ne(m){n.enabled!==!1&&m.preventDefault()}function pt(m){S.push(m)}function Te(m){delete F[m.pointerId];for(let b=0;b<S.length;b++)if(S[b].pointerId==m.pointerId){S.splice(b,1);return}}function Se(m){let b=F[m.pointerId];b===void 0&&(b=new V,F[m.pointerId]=b),b.set(m.pageX,m.pageY)}function Re(m){const b=m.pointerId===S[0].pointerId?S[1]:S[0];return F[b.pointerId]}n.domElement.addEventListener("contextmenu",ne),n.domElement.addEventListener("pointerdown",Ke),n.domElement.addEventListener("pointercancel",Ze),n.domElement.addEventListener("wheel",je,{passive:!1}),this.update()}}class Pa extends Cn{constructor(e){super(e);this.type=Ee}parse(e){const t=-1,n=1,i=2,s=3,o=4,r=function(A,T){switch(A){case n:console.error("THREE.RGBELoader Read Error: "+(T||""));break;case i:console.error("THREE.RGBELoader Write Error: "+(T||""));break;case s:console.error("THREE.RGBELoader Bad File Format: "+(T||""));break;default:case o:console.error("THREE.RGBELoader: Error: "+(T||""))}return t},l=1,c=2,u=4,f=`
`,d=function(A,T,S){const F=128;T=T||1024;let I=A.pos,P=-1,y=0,E="",_=String.fromCharCode.apply(null,new Uint16Array(A.subarray(I,I+F)));for(;0>(P=_.indexOf(f))&&y<T&&I<A.byteLength;)E+=_,y+=_.length,I+=F,_+=String.fromCharCode.apply(null,new Uint16Array(A.subarray(I,I+F)));return-1<P?(S!==!1&&(A.pos+=y+P+1),E+_.slice(0,P)):!1},p=function(A){const T=/^#\?(\S+)/,S=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,F=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,I=/^\s*FORMAT=(\S+)\s*$/,P=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,y={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};let E,_;if(A.pos>=A.byteLength||!(E=d(A)))return r(n,"no header found");if(!(_=E.match(T)))return r(s,"bad initial token");for(y.valid|=l,y.programtype=_[1],y.string+=E+`
`;E=d(A),E!==!1;){if(y.string+=E+`
`,E.charAt(0)==="#"){y.comments+=E+`
`;continue}if((_=E.match(S))&&(y.gamma=parseFloat(_[1],10)),(_=E.match(F))&&(y.exposure=parseFloat(_[1],10)),(_=E.match(I))&&(y.valid|=c,y.format=_[1]),(_=E.match(P))&&(y.valid|=u,y.height=parseInt(_[1],10),y.width=parseInt(_[2],10)),y.valid&c&&y.valid&u)break}return y.valid&c?y.valid&u?y:r(s,"missing image size specifier"):r(s,"missing format specifier")},h=function(A,T,S){const F=T;if(F<8||F>32767||A[0]!==2||A[1]!==2||A[2]&128)return new Uint8Array(A);if(F!==(A[2]<<8|A[3]))return r(s,"wrong scanline width");const I=new Uint8Array(4*T*S);if(!I.length)return r(o,"unable to allocate buffer space");let P=0,y=0;const E=4*F,_=new Uint8Array(4),N=new Uint8Array(E);let w=S;for(;w>0&&y<A.byteLength;){if(y+4>A.byteLength)return r(n);if(_[0]=A[y++],_[1]=A[y++],_[2]=A[y++],_[3]=A[y++],_[0]!=2||_[1]!=2||(_[2]<<8|_[3])!=F)return r(s,"bad rgbe scanline format");let B=0,G;for(;B<E&&y<A.byteLength;){G=A[y++];const k=G>128;if(k&&(G-=128),G===0||B+G>E)return r(s,"bad scanline data");if(k){const X=A[y++];for(let fe=0;fe<G;fe++)N[B++]=X}else N.set(A.subarray(y,y+G),B),B+=G,y+=G}const Q=F;for(let k=0;k<Q;k++){let X=0;I[P]=N[k+X],X+=F,I[P+1]=N[k+X],X+=F,I[P+2]=N[k+X],X+=F,I[P+3]=N[k+X],P+=4}w--}return I},L=function(A,T,S,F){const I=A[T+3],P=Math.pow(2,I-128)/255;S[F+0]=A[T+0]*P,S[F+1]=A[T+1]*P,S[F+2]=A[T+2]*P},x=function(A,T,S,F){const I=A[T+3],P=Math.pow(2,I-128)/255;S[F+0]=At.toHalfFloat(A[T+0]*P),S[F+1]=At.toHalfFloat(A[T+1]*P),S[F+2]=At.toHalfFloat(A[T+2]*P)},g=new Uint8Array(e);g.pos=0;const M=p(g);if(t!==M){const A=M.width,T=M.height,S=h(g.subarray(g.pos),A,T);if(t!==S){let F,I,P,y;switch(this.type){case et:F=S,I=kn,P=et;break;case Ee:y=S.length/4*3;const E=new Float32Array(y);for(let N=0;N<y;N++)L(S,N*4,E,N*3);F=E,I=Lt,P=Ee;break;case xt:y=S.length/4*3;const _=new Uint16Array(y);for(let N=0;N<y;N++)x(S,N*4,_,N*3);F=_,I=Lt,P=xt;break;default:console.error("THREE.RGBELoader: unsupported type: ",this.type);break}return{width:A,height:T,data:F,header:M.string,gamma:M.gamma,exposure:M.exposure,format:I,type:P}}}return null}setDataType(e){return this.type=e,this}load(e,t,n,i){function s(o,r){switch(o.type){case et:o.encoding=Kt,o.minFilter=vt,o.magFilter=vt,o.generateMipmaps=!1,o.flipY=!0;break;case Ee:o.encoding=gt,o.minFilter=ye,o.magFilter=ye,o.generateMipmaps=!1,o.flipY=!0;break;case xt:o.encoding=gt,o.minFilter=ye,o.magFilter=ye,o.generateMipmaps=!1,o.flipY=!0;break}t&&t(o,r)}return super.load(e,s,n,i)}}function It(a,e){const t={};for(const n of e)t[n]=a.getExtension(n);return t}function Ra(a,e,t){const n=a.createShader(e);if(a.shaderSource(n,t),a.compileShader(n),a.getShaderParameter(n,a.COMPILE_STATUS))return n;const s=t.split(`
`).map((o,r)=>`${r+1}: ${o}`).join(`
`);throw console.log(s),a.getShaderInfoLog(n)}function Ea(a,e,t,n,i){const s=a.createProgram();if(a.attachShader(s,e),a.attachShader(s,t),n&&a.transformFeedbackVaryings(s,n,i),a.linkProgram(s),a.detachShader(s,e),a.detachShader(s,t),a.getProgramParameter(s,a.LINK_STATUS))return s;throw a.getProgramInfoLog(s)}function Ga(a,e){const t={},n=a.getProgramParameter(e,a.ACTIVE_UNIFORMS);for(let i=0;i<n;i++){const{name:s,type:o}=a.getActiveUniform(e,i),r=a.getUniformLocation(e,s);r&&(t[s]={type:o,location:r})}return t}function wa(a,e){const t={},n=a.getProgramParameter(e,a.ACTIVE_ATTRIBUTES);for(let i=0;i<n;i++){const{name:s}=a.getActiveAttrib(e,i);s&&(t[s]=a.getAttribLocation(e,s))}return t}const an=["EXT_color_buffer_float","EXT_float_blend"],Ua=["OES_texture_float_linear"];function De(a,{color:e,depth:t}){const n=a.createFramebuffer();function i(){a.bindFramebuffer(a.FRAMEBUFFER,n)}function s(){a.bindFramebuffer(a.FRAMEBUFFER,null)}function o(){i();const r=[];for(let l in e){l=Number(l),l===void 0&&console.error("invalid location");const c=e[l];a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0+l,c.target,c.texture,0),r.push(a.COLOR_ATTACHMENT0+l)}a.drawBuffers(r),t&&a.framebufferRenderbuffer(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,t.target,t.texture),s()}return o(),{color:e,bind:i,unbind:s}}var Xa={source:"layout(location=0)in vec2 a_position;out vec2 vCoord;void main(){vCoord=a_position;gl_Position=vec4(2.*a_position-1.,0,1);}"};let Nt;function Da(a){return{[a.FLOAT]:se(1,"f"),[a.FLOAT_VEC2]:se(2,"f"),[a.FLOAT_VEC3]:se(3,"f"),[a.FLOAT_VEC4]:se(4,"f"),[a.INT]:se(1,"i"),[a.INT_VEC2]:se(2,"i"),[a.INT_VEC3]:se(3,"i"),[a.INT_VEC4]:se(4,"i"),[a.SAMPLER_2D]:se(1,"i"),[a.SAMPLER_2D_ARRAY]:se(1,"i"),[a.FLOAT_MAT2]:Pt(2,2),[a.FLOAT_MAT3]:Pt(3,3),[a.FLOAT_MAT4]:Pt(4,4)}}function se(a,e){return{values:`uniform${a}${e}`,array:`uniform${a}${e}v`}}function Pt(a,e){return{matrix:a===e?`uniformMatrix${a}fv`:`uniformMatrix${a}x${e}fv`}}function Ca(a,e){const t=Ga(a,e),n={},i=[];for(let l in t){const{type:c,location:u}=t[l],f={type:c,location:u,v0:0,v1:0,v2:0,v3:0};n[l]=f}const s=new Set;function o(l,c,u,f,d){const p=n[l];if(!p){s.has(l)||s.add(l);return}p.v0=c,p.v1=u,p.v2=f,p.v3=d,i.push(p)}Nt=Nt||Da(a);function r(){for(;i.length>0;){const{type:l,location:c,v0:u,v1:f,v2:d,v3:p}=i.pop(),h=Nt[l];if(u.length)if(h.matrix){const L=u,x=f||!1;a[h.matrix](c,x,L)}else a[h.array](c,u);else a[h.values](c,u,f,d,p)}}return{setUniform:o,upload:r}}function ka(a){let e="";for(const t in a){const n=a[t];n&&(e+=`#define ${t} ${n}
`)}return e}function sn(a){let e={};for(let t=0;t<a.length;t++)e[a[t]]=t;return e}function Oa(a){let e="";const t=sn(a);for(let n in t)e+=`layout(location = ${t[n]}) out vec4 out_${n};
`;return e}function za(a,e){let t="";for(let n of a)typeof n=="function"?t+=n(e):t+=n;return t}function on(a,e,t,n){let i=`#version 300 es
precision mediump float;
precision mediump int;
`;return n&&(i+=ka(n)),e===a.FRAGMENT_SHADER&&t.outputs&&(i+=Oa(t.outputs)),t.includes&&(i+=za(t.includes,n)),typeof t.source=="function"?i+=t.source(n):i+=t.source,Ra(a,e,i)}function rn(a,{defines:e,vertex:t}){return on(a,a.VERTEX_SHADER,t,e)}function Ba(a,{defines:e,fragment:t}){return on(a,a.FRAGMENT_SHADER,t,e)}function Ha(a,e){const t=Ca(a,e),n={};let i=1;function s(l,c){if(!!c)if(n[l])n[l].tex=c;else{const u=i++;t.setUniform(l,u),n[l]={unit:u,tex:c}}}function o(){for(let l in n){const{tex:c,unit:u}=n[l];a.activeTexture(a.TEXTURE0+u),a.bindTexture(c.target,c.texture)}}function r(l=!0){a.useProgram(e),t.upload(),l&&o()}return{attribLocs:wa(a,e),bindTextures:o,program:e,setTexture:s,setUniform:t.setUniform,textures:n,useProgram:r}}function Ae(a,e){const{fragment:t,vertex:n}=e,i=n instanceof WebGLShader?n:rn(a,e),s=t instanceof WebGLShader?t:Ba(a,e),o=Ea(a,i,s);return Yt(ht({},Ha(a,o)),{outputLocs:t.outputs?sn(t.outputs):{}})}function Va(a){const e=a.createVertexArray();a.bindVertexArray(e),a.bindBuffer(a.ARRAY_BUFFER,a.createBuffer()),a.bufferData(a.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),a.STATIC_DRAW);const t=0;a.enableVertexAttribArray(t),a.vertexAttribPointer(t,2,a.FLOAT,!1,0,0),a.bindVertexArray(null);const n=rn(a,{vertex:Xa});function i(){a.bindVertexArray(e),a.drawArrays(a.TRIANGLES,0,6)}return{draw:i,vertexShader:n}}function be(a,e,t){return Math.min(Math.max(a,e),t)}function Ya(a){for(let e=a.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1)),n=a[e];a[e]=a[t],a[t]=n}return a}function Wa(a,e,t=1e-4){for(let n=0;n<a.length;n++)if(Math.abs(a[n]-e[n])>t)return!1;return!0}function Z(a,e){let{width:t=null,height:n=null,data:i=null,length:s=1,channels:o=null,storage:r=null,flipY:l=!1,gammaCorrection:c=!1,wrapS:u=a.CLAMP_TO_EDGE,wrapT:f=a.CLAMP_TO_EDGE,minFilter:d=a.NEAREST,magFilter:p=a.NEAREST}=e;t=t||i.width||0,n=n||i.height||0;const h=a.createTexture();let L,x;Array.isArray(i)&&(x=i,i=x[0]),L=x||s>1?a.TEXTURE_2D_ARRAY:a.TEXTURE_2D,a.activeTexture(a.TEXTURE0),a.bindTexture(L,h),a.texParameteri(L,a.TEXTURE_WRAP_S,u),a.texParameteri(L,a.TEXTURE_WRAP_T,f),a.texParameteri(L,a.TEXTURE_MIN_FILTER,d),a.texParameteri(L,a.TEXTURE_MAG_FILTER,p),o||(i&&i.length?o=i.length/(t*n):o=4),o=be(o,1,4);const{type:g,format:M,internalFormat:A}=Za(a,o,r,i,c);if(x){a.texStorage3D(L,1,A,t,n,x.length);for(let T=0;T<x.length;T++){const S=x[T].width||t,F=x[T].height||n;a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,Array.isArray(l)?l[T]:l),a.texSubImage3D(L,0,0,0,T,S,F,1,M,g,x[T])}}else s>1?a.texStorage3D(L,1,A,t,n,s):(a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,l),a.texStorage2D(L,1,A,t,n),i&&a.texSubImage2D(L,0,0,0,t,n,M,g,i));return a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!1),{target:L,texture:h}}function Qa(a,e,t){const n=a.createRenderbuffer(),i=a.RENDERBUFFER;return a.bindRenderbuffer(i,n),a.renderbufferStorage(a.RENDERBUFFER,a.DEPTH_COMPONENT24,e,t),a.bindRenderbuffer(i,null),{target:i,texture:n}}function Ka(a,e){return{1:a.RED,2:a.RG,3:a.RGB,4:a.RGBA}[e]}function Za(a,e,t,n,i){let s,o;const r=n instanceof Uint8Array||n instanceof HTMLImageElement||n instanceof HTMLCanvasElement||n instanceof ImageData||n instanceof ImageBitmap,l=n instanceof Float32Array;return t==="byte"||!t&&r?(o={1:a.R8,2:a.RG8,3:i?a.SRGB8:a.RGB8,4:i?a.SRGB8_ALPHA8:a.RGBA8}[e],s=a.UNSIGNED_BYTE):t==="float"||!t&&l?(o={1:a.R32F,2:a.RG32F,3:a.RGB32F,4:a.RGBA32F}[e],s=a.FLOAT):t==="halfFloat"?(o={1:a.R16F,2:a.RG16F,3:a.RGB16F,4:a.RGBA16F}[e],s=a.FLOAT):t==="snorm"&&(o={1:a.R8_SNORM,2:a.RG8_SNORM,3:a.RGB8_SNORM,4:a.RGBA8_SNORM}[e],s=a.UNSIGNED_BYTE),{format:Ka(a,e),internalFormat:o,type:s}}const ja=0,qa=1,Ja=2,$a=3,ei=4;class ti extends _t{constructor(){super();this.materialType=null,this.isRayTracingMaterial=!0}copy(e){super.copy(e),this.materialType=e.materialType,this.isRayTracingMaterial=e.isRayTracingMaterial}}class ln extends ti{constructor(e){super();this.materialType="Disney",this.workflow="Metalness",this.color=new C(16777215),this.roughness=.5,this.metalness=0,this.map=null,this.emissive=new C(0),this.emissiveMap=null,this.normalMap=null,this.normalScale=new V(1,1),this.roughnessMap=null,this.metalnessMap=null,this.specularTint=0,this.sheen=0,this.sheenTint=.5,this.clearcoat=0,this.clearcoatRoughness=0,this.subsurface=0,this.transmission=0,this.ior=1.5,this.atDistance=1,this.anisotropic=0,this.extinction=new C(16777215),this.specularColor=new C(16777215),this.glossiness=1,this.specularMap=null,this.glossinessMap=null,this.setValues(e)}copy(e){return this.color=new C().copy(e.color),this.roughness=e.roughness,this.metalness=e.metalness,this.map=e.map,this.emissive=new C().copy(e.emissive),this.emissiveMap=e.emissiveMap,this.normalMap=e.normalMap,this.normalScale=new V().copy(e.normalScale),this.roughnessMap=e.roughnessMap,this.metalnessMap=e.metalnessMap,this.specularTint=e.specularTint,this.sheen=e.sheen,this.sheenTint=e.sheenTint,this.clearcoat=e.clearcoat,this.clearcoatRoughness=e.clearcoatRoughness,this.subsurface=e.subsurface,this.transmission=e.transmission,this.ior=e.ior,this.atDistance=e.atDistance,this.anisotropic=e.anisotropic,this.extinction=new C().copy(e.extinction),this}clone(){return new this.constructor().copy(this)}fromBasicMaterial(e){const t=new this.constructor;return t.name=e.name,e.color&&t.color.copy(e.color),e.map&&(t.map=e.map),t}fromStandardMaterial(e){const t=new this.constructor;return t.name=e.name,t.color.copy(e.color),t.roughness=e.roughness,t.metalness=e.metalness,t.transmission=e.transmission||0,t.ior=e.ior||1.5,t.clearcoat=e.clearcoat||0,t.clearcoatRoughness=e.clearcoatRoughness||0,t.sheen=e.sheen||0,t.sheenTint=e.sheenTint||.5,t.map=e.map,t.emissive.copy(e.emissive),t.emissiveMap=e.emissiveMap,t.normalMap=e.normalMap,t.normalScale.copy(e.normalScale),t.roughnessMap=e.roughnessMap,t.metalnessMap=e.metalnessMap,e.isGLTFSpecularGlossinessMaterial&&(t.workflow="Specular",t.specularColor.copy(e.specular),t.glossiness=e.glossiness,t.specularMap=e.specularMap,t.glossinessMap=e.glossinessMap),t}}function ni(...a){let e=0;for(let n=0;n<a.length;n++){const i=a[n],s=i.data?i.data.length/i.channels:0;e=Math.max(e,s)}const t=[];for(let n=0;n<e;n++)for(let i=0;i<a.length;i++){const{data:s=[],channels:o}=a[i];for(let r=0;r<o;r++)t.push(s[n*o+r])}return t}function ai(a){const e={};return e.position=a.map(t=>t.position),e.emission=a.map(t=>t.emission),e.p1=a.map(t=>t.p1),e.p2=a.map(t=>t.p2),e.radius=a.map(t=>t.radius),e.area=a.map(t=>t.area),e.type=a.map(t=>t.type),e.visible=a.map(t=>t.visible),e.position=[].concat(...e.position.map(t=>t.toArray())),e.emission=[].concat(...e.emission.map(t=>t.toArray())),e.p1=[].concat(...e.p1.map(t=>t.toArray())),e.p2=[].concat(...e.p2.map(t=>t.toArray())),e.params=ni({data:e.radius,channels:1},{data:e.area,channels:1},{data:e.type,channels:1},{data:e.visible,channels:1}),e}function ii(a){const e=a.map(t=>{const n={};switch(n.position=t.position,n.emission=t.color.multiplyScalar(t.intensity),n.radius=t.radius||0,n.area=0,n.visible=Number(t.visible),n.p1=new D,n.p2=new D,t.type){case"RectAreaLight":if(n.type=ja,t.width&&t.height){const i=new On(t.width,t.height),s=new D;t.target&&s.copy(t.target);const o=new D().subVectors(t.position,s),r=new D().copy(o).negate();i.lookAt(r);const l=i.attributes.position.array,c=new D(l[0],l[1],l[2]).add(t.position);new D(l[3],l[4],l[5]).add(t.position);const u=new D(l[6],l[7],l[8]).add(t.position),f=new D(l[9],l[10],l[11]).add(t.position);n.position.copy(u),n.p1=f.sub(u),n.p2=c.sub(u),n.area=new D().crossVectors(n.p1,n.p2).length()}break;case"QuadLight":n.type=qa,n.p1=t.v1.sub(t.position),n.p2=t.v2.sub(t.position),n.area=new D().crossVectors(n.p1,n.p2).length();break;case"SphereAreaLight":n.type=Ja,n.area=4*Math.PI*t.radius*t.radius;break;case"PointLight":n.type=ei,n.area=0;break;case"DirectionalLight":n.type=$a,t.target&&n.p1.copy(t.target),n.area=0;break;default:console.warn(`Not support light type: ${t.type}`);break}return n});return ai(e)}function Rt(a,e){const t=[],n=[];a.traverse(l=>{l.isMesh&&(l.geometry?l.material?(l.material.isMeshStandardMaterial?l.material=new ln().fromStandardMaterial(l.material):l.material.isRayTracingMaterial||(l.material=new ln().fromBasicMaterial(l.material)),t.push(l)):console.warn(l,"must have a material property."):console.warn(l,"must have a geometry property")),l.isLight&&n.push(l)});const i={data:a.environment,intensity:a.envMapIntensity||1},s=i.data&&i.data.isTexture,o=n.length||0;let r=null;return o&&(r=ii(n)),{environment:i,isTextureEnv:s,camera:e,meshes:t,meshLights:r,meshLightsNum:o}}function si(a,e,t){const n=new ie(new Float32Array(3*e),3,!1),i=new ie(new Float32Array(3*e),3,!1),s=new ie(new Float32Array(2*e),2,!1),o=new ie(new Int32Array(2*e),2,!1),r=new ie(new Uint32Array(t),1,!1),l=new Ge;typeof l.setAttribute!="function"&&(l.setAttribute=l.addAttribute),l.setAttribute("position",n),l.setAttribute("normal",i),l.setAttribute("uv",s),l.setAttribute("materialMeshIndex",o),l.setIndex(r);let c=0,u=0,f=1;for(const{geometry:d,materialIndex:p}of a){const h=d.getAttribute("position").count;l.merge(d,c);const L=d.getIndex();for(let x=0;x<L.count;x++)r.setX(u+x,c+L.getX(x));for(let x=0;x<h;x++)o.setXY(c+x,p,f);c+=h,u+=L.count,f++}return l}function oi(a,e){const t=new Ge;for(const i of e){const s=a.getAttribute(i);s&&(typeof t.setAttribute!="function"&&(t.setAttribute=t.addAttribute),t.setAttribute(i,s.clone()))}const n=a.getIndex();return n&&t.setIndex(n),t}function ri(a){const e=a.getAttribute("position");if(!e){console.warn("No position attribute");return}const t=new Uint32Array(e.count);for(let n=0;n<t.length;n++)t[n]=n;return a.setIndex(new ie(t,1,!1)),a}function li(a){let e=0,t=0;const n=[],i=new Map;for(const o of a){if(!o.visible)continue;const r=o.geometry.isBufferGeometry?oi(o.geometry,["position","normal","uv"]):new Ge().fromGeometry(o.geometry);r.getIndex()||ri(r),r.applyMatrix4?r.applyMatrix4(o.matrixWorld):r.applyMatrix(o.matrixWorld),r.getAttribute("normal")?r.normalizeNormals():r.computeVertexNormals(),e+=r.getAttribute("position").count,t+=r.getIndex().count;const c=o.material;let u=i.get(c);u===void 0&&(u=i.size,i.set(c,u)),n.push({geometry:r,materialIndex:u})}return{geometry:si(n,e,t),materials:Array.from(i.keys())}}const ci=0;var ui=`uniform Materials {\r
	vec4 colorAndMaterialType[NUM_MATERIALS];\r
	vec4 roughnessMetalnessNormalScale[NUM_MATERIALS];\r
	vec4 specularTintSheenSheenTint[NUM_MATERIALS];\r
	vec4 clearcoaRoughnessSubfaceTransmission[NUM_MATERIALS];\r
	vec4 iorAtDistanceAnisotropicWorkflow[NUM_MATERIALS];\r
	vec4 extinction[NUM_MATERIALS];\r
	vec4 specularColorGlossiness[NUM_MATERIALS];\r
\r
	#if defined(NUM_DIFFUSE_MAPS) || defined(NUM_NORMAL_MAPS) || defined(NUM_PBR_MAPS)\r
		ivec4 diffuseNormalRoughnessMetalnessMapIndex[NUM_MATERIALS];\r
	#endif\r
\r
	#if defined(NUM_EMISSIVE_MAPS) || defined(NUM_PBR_SG_MAPS)\r
		ivec4 emissiveSpecularGlossinessMapIndex[NUM_MATERIALS];\r
	#endif\r
\r
	#if defined(NUM_DIFFUSE_MAPS) || defined(NUM_NORMAL_MAPS)\r
		vec4 diffuseNormalMapSize[NUM_DIFFUSE_NORMAL_MAPS];\r
	#endif\r
\r
	#if defined(NUM_PBR_MAPS)\r
		vec2 pbrMapSize[NUM_PBR_MAPS];\r
	#else\r
		#if defined(NUM_PBR_SG_MAPS)\r
			vec2 pbrMapSize[NUM_PBR_SG_MAPS];\r
		#else\r
			#if defined(NUM_EMISSIVE_MAPS)\r
				vec2 pbrMapSize[NUM_EMISSIVE_MAPS];\r
			#endif\r
		#endif\r
	#endif\r
} materials;\r
\r
#ifdef NUM_DIFFUSE_MAPS\r
	uniform mediump sampler2DArray diffuseMap;\r
#endif\r
\r
#ifdef NUM_NORMAL_MAPS\r
	uniform mediump sampler2DArray normalMap;\r
#endif\r
\r
#ifdef NUM_PBR_MAPS\r
	uniform mediump sampler2DArray pbrMap;\r
#endif\r
\r
#ifdef NUM_PBR_SG_MAPS\r
	uniform mediump sampler2DArray pbrSGMap;\r
#endif\r
\r
#ifdef NUM_EMISSIVE_MAPS\r
	uniform mediump sampler2DArray emissiveMap;\r
#endif\r
\r
float getMatType(int materialIndex) {\r
	return materials.colorAndMaterialType[materialIndex].w;\r
}\r
\r
float getMatWorkflow(int materialIndex) {\r
	return materials.iorAtDistanceAnisotropicWorkflow[materialIndex].w;\r
}\r
\r
vec3 getMatEmissive(int materialIndex, vec2 uv) {\r
	// Todo: emissive Intensity\r
	vec3 emissive = vec3(0.0);\r
\r
	#ifdef NUM_EMISSIVE_MAPS\r
		int emissiveMapIndex = materials.emissiveSpecularGlossinessMapIndex[materialIndex].x;\r
		if (emissiveMapIndex >= 0) {\r
			emissive = texture(emissiveMap, vec3(uv * materials.pbrMapSize[emissiveMapIndex].xy, emissiveMapIndex)).rgb;\r
		}\r
	#endif\r
	\r
	return emissive;\r
}\r
\r
vec3 getMatSpecularColor(int materialIndex, vec2 uv) {\r
	vec3 specularColor = materials.specularColorGlossiness[materialIndex].rgb;\r
\r
	#ifdef NUM_PBR_SG_MAPS\r
		int specularMapIndex = materials.emissiveSpecularGlossinessMapIndex[materialIndex].y;\r
		if (specularMapIndex >= 0) {\r
			vec3 texelSpecular = texture(pbrSGMap, vec3(uv * materials.pbrMapSize[specularMapIndex].xy, specularMapIndex)).rgb;\r
			texelSpecular = pow(texelSpecular, vec3(2.2));\r
			specularColor *= texelSpecular;\r
		}\r
	#endif\r
\r
	return specularColor;\r
}\r
\r
float getMatGlossiness(int materialIndex, vec2 uv) {\r
	float glossiness = materials.specularColorGlossiness[materialIndex].a;\r
	#ifdef NUM_PBR_SG_MAPS\r
		int glossinessMapIndex = materials.emissiveSpecularGlossinessMapIndex[materialIndex].z;\r
		if (glossinessMapIndex >= 0) {\r
			float texelGlossiness = texture(pbrSGMap, vec3(uv * materials.pbrMapSize[glossinessMapIndex].xy, glossinessMapIndex)).a;\r
			glossiness *= texelGlossiness;\r
		}\r
	#endif\r
	return glossiness;\r
}\r
\r
float getMatRoughness(int materialIndex, vec2 uv) {\r
	float workflow = getMatWorkflow(materialIndex);\r
	float roughness = 0.0;\r
	if (workflow > 0.1) {\r
		roughness = 1.0 - getMatGlossiness(materialIndex, uv);\r
	} else {\r
		roughness = materials.roughnessMetalnessNormalScale[materialIndex].x;\r
\r
		#ifdef NUM_PBR_MAPS\r
			int roughnessMapIndex = materials.diffuseNormalRoughnessMetalnessMapIndex[materialIndex].z;\r
			if (roughnessMapIndex >= 0) {\r
				roughness *= texture(pbrMap, vec3(uv * materials.pbrMapSize[roughnessMapIndex].xy, roughnessMapIndex)).g;\r
			}\r
		#endif\r
	}\r
	// Remap\r
	return roughness * roughness;\r
}\r
\r
float max3(const vec3 v) {\r
	return max(v.x, max(v.y, v.z));\r
}\r
\r
float computeMetallicFromSpecularColor(const vec3 specularColor) {\r
	return max3(specularColor);\r
}\r
\r
vec3 computeDiffuseColor(const vec3 baseColor, float metallic) {\r
	return baseColor * (1.0 - metallic);\r
}\r
\r
float getMatMetalness(int materialIndex, vec2 uv) {\r
	float workflow = getMatWorkflow(materialIndex);\r
	float metalness = 0.0;\r
	if (workflow > 0.1) {\r
		vec3 specularFactor = getMatSpecularColor(materialIndex, uv);\r
		metalness = computeMetallicFromSpecularColor(specularFactor);\r
	} else {\r
		metalness = materials.roughnessMetalnessNormalScale[materialIndex].y;\r
\r
		#ifdef NUM_PBR_MAPS\r
			int metalnessMapIndex = materials.diffuseNormalRoughnessMetalnessMapIndex[materialIndex].w;\r
			if (metalnessMapIndex >= 0) {\r
				metalness *= texture(pbrMap, vec3(uv * materials.pbrMapSize[metalnessMapIndex].xy, metalnessMapIndex)).b;\r
			}\r
		#endif\r
	}\r
\r
	return metalness;\r
}\r
\r
vec3 getMatColor(int materialIndex, vec2 uv) {\r
	// if (enableAlbedo && bounce == 0) return vec3(1.);\r
	vec3 color = materials.colorAndMaterialType[materialIndex].rgb;\r
	#ifdef NUM_DIFFUSE_MAPS\r
		int diffuseMapIndex = materials.diffuseNormalRoughnessMetalnessMapIndex[materialIndex].x;\r
		if (diffuseMapIndex >= 0) {\r
			color *= texture(diffuseMap, vec3(uv * materials.diffuseNormalMapSize[diffuseMapIndex].xy, diffuseMapIndex)).rgb;\r
		}\r
	#endif\r
\r
	float workflow = getMatWorkflow(materialIndex);\r
	if (workflow > 0.1) {\r
		vec3 specularFactor = getMatSpecularColor(materialIndex, uv);\r
		color = computeDiffuseColor(color, computeMetallicFromSpecularColor(specularFactor));\r
	}\r
\r
	return color;\r
}\r
\r
vec3 getMatNormal(int materialIndex, vec2 uv, vec3 normal, vec3 dp1, vec3 dp2, vec2 duv1, vec2 duv2, inout vec3 tangent, inout vec3 bitangent) {\r
	// http://www.thetenthplanet.de/archives/1180\r
	// Compute co-tangent and co-bitangent vectors\r
	vec3 dp2perp = cross(dp2, normal);\r
	vec3 dp1perp = cross(normal, dp1);\r
	vec3 dpdu = dp2perp * duv1.x + dp1perp * duv2.x;\r
	vec3 dpdv = dp2perp * duv1.y + dp1perp * duv2.y;\r
	float invmax = inversesqrt(max(dot(dpdu, dpdu), dot(dpdv, dpdv)));\r
	dpdu *= invmax;\r
	dpdv *= invmax;\r
\r
	// All world space\r
	// Todo: /3ed-2018/Materials/BSDFs => WorldToLocal/LocalToWorld\r
	tangent = normalize(dpdu);\r
	bitangent = normalize(dpdv);\r
\r
#ifdef NUM_NORMAL_MAPS\r
	int normalMapIndex = materials.diffuseNormalRoughnessMetalnessMapIndex[materialIndex].y;\r
	if (normalMapIndex >= 0) {\r
		vec3 n = 2.0 * texture(normalMap, vec3(uv * materials.diffuseNormalMapSize[normalMapIndex].zw, normalMapIndex)).rgb - 1.0;\r
		n.xy *= materials.roughnessMetalnessNormalScale[materialIndex].zw;\r
\r
		mat3 tbn = mat3(dpdu, dpdv, normal);\r
\r
		return normalize(tbn * n);\r
	} else {\r
		return normal;\r
	}\r
#endif\r
\r
	return normal;\r
}\r
\r
// specularTintSheenSheenTint\r
float getMatSpecularTint(int materialIndex) {\r
	return materials.specularTintSheenSheenTint[materialIndex].y;\r
}\r
\r
float getMatSheen(int materialIndex) {\r
	return materials.specularTintSheenSheenTint[materialIndex].z;\r
}\r
\r
float getMatSheenTint(int materialIndex) {\r
	return materials.specularTintSheenSheenTint[materialIndex].w;\r
}\r
\r
// clearcoaRoughnessSubfaceTransmission\r
float getMatClearcoat(int materialIndex) {\r
	return materials.clearcoaRoughnessSubfaceTransmission[materialIndex].x;\r
}\r
\r
float getMatClearcoatRoughness(int materialIndex) {\r
	return materials.clearcoaRoughnessSubfaceTransmission[materialIndex].y;\r
}\r
\r
float getMatSubface(int materialIndex) {\r
	return materials.clearcoaRoughnessSubfaceTransmission[materialIndex].z;\r
}\r
\r
float getMatTransmission(int materialIndex) {\r
	return materials.clearcoaRoughnessSubfaceTransmission[materialIndex].w;\r
}\r
\r
// iorAtDistanceAnisotropicWorkflow\r
float getMatIOR(int materialIndex) {\r
	return materials.iorAtDistanceAnisotropicWorkflow[materialIndex].x;\r
}\r
\r
float getMatAtDistance(int materialIndex) {\r
	return materials.iorAtDistanceAnisotropicWorkflow[materialIndex].y;\r
}\r
\r
float getMatAnisotropic(int materialIndex) {\r
	return materials.iorAtDistanceAnisotropicWorkflow[materialIndex].z;\r
}\r
\r
vec3 getMatExtinction(int materialIndex) {\r
	return materials.extinction[materialIndex].rgb;\r
}`;function fi(a,e,t){const n=a.getActiveUniformBlockParameter(e,t,a.UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES),i=a.getActiveUniforms(e,n,a.UNIFORM_OFFSET),s=a.getActiveUniforms(e,n,a.UNIFORM_ARRAY_STRIDE),o={};for(let r=0;r<n.length;r++){const{name:l,type:c,size:u}=a.getActiveUniform(e,n[r]);o[l]={type:c,size:u,offset:i[r],stride:s[r]}}return o}function ce(a,e,t,n,i,s,o){const r=Math.min(o.length/s,t);for(let l=0;l<r;l++)for(let c=0;c<s;c++)a[e](n+l*i+c*4,o[s*l+c],!0)}function di(a,e,t){const n=a.getUniformBlockIndex(e,t),i=a.getActiveUniformBlockParameter(e,n,a.UNIFORM_BLOCK_DATA_SIZE),s=fi(a,e,n),o=a.createBuffer();a.bindBuffer(a.UNIFORM_BUFFER,o),a.bufferData(a.UNIFORM_BUFFER,i,a.STATIC_DRAW);const r=new DataView(new ArrayBuffer(i));function l(u,f){if(!s[u])return;const{type:d,size:p,offset:h,stride:L}=s[u];switch(d){case a.FLOAT:ce(r,"setFloat32",p,h,L,1,f);break;case a.FLOAT_VEC2:ce(r,"setFloat32",p,h,L,2,f);break;case a.FLOAT_VEC3:ce(r,"setFloat32",p,h,L,3,f);break;case a.FLOAT_VEC4:ce(r,"setFloat32",p,h,L,4,f);break;case a.INT:ce(r,"setInt32",p,h,L,1,f);break;case a.INT_VEC2:ce(r,"setInt32",p,h,L,2,f);break;case a.INT_VEC3:ce(r,"setInt32",p,h,L,3,f);break;case a.INT_VEC4:ce(r,"setInt32",p,h,L,4,f);break;case a.BOOL:ce(r,"setUint32",p,h,L,1,f);break;default:console.warn("UniformBuffer: Unsupported type")}}function c(u){a.bindBuffer(a.UNIFORM_BUFFER,o),a.bufferSubData(a.UNIFORM_BUFFER,0,r),a.bindBufferBase(a.UNIFORM_BUFFER,u,o)}return{set:l,bind:c}}function pi(a,e){const t={};for(const n of e){const i=[];t[n]={indices:un(a,n,i),textures:i}}return t}function cn(a,e){const t={textures:[],indices:{}};for(const n of e)t.indices[n]=un(a,n,t.textures);return t}function un(a,e,t){const n=[];for(const i of a)if(!(i[e]&&i[e].image))n.push(-1);else{let o=t.length;for(let r=0;r<t.length;r++)if(t[r]===i[e]){o=r;break}o===t.length&&t.push(i[e]),n.push(o)}return n}function mi(a){const e={width:0,height:0};for(const n of a)e.width=Math.max(e.width,n.width),e.height=Math.max(e.height,n.height);const t=[];for(const n of a)t.push(n.width/e.width),t.push(n.height/e.height);return{maxSize:e,relativeSizes:t}}function J(...a){let e=0;for(let n=0;n<a.length;n++){const i=a[n],s=i.data?i.data.length/i.channels:0;e=Math.max(e,s)}const t=[];for(let n=0;n<e;n++)for(let i=0;i<a.length;i++){const{data:s=[],channels:o}=a[i];for(let r=0;r<o;r++)t.push(s[n*o+r])}return t}function hi(a,e,t){const n=di(a,e,"Materials");n.set("Materials.colorAndMaterialType[0]",J({data:[].concat(...t.color.map(i=>i.toArray())),channels:3},{data:t.type,channels:1})),n.set("Materials.roughnessMetalnessNormalScale[0]",J({data:t.roughness,channels:1},{data:t.metalness,channels:1},{data:[].concat(...t.normalScale.map(i=>i.toArray())),channels:2})),n.set("Materials.specularTintSheenSheenTint[0]",J({data:t.ior,channels:1},{data:t.specularTint,channels:1},{data:t.sheen,channels:1},{data:t.sheenTint,channels:1})),n.set("Materials.clearcoaRoughnessSubfaceTransmission[0]",J({data:t.clearcoat,channels:1},{data:t.clearcoatRoughness,channels:1},{data:t.subsurface,channels:1},{data:t.transmission,channels:1})),n.set("Materials.iorAtDistanceAnisotropicWorkflow[0]",J({data:t.ior,channels:1},{data:t.atDistance,channels:1},{data:t.anisotropic,channels:1},{data:t.workflow,channels:1})),n.set("Materials.specularColorGlossiness[0]",J({data:[].concat(...t.specularColor.map(i=>i.toArray())),channels:3},{data:t.glossiness,channels:1})),n.set("Materials.extinction[0]",J({data:[].concat(...t.extinction.map(i=>i.toArray())),channels:3},{data:t.anisotropic,channels:1})),n.set("Materials.diffuseNormalRoughnessMetalnessMapIndex[0]",J({data:t.diffuseMapIndex,channels:1},{data:t.normalMapIndex,channels:1},{data:t.roughnessMapIndex,channels:1},{data:t.metalnessMapIndex,channels:1})),n.set("Materials.emissiveSpecularGlossinessMapIndex[0]",J({data:t.emissiveMapIndex,channels:1}),J({data:t.specularMapIndex,channels:1}),J({data:t.glossinessMapIndex,channels:1})),n.set("Materials.diffuseNormalMapSize[0]",J({data:t.diffuseMapSize,channels:2},{data:t.normalMapSize,channels:2})),n.set("Materials.pbrMapSize[0]",t.pbrMapSize),n.bind(0)}function Ce(a,e,t=!1,n=3){const i=e.map(c=>c.image),s=e.map(c=>c.flipY),{maxSize:o,relativeSizes:r}=mi(i);return{texture:Z(a,{width:o.width,height:o.height,gammaCorrection:t,data:i,flipY:s,channels:n,minFilter:a.LINEAR,magFilter:a.LINEAR}),relativeSizes:r}}function xi(a,e){const t=pi(e,["map","normalMap","emissiveMap"]),n=cn(e,["roughnessMap","metalnessMap"]),i=cn(e,["specularMap","glossinessMap"]),s={},o={};if(o.color=e.map(c=>c.color),o.roughness=e.map(c=>c.roughness),o.metalness=e.map(c=>c.metalness),o.normalScale=e.map(c=>c.normalScale),o.specularTint=e.map(c=>c.specularTint),o.sheen=e.map(c=>c.sheen),o.sheenTint=e.map(c=>c.sheenTint),o.clearcoat=e.map(c=>c.clearcoat),o.clearcoatRoughness=e.map(c=>c.clearcoatRoughness),o.transmission=e.map(c=>c.transmission),o.subsurface=e.map(c=>c.subsurface),o.ior=e.map(c=>c.ior),o.atDistance=e.map(c=>c.atDistance),o.extinction=e.map(c=>c.extinction),o.workflow=e.map(c=>c.workflow==="Metalness"?0:1),o.specularColor=e.map(c=>c.specularColor),o.glossiness=e.map(c=>c.glossiness),o.type=e.map(c=>ci),t.map.textures.length>0){const{relativeSizes:c,texture:u}=Ce(a,t.map.textures,!0);s.diffuseMap=u,o.diffuseMapSize=c,o.diffuseMapIndex=t.map.indices}if(t.normalMap.textures.length>0){const{relativeSizes:c,texture:u}=Ce(a,t.normalMap.textures,!1);s.normalMap=u,o.normalMapSize=c,o.normalMapIndex=t.normalMap.indices}if(n.textures.length>0){const{relativeSizes:c,texture:u}=Ce(a,n.textures,!1);s.pbrMap=u,o.pbrMapSize=c,o.roughnessMapIndex=n.indices.roughnessMap,o.metalnessMapIndex=n.indices.metalnessMap}if(i.textures.length>0){const{relativeSizes:c,texture:u}=Ce(a,i.textures,!1,4);s.pbrSGMap=u,o.pbrMapSize=c,o.specularMapIndex=i.indices.specularMap,o.glossinessMapIndex=i.indices.glossinessMap}if(t.emissiveMap.textures.length>0){const{relativeSizes:c,texture:u}=Ce(a,t.emissiveMap.textures,!0);s.emissiveMap=u,o.pbrMapSize||(o.pbrMapSize=c),o.emissiveMapIndex=t.emissiveMap.indices}const r={NUM_MATERIALS:e.length,NUM_DIFFUSE_MAPS:t.map.textures.length,NUM_NORMAL_MAPS:t.normalMap.textures.length,NUM_DIFFUSE_NORMAL_MAPS:Math.max(t.map.textures.length,t.normalMap.textures.length),NUM_PBR_MAPS:n.textures.length,NUM_PBR_SG_MAPS:i.textures.length,NUM_EMISSIVE_MAPS:t.emissiveMap.textures.length},l=Ae(a,{vertex:{source:"void main() {}"},fragment:{includes:[ui],source:"void main() {}"},defines:r});return hi(a,l.program,o),{defines:r,textures:s}}class oe{constructor(e=0,t=0,n=0){this.x=e,this.y=t,this.z=n}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}divideScalar(e){return this.multiplyScalar(1/e)}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}normalize(){return this.divideScalar(this.length()||1)}crossVectors(e,t){const n=e.x,i=e.y,s=e.z,o=t.x,r=t.y,l=t.z;return this.x=i*l-s*r,this.y=s*o-n*l,this.z=n*r-i*o,this}fromBufferAttribute(e,t,n){return n!==void 0&&console.warn("THREE.Vector3: offset has been removed from .fromBufferAttribute()."),this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this}}class ge{constructor(e=new oe(1/0,1/0,1/0),t=new oe(-1/0,-1/0,-1/0)){this.min=e,this.max=t}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(e){return this.isEmpty()?e.set(0,0,0):e.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(e){return this.isEmpty()?e.set(0,0,0):e.subVectors(this.max,this.min)}expandByPoint(e){return this.min.min(e),this.max.max(e),this}union(e){return this.min.min(e.min),this.max.max(e.max),this}}function Li(a,e,t=0,n=a.length){for(;t!==n;){for(;e(a[t]);)if(t++,t===n)return t;do if(n--,t===n)return t;while(!e(a[n]));fn(a,t,n),t++}return t}function Ai(a,e,t=0,n=a.length,i=Math.floor((t+n)/2)){for(let s=t;s<=i;s++){let o=s,r=a[s];for(let l=s+1;l<n;l++)e(r,a[l])||(o=l,r=a[l],fn(a,s,o))}}function fn(a,e,t){const n=a[t];a[t]=a[e],a[e]=n}const W=new oe;function gi(a){const e=[],t=[],n={x:0,y:1,z:2};let i=1;const s=(c,u=1)=>{if(i=Math.max(u,i),c.primitives)for(let f=0;f<c.primitives.length;f++){const d=c.primitives[f];e.push(d.indices[0],d.indices[1],d.indices[2],c.primitives.length,d.faceNormal.x,d.faceNormal.y,d.faceNormal.z,d.materialIndex),t.push(!1)}else{const f=c.bounds;e.push(f.min.x,f.min.y,f.min.z,n[c.splitAxis],f.max.x,f.max.y,f.max.z,null);const d=e.length-1;t.push(!0),s(c.child0,u+1),e[d]=e.length/4,s(c.child1,u+1)}};s(a);const o=new ArrayBuffer(4*e.length),r=new Float32Array(o),l=new Int32Array(o);for(let c=0;c<t.length;c++){let u=8*c;t[c]?(r[u]=e[u],r[u+1]=e[u+1],r[u+2]=e[u+2],l[u+3]=e[u+3]):(l[u]=e[u],l[u+1]=e[u+1],l[u+2]=e[u+2],l[u+3]=-e[u+3]),r[u+4]=e[u+4],r[u+5]=e[u+5],r[u+6]=e[u+6],l[u+7]=e[u+7]}return{maxDepth:i,count:e.length/4,buffer:r}}function vi(a){const e=[],t=a.getIndex?a.getIndex().array:a.index.array,n=a.getAttribute?a.getAttribute("position"):a.attributes.position,i=a.getAttribute?a.getAttribute("materialMeshIndex"):a.attributes.materialMeshIndex,s=new oe,o=new oe,r=new oe,l=new oe,c=new oe;for(let u=0;u<t.length;u+=3){const f=t[u],d=t[u+1],p=t[u+2],h=new ge;n.getX?(s.fromBufferAttribute(n,f),o.fromBufferAttribute(n,d),r.fromBufferAttribute(n,p)):(s.x=n.array[f*n.itemSize],s.y=n.array[f*n.itemSize+1],s.z=n.array[f*n.itemSize+2],o.x=n.array[d*n.itemSize],o.y=n.array[d*n.itemSize+1],o.z=n.array[d*n.itemSize+2],r.x=n.array[p*n.itemSize],r.y=n.array[p*n.itemSize+1],r.z=n.array[p*n.itemSize+2]),h.expandByPoint(s),h.expandByPoint(o),h.expandByPoint(r),l.subVectors(r,s),c.subVectors(o,s);const L=new oe().crossVectors(c,l).normalize(),x={bounds:h,center:h.getCenter(new oe),indices:[f,d,p],faceNormal:L,materialIndex:i.getX?i.getX(f):i.array[f*i.itemSize]};e.push(x)}return e}function dn(a,e){return{primitives:a,bounds:e}}function _i(a,e,t){return{child0:e,child1:t,bounds:new ge().union(e.bounds).union(t.bounds),splitAxis:a}}function Ti(a){return a.getSize(W),W.x>W.z?W.x>W.y?"x":"y":W.z>W.y?"z":"y"}function pn(a,e,t){let n=t[e]-a.min[e];return a.max[e]>a.min[e]&&(n/=a.max[e]-a.min[e]),n}function Et(a){return a.getSize(W),2*(W.x*W.z+W.x*W.y+W.z*W.y)}function Gt(a,e,t){const n=new ge;for(let s=e;s<t;s++)n.union(a[s].bounds);const i=t-e;if(i===1)return dn(a.slice(e,t),n);{const s=new ge;for(let l=e;l<t;l++)s.expandByPoint(a[l].center);const o=Ti(s);let r=Math.floor((e+t)/2);if(i<=4)Ai(a,(l,c)=>l.center[o]<c.center[o],e,t,r);else{if(s.max[o]===s.min[o])return dn(a.slice(e,t),n);{const l=12,c=[];for(let p=0;p<l;p++)c.push({bounds:new ge,count:0});for(let p=e;p<t;p++){let h=Math.floor(l*pn(s,o,a[p].center));h===c.length&&(h=c.length-1),c[h].count++,c[h].bounds.union(a[p].bounds)}const u=[];for(let p=0;p<c.length-1;p++){const h=new ge,L=new ge;let x=0,g=0;for(let M=0;M<=p;M++)h.union(c[M].bounds),x+=c[M].count;for(let M=p+1;M<c.length;M++)L.union(c[M].bounds),g+=c[M].count;u.push(.1+(x*Et(h)+g*Et(L))/Et(n))}let f=u[0],d=0;for(let p=1;p<u.length;p++)u[p]<f&&(f=u[p],d=p);r=Li(a,p=>{let h=Math.floor(c.length*pn(s,o,p.center));return h===c.length&&(h=c.length-1),h<=d},e,t)}}return _i(o,Gt(a,e,r),Gt(a,r,t))}}function Si(a){const e=vi(a);return Gt(e,0,e.length)}function Mi(a,e=1){const t=a.length/4,n=new Float32Array(t*3),i=[];for(let s=0;s<255;s++)i[s]=e*Math.pow(2,s-128)/255;for(let s=0;s<t;s++){const o=a[4*s],r=a[4*s+1],l=a[4*s+2],c=a[4*s+3],u=i[c];n[3*s]=o*u,n[3*s+1]=r*u,n[3*s+2]=l*u}return n}function Fi(a){const e=document.createElement("canvas"),t=e.getContext("2d");return e.width=a.width,e.height=a.height,t.drawImage(a,0,0),t.getImageData(0,0,e.width,e.height).data}function yi(a){let e;return e={width:a.data.image.width,height:a.data.image.height,data:a.data.image.data,dataFormat:"float"},a.data.type===et?e.data?e.data=Mi(e.data,a.intensity):(e.data=Fi(a.data.image),e.dataFormat="byte"):a.data.type!==Ee&&console.error(`No support environmentLight's data type: ${a.data.type}, Please use rgbe format map`),e}function bi(a){return a.data&&a.data.image&&(a.data.encoding===Kt||a.data.encoding===gt)}function Ii(a){let e;return a&&a.data&&a.data.isTexture&&(bi(a)?e=yi(a):console.warn(`No support environment type: ${a.data}`)),e}function Ni(a,e,t){const n=new Float32Array(t*a*e);return{set(i,s,o,r){n[t*(s*a+i)+o]=r},get(i,s,o){return n[t*(s*a+i)+o]},width:a,height:e,channels:t,array:n}}function Pi(a){const e=a.data,t={width:a.width+2,height:a.height+1},n=Ni(t.width,t.height,2);for(let s=0;s<a.height;s++){const o=Math.sin(Math.PI*(s+.5)/a.height);for(let l=0;l<a.width;l++){const c=3*(s*a.width+l);let u=e[c],f=e[c+1],d=e[c+2],p=.2126*u+.7152*f+.0722*d;p*=o,n.set(l+2,s,0,n.get(l+1,s,0)+p/a.width),n.set(l+1,s,1,p)}const r=n.get(t.width-1,s,0);for(let l=1;l<n.width;l++)n.set(l,s,0,n.get(l,s,0)/r),n.set(l,s,1,n.get(l,s,1)/r);n.set(0,s+1,0,n.get(0,s,0)+r/a.height),n.set(0,s,1,r)}const i=n.get(0,n.height-1,0);for(let s=0;s<n.height;s++)n.set(0,s,0,n.get(0,s,0)/i),n.set(0,s,1,n.get(0,s,1)/i);return t.data=n.array,t}var Ri={source:a=>`
#define PI 3.14159265359
#define TWOPI 6.28318530718
#define INVPI 0.31830988618
#define INVPI2 0.10132118364
#define EPS 0.0001
#define ONE_MINUS_EPS 0.999999
#define INF 1000000.0
#define ROUGHNESS_MIN 0.001
#define DISNEY 0
const vec3 luminance=vec3(0.2126,0.7152,0.0722);float LGL_AP(vec3 color){return dot(color,luminance);}
#define RAY_MAX_DISTANCE 9999.0
struct Ray{vec3 o;vec3 d;vec3 invD;float tMax;};struct Path{Ray ray;vec3 li;float alpha;vec3 beta;bool specularBounce;bool abort;float misWeight;vec3 absorption;};struct Camera{mat4 transform;float aspect;float fov;float focus;float aperture;};
#if defined(NUM_LIGHTS)
struct Lights{vec3 position[NUM_LIGHTS];vec3 emission[NUM_LIGHTS];vec3 p1[NUM_LIGHTS];vec3 p2[NUM_LIGHTS];vec4 params[NUM_LIGHTS];};struct Light{vec3 position;vec3 emission;vec3 p1;vec3 p2;float radius;float area;float type;float visible;};
#endif
struct SurfaceInteraction{bool hit;bool isEmitter;float t;vec3 position;vec3 normal;vec3 faceNormal;vec3 ffnormal;vec3 tangent;vec3 bitangent;vec3 color;vec3 extinction;vec3 emissive;int materialType;float roughness;float metalness;float anisotropic;float subsurface;float specularTint;float sheen;float sheenTint;float clearcoat;float clearcoatRoughness;float specTrans;float ior;float atDistance;float eta;vec3 specularColor;float workflow;};struct BsdfSampleRec{vec3 L;vec3 f;float pdf;};struct LightSampleRec{vec3 normal;vec3 emission;vec3 direction;float dist;float pdf;};void LGL_AQ(inout Ray ray,vec3 origin,vec3 direction){ray.o=origin;ray.d=direction;ray.invD=1.0/ray.d;ray.tMax=RAY_MAX_DISTANCE;}void LGL_AQ(inout Ray ray,vec3 origin,vec3 direction,float rMax){ray.o=origin;ray.d=direction;ray.invD=1.0/ray.d;ray.tMax=rMax;}ivec2 LGL_AR(int i,int columnsLog2){ivec2 u;u.y=i>>columnsLog2;u.x=i-(u.y<<columnsLog2);return u;}vec4 LGL_AS(sampler2D s,int i,int columnsLog2){return texelFetch(s,LGL_AR(i,columnsLog2),0);}ivec4 LGL_AS(isampler2D s,int i,int columnsLog2){return texelFetch(s,LGL_AR(i,columnsLog2),0);}uniform Camera camera;uniform vec2 pixelSize;uniform vec2 jitter;uniform float frameCount;in vec2 vCoord;
#if defined(NUM_LIGHTS)
uniform Lights lights;
#endif
uniform int bounces;uniform vec3 backgroundColor;uniform float envMapIntensity;uniform sampler2D noiseTex;uniform float stratifiedSamples[71];uniform float strataSize;float pixelSeed;float LGL_AH(vec2 p){return fract(sin(dot(p,vec2(12.9898,78.233)))*43758.5453);}uvec4 seed;ivec2 pixel;void LGL_AI(float frame){pixel=ivec2(vCoord/pixelSize);seed=uvec4(pixel,int(frame),pixel.x+pixel.y);}void LGL_AJ(inout uvec4 v){v=v*1664525u+1013904223u;v.x+=v.y*v.w;v.y+=v.z*v.x;v.z+=v.x*v.y;v.w+=v.y*v.z;v=v ^(v>>16u);v.x+=v.y*v.w;v.y+=v.z*v.x;v.z+=v.x*v.y;v.w+=v.y*v.z;}float LGL_AK(){LGL_AJ(seed);return float(seed.x)/float(0xffffffffu);}vec2 LGL_AK2(){LGL_AJ(seed);return vec2(seed.xy)/float(0xffffffffu);}void LGL_AM(float frame){vec2 noiseSize=vec2(textureSize(noiseTex,0));pixelSeed=texture(noiseTex,vCoord/(pixelSize*noiseSize)).r;}int sampleIndex=0;float LGL_AKomSample(){float stratifiedSample=stratifiedSamples[sampleIndex++];float LGL_AKom=fract((stratifiedSample+pixelSeed)*strataSize);return EPS+(1.0-2.0*EPS)*LGL_AKom;}vec2 LGL_AKomSampleVec2(){return vec2(LGL_AKomSample(),LGL_AKomSample());}struct MaterialSamples{vec2 s1;vec2 s2;vec2 s3;vec2 s4;};MaterialSamples getRandomMaterialSamples(){MaterialSamples samples;samples.s1=LGL_AKomSampleVec2();samples.s2=LGL_AKomSampleVec2();samples.s3=LGL_AKomSampleVec2();samples.s4=LGL_AKomSampleVec2();return samples;}vec4 LGL_Ag(sampler2D map,vec2 uv){
#ifdef OES_texture_float_linear
return texture(map,uv);
#else
vec2 size=vec2(textureSize(map,0));vec2 texelSize=1.0/size;uv=uv*size-0.5;vec2 f=fract(uv);uv=floor(uv)+0.5;vec4 s1=texture(map,(uv+vec2(0,0))*texelSize);vec4 s2=texture(map,(uv+vec2(1,0))*texelSize);vec4 s3=texture(map,(uv+vec2(0,1))*texelSize);vec4 s4=texture(map,(uv+vec2(1,1))*texelSize);return mix(mix(s1,s2,f.x),mix(s3,s4,f.x),f.y);
#endif
}uniform Materials{vec4 colorAndMaterialType[NUM_MATERIALS];vec4 roughnessMetalnessNormalScale[NUM_MATERIALS];vec4 specularTintSheenSheenTint[NUM_MATERIALS];vec4 clearcoaRoughnessSubfaceTransmission[NUM_MATERIALS];vec4 iorAtDistanceAnisotropicWorkflow[NUM_MATERIALS];vec4 extinction[NUM_MATERIALS];vec4 specularColorGlossiness[NUM_MATERIALS];
#if defined(NUM_DIFFUSE_MAPS) || defined(NUM_NORMAL_MAPS) || defined(NUM_PBR_MAPS)
ivec4 diffuseNormalRoughnessMetalnessMapIndex[NUM_MATERIALS];
#endif
#if defined(NUM_EMISSIVE_MAPS) || defined(NUM_PBR_SG_MAPS)
ivec4 emissiveSpecularGlossinessMapIndex[NUM_MATERIALS];
#endif
#if defined(NUM_DIFFUSE_MAPS) || defined(NUM_NORMAL_MAPS)
vec4 diffuseNormalMapSize[NUM_DIFFUSE_NORMAL_MAPS];
#endif
#if defined(NUM_PBR_MAPS)
vec2 pbrMapSize[NUM_PBR_MAPS];
#else
#if defined(NUM_PBR_SG_MAPS)
vec2 pbrMapSize[NUM_PBR_SG_MAPS];
#else
#if defined(NUM_EMISSIVE_MAPS)
vec2 pbrMapSize[NUM_EMISSIVE_MAPS];
#endif
#endif
#endif
}materials;
#ifdef NUM_DIFFUSE_MAPS
uniform mediump sampler2DArray diffuseMap;
#endif
#ifdef NUM_NORMAL_MAPS
uniform mediump sampler2DArray normalMap;
#endif
#ifdef NUM_PBR_MAPS
uniform mediump sampler2DArray pbrMap;
#endif
#ifdef NUM_PBR_SG_MAPS
uniform mediump sampler2DArray pbrSGMap;
#endif
#ifdef NUM_EMISSIVE_MAPS
uniform mediump sampler2DArray emissiveMap;
#endif
float LGL_k(int materialIndex){return materials.colorAndMaterialType[materialIndex].w;}float LGL_l(int materialIndex){return materials.iorAtDistanceAnisotropicWorkflow[materialIndex].w;}vec3 LGL_m(int materialIndex,vec2 uv){vec3 emissive=vec3(0.0);
#ifdef NUM_EMISSIVE_MAPS
int emissiveMapIndex=materials.emissiveSpecularGlossinessMapIndex[materialIndex].x;if(emissiveMapIndex>=0){emissive=texture(emissiveMap,vec3(uv*materials.pbrMapSize[emissiveMapIndex].xy,emissiveMapIndex)).rgb;}
#endif
return emissive;}vec3 LGL_n(int materialIndex,vec2 uv){vec3 specularColor=materials.specularColorGlossiness[materialIndex].rgb;
#ifdef NUM_PBR_SG_MAPS
int specularMapIndex=materials.emissiveSpecularGlossinessMapIndex[materialIndex].y;if(specularMapIndex>=0){vec3 texelSpecular=texture(pbrSGMap,vec3(uv*materials.pbrMapSize[specularMapIndex].xy,specularMapIndex)).rgb;texelSpecular=pow(texelSpecular,vec3(2.2));specularColor*=texelSpecular;}
#endif
return specularColor;}float LGL_o(int materialIndex,vec2 uv){float glossiness=materials.specularColorGlossiness[materialIndex].a;
#ifdef NUM_PBR_SG_MAPS
int glossinessMapIndex=materials.emissiveSpecularGlossinessMapIndex[materialIndex].z;if(glossinessMapIndex>=0){float texelGlossiness=texture(pbrSGMap,vec3(uv*materials.pbrMapSize[glossinessMapIndex].xy,glossinessMapIndex)).a;glossiness*=texelGlossiness;}
#endif
return glossiness;}float LGL_p(int materialIndex,vec2 uv){float workflow=LGL_l(materialIndex);float roughness=0.0;if(workflow>0.1){roughness=1.0-LGL_o(materialIndex,uv);}else{roughness=materials.roughnessMetalnessNormalScale[materialIndex].x;
#ifdef NUM_PBR_MAPS
int roughnessMapIndex=materials.diffuseNormalRoughnessMetalnessMapIndex[materialIndex].z;if(roughnessMapIndex>=0){roughness*=texture(pbrMap,vec3(uv*materials.pbrMapSize[roughnessMapIndex].xy,roughnessMapIndex)).g;}
#endif
}return roughness*roughness;}float LGL_q(const vec3 v){return max(v.x,max(v.y,v.z));}float LGL_r(const vec3 specularColor){return LGL_q(specularColor);}vec3 LGL_s(const vec3 baseColor,float metallic){return baseColor*(1.0-metallic);}float LGL_t(int materialIndex,vec2 uv){float workflow=LGL_l(materialIndex);float metalness=0.0;if(workflow>0.1){vec3 specularFactor=LGL_n(materialIndex,uv);metalness=LGL_r(specularFactor);}else{metalness=materials.roughnessMetalnessNormalScale[materialIndex].y;
#ifdef NUM_PBR_MAPS
int metalnessMapIndex=materials.diffuseNormalRoughnessMetalnessMapIndex[materialIndex].w;if(metalnessMapIndex>=0){metalness*=texture(pbrMap,vec3(uv*materials.pbrMapSize[metalnessMapIndex].xy,metalnessMapIndex)).b;}
#endif
}return metalness;}vec3 LGL_u(int materialIndex,vec2 uv){vec3 color=materials.colorAndMaterialType[materialIndex].rgb;
#ifdef NUM_DIFFUSE_MAPS
int diffuseMapIndex=materials.diffuseNormalRoughnessMetalnessMapIndex[materialIndex].x;if(diffuseMapIndex>=0){color*=texture(diffuseMap,vec3(uv*materials.diffuseNormalMapSize[diffuseMapIndex].xy,diffuseMapIndex)).rgb;}
#endif
float workflow=LGL_l(materialIndex);if(workflow>0.1){vec3 specularFactor=LGL_n(materialIndex,uv);color=LGL_s(color,LGL_r(specularFactor));}return color;}vec3 LGL_v(int materialIndex,vec2 uv,vec3 normal,vec3 dp1,vec3 dp2,vec2 duv1,vec2 duv2,inout vec3 tangent,inout vec3 bitangent){vec3 dp2perp=cross(dp2,normal);vec3 dp1perp=cross(normal,dp1);vec3 dpdu=dp2perp*duv1.x+dp1perp*duv2.x;vec3 dpdv=dp2perp*duv1.y+dp1perp*duv2.y;float invmax=inversesqrt(max(dot(dpdu,dpdu),dot(dpdv,dpdv)));dpdu*=invmax;dpdv*=invmax;tangent=normalize(dpdu);bitangent=normalize(dpdv);
#ifdef NUM_NORMAL_MAPS
int normalMapIndex=materials.diffuseNormalRoughnessMetalnessMapIndex[materialIndex].y;if(normalMapIndex>=0){vec3 n=2.0*texture(normalMap,vec3(uv*materials.diffuseNormalMapSize[normalMapIndex].zw,normalMapIndex)).rgb-1.0;n.xy*=materials.roughnessMetalnessNormalScale[materialIndex].zw;mat3 tbn=mat3(dpdu,dpdv,normal);return normalize(tbn*n);}else{return normal;}
#endif
return normal;}float LGL_w(int materialIndex){return materials.specularTintSheenSheenTint[materialIndex].y;}float LGL_x(int materialIndex){return materials.specularTintSheenSheenTint[materialIndex].z;}float LGL_xTint(int materialIndex){return materials.specularTintSheenSheenTint[materialIndex].w;}float LGL_z(int materialIndex){return materials.clearcoaRoughnessSubfaceTransmission[materialIndex].x;}float LGL_zRoughness(int materialIndex){return materials.clearcoaRoughnessSubfaceTransmission[materialIndex].y;}float LGL_AB(int materialIndex){return materials.clearcoaRoughnessSubfaceTransmission[materialIndex].z;}float LGL_AC(int materialIndex){return materials.clearcoaRoughnessSubfaceTransmission[materialIndex].w;}float LGL_AD(int materialIndex){return materials.iorAtDistanceAnisotropicWorkflow[materialIndex].x;}float LGL_AE(int materialIndex){return materials.iorAtDistanceAnisotropicWorkflow[materialIndex].y;}float LGL_AF(int materialIndex){return materials.iorAtDistanceAnisotropicWorkflow[materialIndex].z;}vec3 LGL_AG(int materialIndex){return materials.extinction[materialIndex].rgb;}uniform sampler2D positionBuffer;uniform sampler2D normalBuffer;uniform sampler2D uvBuffer;uniform sampler2D bvhBuffer;struct Triangle{vec3 p0;vec3 p1;vec3 p2;};struct Box{vec3 min;vec3 max;};struct TriangleIntersect{float t;vec3 barycentric;};float LGL_b(float rad,vec3 pos,Ray r){vec3 op=pos-r.o;float eps=0.001;float b=dot(op,r.d);float det=b*b-dot(op,op)+rad*rad;if(det<0.0)return INF;det=sqrt(det);float t1=b-det;if(t1>eps)return t1;float t2=b+det;if(t2>eps)return t2;return INF;}float LGL_c(in vec3 pos,in vec3 u,in vec3 v,in vec4 plane,in Ray r){vec3 n=vec3(plane);float dt=dot(r.d,n);float t=(plane.w-dot(n,r.o))/dt;if(t>EPS){vec3 p=r.o+r.d*t;vec3 vi=p-pos;float a1=dot(u,vi);if(a1>=0.&&a1<=1.){float a2=dot(v,vi);if(a2>=0.&&a2<=1.)return t;}}return INF;}float LGL_d(vec3 v0,vec3 v1,vec3 v2,Ray r,bool isDoubleSided){vec3 edge1=v1-v0;vec3 edge2=v2-v0;vec3 pvec=cross(r.d,edge2);float det=1.0/dot(edge1,pvec);if(!isDoubleSided&&det<0.0)return INF;vec3 tvec=r.o-v0;float u=dot(tvec,pvec)*det;vec3 qvec=cross(tvec,edge1);float v=dot(r.d,qvec)*det;float t=dot(edge2,qvec)*det;return(u<0.0||u>1.0||v<0.0||u+v>1.0||t<=0.0)? INF : t;}float LGL_cClassic(vec3 v1,vec3 v2,vec3 v3,vec3 v4,Ray r,bool isDoubleSided){return min(LGL_d(v1,v3,v2,r,isDoubleSided),LGL_d(v2,v3,v4,r,isDoubleSided));}void LGL_f(inout SurfaceInteraction si,Triangle tri,vec3 barycentric,ivec3 index,vec3 faceNormal,int materialIndex){si.hit=true;si.faceNormal=faceNormal;si.position=barycentric.x*tri.p0+barycentric.y*tri.p1+barycentric.z*tri.p2;ivec2 i0=LGL_AR(index.x,VERTEX_COLUMNS);ivec2 i1=LGL_AR(index.y,VERTEX_COLUMNS);ivec2 i2=LGL_AR(index.z,VERTEX_COLUMNS);vec3 n0=texelFetch(normalBuffer,i0,0).xyz;vec3 n1=texelFetch(normalBuffer,i1,0).xyz;vec3 n2=texelFetch(normalBuffer,i2,0).xyz;vec3 normal=normalize(barycentric.x*n0+barycentric.y*n1+barycentric.z*n2);vec2 uv0=texelFetch(uvBuffer,i0,0).xy;vec2 uv1=texelFetch(uvBuffer,i1,0).xy;vec2 uv2=texelFetch(uvBuffer,i2,0).xy;
#if defined(NUM_DIFFUSE_MAPS) || defined(NUM_NORMAL_MAPS) || defined(NUM_PBR_MAPS)
vec2 uv=fract(barycentric.x*uv0+barycentric.y*uv1+barycentric.z*uv2);
#else
vec2 uv=vec2(0.0);
#endif
si.materialType=int(LGL_k(materialIndex));si.color=LGL_u(materialIndex,uv);si.roughness=LGL_p(materialIndex,uv);si.metalness=LGL_t(materialIndex,uv);si.specularColor=LGL_n(materialIndex,uv);si.workflow=LGL_l(materialIndex);si.emissive=LGL_m(materialIndex,uv);vec3 dp1=tri.p0-tri.p2;vec3 dp2=tri.p1-tri.p2;vec2 duv1=uv0-uv2;vec2 duv2=uv1-uv2;si.normal=LGL_v(materialIndex,uv,normal,dp1,dp2,duv1,duv2,si.tangent,si.bitangent);si.specularTint=LGL_w(materialIndex);si.sheen=LGL_x(materialIndex);si.sheenTint=LGL_xTint(materialIndex);si.clearcoat=LGL_z(materialIndex);si.clearcoatRoughness=LGL_zRoughness(materialIndex);si.subsurface=LGL_AB(materialIndex);si.specTrans=LGL_AC(materialIndex);si.ior=LGL_AD(materialIndex);si.atDistance=LGL_AE(materialIndex);si.anisotropic=LGL_AF(materialIndex);si.extinction=LGL_AG(materialIndex);}TriangleIntersect LGL_g(Ray r,Triangle tri){vec3 v0=tri.p0;vec3 v1=tri.p1;vec3 v2=tri.p2;TriangleIntersect ti;vec3 e0=v1-v0;vec3 e1=v2-v0;vec3 pv=cross(r.d,e1);float det=dot(e0,pv);vec3 tv=r.o-v0;vec3 qv=cross(tv,e0);vec4 uvt;uvt.x=dot(tv,pv);uvt.y=dot(r.d,qv);uvt.z=dot(e1,qv);uvt.xyz=uvt.xyz/det;uvt.w=1.0-uvt.x-uvt.y;if(uvt.z>=r.tMax){return ti;}if(all(greaterThanEqual(uvt,vec4(0.0)))&&uvt.z<INF){ti.t=uvt.z;ti.barycentric=uvt.wxy;}return ti;}float LGL_h(Ray r,Box b){vec3 tBot=(b.min-r.o)*r.invD;vec3 tTop=(b.max-r.o)*r.invD;vec3 tNear=min(tBot,tTop);vec3 tFar=max(tBot,tTop);float t0=max(tNear.x,max(tNear.y,tNear.z));float t1=min(tFar.x,min(tFar.y,tFar.z));return(t0>t1||t0>r.tMax)?-1.0 :(t0>0.0 ? t0 : t1);}bool LGL_i(inout Ray ray,float maxDist){
#if defined(NUM_LIGHTS)
for(int i=0;i<NUM_LIGHTS;i++){vec3 position=lights.position[i];vec3 emission=lights.emission[i];vec3 p1=lights.p1[i];vec3 p2=lights.p2[i];vec4 params=lights.params[i];float radius=params.x;float area=params.y;float type=params.z;float visible=params.w;if(type==0.||type==1.){vec3 normal=normalize(cross(p1,p2));if(dot(normal,ray.d)>0.)continue;vec4 plane=vec4(normal,dot(normal,position));p1*=1.0/dot(p1,p1);p2*=1.0/dot(p2,p2);float d=LGL_c(position,p1,p2,plane,ray);if(d>0.&&d<maxDist)return true;}if(type==1.){float d=LGL_b(radius,position,ray);if(d>0.&&d<maxDist)return true;}}
#endif
int nodesToVisit[STACK_SIZE];nodesToVisit[0]=0;int stack=0;while(stack>=0){int i=nodesToVisit[stack--];vec4 r1=LGL_AS(bvhBuffer,i,BVH_COLUMNS);vec4 r2=LGL_AS(bvhBuffer,i+1,BVH_COLUMNS);int splitAxisOrNumPrimitives=floatBitsToInt(r1.w);if(splitAxisOrNumPrimitives>=0){int splitAxis=splitAxisOrNumPrimitives;Box bbox=Box(r1.xyz,r2.xyz);if(LGL_h(ray,bbox)>0.0){if(ray.d[splitAxis]>0.0){nodesToVisit[++stack]=floatBitsToInt(r2.w);nodesToVisit[++stack]=i+2;}else{nodesToVisit[++stack]=i+2;nodesToVisit[++stack]=floatBitsToInt(r2.w);}}}else{ivec3 index=floatBitsToInt(r1.xyz);Triangle tri=Triangle(LGL_AS(positionBuffer,index.x,VERTEX_COLUMNS).xyz,LGL_AS(positionBuffer,index.y,VERTEX_COLUMNS).xyz,LGL_AS(positionBuffer,index.z,VERTEX_COLUMNS).xyz);TriangleIntersect hit=LGL_g(ray,tri);if(hit.t>0.0&&hit.t<maxDist){return true;}}}return false;}void LGL_j(inout Ray ray,inout SurfaceInteraction si,inout LightSampleRec lightSampleRec,int bounce){si.hit=false;float t=INF;float d;
#if defined(NUM_LIGHTS)
for(int i=0;i<NUM_LIGHTS;i++){vec4 params=lights.params[i];float radius=params.x;float area=params.y;float type=params.z;float visible=params.w;if(bounce==0&&visible<0.1)continue;vec3 position=lights.position[i];vec3 emission=lights.emission[i];vec3 p1=lights.p1[i];vec3 p2=lights.p2[i];if(type==0.||type==1.){vec3 normal=normalize(cross(p1,p2));if(dot(normal,ray.d)>0.)continue;vec4 plane=vec4(normal,dot(normal,position));p1*=1.0/dot(p1,p1);p2*=1.0/dot(p2,p2);d=LGL_c(position,p1,p2,plane,ray);if(d<0.)d=INF;if(d<t){t=d;float cosTheta=dot(-ray.d,normal);float pdf=(t*t)/(area*cosTheta);lightSampleRec.emission=emission;lightSampleRec.pdf=pdf;si.hit=true;si.isEmitter=true;ray.tMax=t;}}if(type==2.){d=LGL_b(radius,position,ray);if(d<0.)d=INF;if(d<t){t=d;float pdf=(t*t)/area;lightSampleRec.emission=emission;lightSampleRec.pdf=pdf;si.hit=true;si.isEmitter=true;ray.tMax=t;}}}
#endif
int nodesToVisit[STACK_SIZE];nodesToVisit[0]=0;int stack=0;while(stack>=0){int i=nodesToVisit[stack--];vec4 r1=LGL_AS(bvhBuffer,i,BVH_COLUMNS);vec4 r2=LGL_AS(bvhBuffer,i+1,BVH_COLUMNS);int splitAxisOrNumPrimitives=floatBitsToInt(r1.w);if(splitAxisOrNumPrimitives>=0){int splitAxis=splitAxisOrNumPrimitives;Box bbox=Box(r1.xyz,r2.xyz);if(LGL_h(ray,bbox)>0.0){if(ray.d[splitAxis]>0.0){nodesToVisit[++stack]=floatBitsToInt(r2.w);nodesToVisit[++stack]=i+2;}else{nodesToVisit[++stack]=i+2;nodesToVisit[++stack]=floatBitsToInt(r2.w);}}}else{ivec3 index=floatBitsToInt(r1.xyz);Triangle tri=Triangle(LGL_AS(positionBuffer,index.x,VERTEX_COLUMNS).xyz,LGL_AS(positionBuffer,index.y,VERTEX_COLUMNS).xyz,LGL_AS(positionBuffer,index.z,VERTEX_COLUMNS).xyz);TriangleIntersect hit=LGL_g(ray,tri);if(hit.t>0.0){int materialIndex=floatBitsToInt(r2.w);vec3 faceNormal=r2.xyz;si.t=hit.t;si.isEmitter=false;ray.tMax=hit.t;LGL_f(si,tri,hit.barycentric,index,faceNormal,materialIndex);si.ffnormal=dot(si.faceNormal,ray.d)<=0.0 ? si.normal :-si.normal;}}}si.roughness=clamp(si.roughness,ROUGHNESS_MIN,1.0);si.metalness=clamp(si.metalness,0.0,1.0);}
#ifndef CONST_COLOR_ENV
uniform sampler2D envMap;uniform sampler2D envMapDistribution;vec2 LGL_U(vec3 pointOnSphere){float phi=mod(atan(-pointOnSphere.z,-pointOnSphere.x),TWOPI);float theta=acos(pointOnSphere.y);return vec2(phi*0.5*INVPI,theta*INVPI);}vec3 LGL_V(vec3 d){vec2 uv=LGL_U(d);return LGL_Ag(envMap,uv).rgb;}float LGL_W(float u,out int vOffset,out float pdf){ivec2 size=textureSize(envMap,0);int left=0;int right=size.y+1;while(left<right){int mid=(left+right)>>1;float s=texelFetch(envMapDistribution,ivec2(0,mid),0).x;if(s<=u){left=mid+1;}else{right=mid;}}vOffset=left-1;vec2 s0=texelFetch(envMapDistribution,ivec2(0,vOffset),0).xy;vec2 s1=texelFetch(envMapDistribution,ivec2(0,vOffset+1),0).xy;pdf=s0.y;return(float(vOffset)+(u-s0.x)/(s1.x-s0.x))/float(size.y);}float LGL_X(float u,int vOffset,out float pdf){ivec2 size=textureSize(envMap,0);int left=0;int right=size.x+1;while(left<right){int mid=(left+right)>>1;float s=texelFetch(envMapDistribution,ivec2(1+mid,vOffset),0).x;if(s<=u){left=mid+1;}else{right=mid;}}int uOffset=left-1;vec2 s0=texelFetch(envMapDistribution,ivec2(1+uOffset,vOffset),0).xy;vec2 s1=texelFetch(envMapDistribution,ivec2(1+uOffset+1,vOffset),0).xy;pdf=s0.y;return(float(uOffset)+(u-s0.x)/(s1.x-s0.x))/float(size.x);}float LGL_Y(vec2 uv){vec2 size=vec2(textureSize(envMap,0));float sinTheta=sin(uv.y*PI);uv*=size;float partialX=texelFetch(envMapDistribution,ivec2(1.0+uv.x,uv.y),0).y;float partialY=texelFetch(envMapDistribution,ivec2(0,uv.y),0).y;return partialX*partialY*INVPI2/(2.0*sinTheta);}vec3 LGL_Z(vec2 LGL_AKom,out vec2 uv,out float pdf){vec2 partialPdf;int vOffset;uv.y=LGL_W(LGL_AKom.x,vOffset,partialPdf.y);uv.x=LGL_X(LGL_AKom.y,vOffset,partialPdf.x);float phi=uv.x*TWOPI;float theta=uv.y*PI;float cosTheta=cos(theta);float sinTheta=sin(theta);float cosPhi=cos(phi);float sinPhi=sin(phi);vec3 dir=vec3(-sinTheta*cosPhi,cosTheta,-sinTheta*sinPhi);pdf=partialPdf.x*partialPdf.y*INVPI2/(2.0*sinTheta);return dir;}
#endif
void LGL_AT(in vec3 N,inout vec3 T,inout vec3 B){if(N.z<-0.999999){T=vec3(0.,-1.,0.);B=vec3(-1.,0.,0.);}else{float a=1.0/(1.+N.z);float b=-N.x*N.y*a;T=vec3(1.0-N.x*N.x*a,b,-N.x);B=vec3(b,1.-N.y*N.y*a,-N.y);}}vec2 LGL_AU(vec2 p){p=2.0*p-1.0;bool greater=abs(p.x)>abs(p.y);float r=greater ? p.x : p.y;float theta=greater ? 0.25*PI*p.y/p.x : PI*(0.5-0.25*p.x/p.y);return r*vec2(cos(theta),sin(theta));}vec3 LGL_AV(vec2 p){vec2 h=LGL_AU(p);float z=sqrt(max(0.0,1.0-h.x*h.x-h.y*h.y));return vec3(h,z);}vec3 LGL_AW(float r1,float r2){float z=1.0-2.0*r1;float r=sqrt(max(0.0,1.0-z*z));float phi=TWOPI*r2;return vec3(r*cos(phi),r*sin(phi),z);}vec3 LGL_AX(vec3 faceNormal,vec3 viewDir,mat3 basis,float roughness,vec2 LGL_AKom){float phi=TWOPI*LGL_AKom.y;float alpha=roughness*roughness;float cosTheta=sqrt((1.0-LGL_AKom.x)/(1.0+(alpha*alpha-1.0)*LGL_AKom.x));float sinTheta=sqrt(1.0-cosTheta*cosTheta);vec3 halfVector=basis*sign(dot(faceNormal,viewDir))*vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);vec3 lightDir=reflect(-viewDir,halfVector);return lightDir;}vec3 LGL_AY(vec3 faceNormal,vec3 viewDir,mat3 basis,vec2 LGL_AKom){return basis*sign(dot(faceNormal,viewDir))*LGL_AV(LGL_AKom);}float LGL_AZ(float f,float g){return(f*f)/(f*f+g*g);}vec3 LGL_Aa(in Ray r,int depth,bool specularBounce,in LightSampleRec lightSampleRec,in BsdfSampleRec bsdfSampleRec){vec3 Le;if(depth==0||specularBounce){Le=lightSampleRec.emission;}else{Le=LGL_AZ(bsdfSampleRec.pdf,lightSampleRec.pdf)*lightSampleRec.emission;}return Le;}
#if defined(NUM_LIGHTS)
void LGL_Ab(in Light light,in vec3 surfacePos,inout LightSampleRec lightSampleRec,vec2 LGL_AKom){float r1=LGL_AKom.x;float r2=LGL_AKom.y;vec3 lightSurfacePos=light.position+LGL_AW(r1,r2)*light.radius;lightSampleRec.direction=lightSurfacePos-surfacePos;lightSampleRec.dist=length(lightSampleRec.direction);float distSq=lightSampleRec.dist*lightSampleRec.dist;lightSampleRec.direction/=lightSampleRec.dist;lightSampleRec.normal=normalize(lightSurfacePos-light.position);lightSampleRec.emission=light.emission*float(NUM_LIGHTS);lightSampleRec.pdf=distSq/(light.area*abs(dot(lightSampleRec.normal,lightSampleRec.direction)));}void LGL_Ad(in Light light,in vec3 surfacePos,inout LightSampleRec lightSampleRec,vec2 LGL_AKom){float r1=LGL_AKom.x;float r2=LGL_AKom.y;vec3 lightSurfacePos=light.position+light.p1*r1+light.p2*r2;lightSampleRec.direction=lightSurfacePos-surfacePos;lightSampleRec.dist=length(lightSampleRec.direction);float distSq=lightSampleRec.dist*lightSampleRec.dist;lightSampleRec.direction/=lightSampleRec.dist;lightSampleRec.normal=normalize(cross(light.p1,light.p2));lightSampleRec.emission=light.emission*float(NUM_LIGHTS);lightSampleRec.pdf=distSq/(light.area*abs(dot(lightSampleRec.normal,lightSampleRec.direction)));}void LGL_Ae(in Light light,in vec3 surfacePos,inout LightSampleRec lightSampleRec){lightSampleRec.direction=normalize(light.position-light.p1);lightSampleRec.normal=normalize(surfacePos-light.position);if(dot(lightSampleRec.direction,lightSampleRec.normal)>0.0){lightSampleRec.normal=-lightSampleRec.normal;}lightSampleRec.emission=light.emission*float(NUM_LIGHTS);lightSampleRec.dist=INF;lightSampleRec.pdf=1.0;}void samplePointLight(in Light light,in vec3 surfacePos,inout LightSampleRec lightSampleRec){lightSampleRec.direction=light.position-surfacePos;lightSampleRec.dist=length(lightSampleRec.direction);float distSq=lightSampleRec.dist*lightSampleRec.dist;lightSampleRec.direction=normalize(lightSampleRec.direction);lightSampleRec.normal=normalize(surfacePos-light.position);lightSampleRec.emission=light.emission*float(NUM_LIGHTS)/distSq;lightSampleRec.pdf=1.0;}void LGL_Af(in Light light,in vec3 surfacePos,inout LightSampleRec lightSampleRec,vec2 LGL_AKom){int type=int(light.type);if(type==0||type==1){LGL_Ad(light,surfacePos,lightSampleRec,LGL_AKom);}else if(type==2){LGL_Ab(light,surfacePos,lightSampleRec,LGL_AKom);}else if(type==3){LGL_Ae(light,surfacePos,lightSampleRec);}else if(type==4){samplePointLight(light,surfacePos,lightSampleRec);}}
#endif
vec3 LGL_A(float r1,float r2){vec3 dir;float r=sqrt(r1);float phi=TWOPI*r2;dir.x=r*cos(phi);dir.y=r*sin(phi);dir.z=sqrt(max(0.0,1.0-dir.x*dir.x-dir.y*dir.y));return dir;}float LGL_B(float eta){float sqrtR0=(eta-1.)/(eta+1.);return sqrtR0*sqrtR0;}vec3 LGL_C(vec3 baseColor){float luminance=LGL_AP(baseColor);return(luminance>0.0)? baseColor/luminance : vec3(1.);}void LGL_D(SurfaceInteraction si,out vec3 Cspec0,out vec3 Csheen){vec3 tint=LGL_C(si.color);if(si.workflow>0.1){Cspec0=si.specularColor;}else{Cspec0=mix(LGL_B(si.ior)*mix(vec3(1.0),tint,min(si.specularTint,0.99)),si.color,si.metalness);}Csheen=mix(vec3(1.0),tint,si.sheenTint);}float LGL_E(float u){float m=clamp(1.0-u,0.0,1.0);float m2=m*m;return m2*m2*m;}float LGL_F(float F0,float cosTheta){return mix(F0,1.0,LGL_E(cosTheta));}vec3 LGL_F(vec3 F0,float cosTheta){return mix(F0,vec3(1.),LGL_E(cosTheta));}float LGL_G(float cosThetaI,float eta){float sinThetaTSq=eta*eta*(1.0f-cosThetaI*cosThetaI);if(sinThetaTSq>1.0)return 1.0;float cosThetaT=sqrt(max(1.0-sinThetaTSq,0.0));float rs=(eta*cosThetaT-cosThetaI)/(eta*cosThetaT+cosThetaI);float rp=(eta*cosThetaI-cosThetaT)/(eta*cosThetaI+cosThetaT);return 0.5*(rs*rs+rp*rp);}vec3 LGL_H(vec3 F0,float metalness,float eta,float cosThetaI){vec3 FrSchlick=LGL_F(F0,cosThetaI);float FrDielectric=LGL_G(cosThetaI,eta);return mix(vec3(FrDielectric),FrSchlick,metalness);}float LGL_H(float metalness,float eta,float cosThetaI){float FrSchlick=LGL_E(cosThetaI);float FrDielectric=LGL_G(cosThetaI,eta);return mix(FrDielectric,FrSchlick,metalness);}float LGL_I(float NDotV,float alphaG){float a=alphaG*alphaG;float b=NDotV*NDotV;return 1.0/(NDotV+sqrt(a+b-a*b));}float LGL_J(float NDotH,float alpha){float alpha2=alpha*alpha;float t=1.0+(alpha2-1.0)*NDotH*NDotH;return(alpha2-1.0)/(PI*log(alpha2)*t);}float LGL_K(float NDotH,float a){float a2=a*a;float t=1.0+(a2-1.0)*NDotH*NDotH;return a2/(PI*t*t);}vec3 ImportanceSampleLGL_J(float rgh,float r1,float r2){float a=max(0.001,rgh);float a2=a*a;float phi=r1*TWOPI;float cosTheta=sqrt((1.0-pow(a2,1.0-r1))/(1.0-a2));float sinTheta=clamp(sqrt(1.0-(cosTheta*cosTheta)),0.0,1.0);float sinPhi=sin(phi);float cosPhi=cos(phi);return vec3(sinTheta*cosPhi,sinTheta*sinPhi,cosTheta);}vec3 ImportanceSampleLGL_K(float rgh,float r1,float r2){float a=max(0.001,rgh);float phi=r1*TWOPI;float cosTheta=sqrt((1.0-r2)/(1.0+(a*a-1.0)*r2));float sinTheta=clamp(sqrt(1.0-(cosTheta*cosTheta)),0.0,1.0);float sinPhi=sin(phi);float cosPhi=cos(phi);return vec3(sinTheta*cosPhi,sinTheta*sinPhi,cosTheta);}vec3 LGL_N(SurfaceInteraction si,vec3 Csheen,vec3 V,vec3 N,vec3 L,vec3 H,out float pdf){float NDotL=dot(N,L);pdf=0.0;if(NDotL<=0.0)return vec3(0.0);pdf=NDotL*INVPI;float NDotV=dot(N,V);float LDotH=dot(L,H);float FL=LGL_E(NDotL);float FV=LGL_E(NDotV);float Fh=LGL_E(LDotH);float Fd90=0.5+2.0*LDotH*LDotH*si.roughness;float Fd=mix(1.0,Fd90,FL)*mix(1.0,Fd90,FV);float Fss90=LDotH*LDotH*si.roughness;float Fss=mix(1.0,Fss90,FL)*mix(1.0,Fss90,FV);float DisneyFakeSS=1.25*(Fss*(1.0/(dot(N,L)+dot(N,V))-0.5)+0.5);vec3 Fsheen=Fh*si.sheen*Csheen;return(INVPI*mix(Fd,DisneyFakeSS,si.subsurface)*si.color+Fsheen)*(1.0-si.metalness)*(1.0-si.specTrans);}vec3 LGL_O(SurfaceInteraction si,vec3 Cspec0,vec3 V,vec3 N,vec3 L,vec3 H,out float pdf){float NDotL=dot(N,L);pdf=0.0;if(NDotL<=0.0)return vec3(0.0);float NDotV=dot(N,V);float NDotH=dot(N,H);float LDotH=dot(L,H);float D=LGL_K(NDotH,si.roughness);pdf=D*NDotH/(4.0*LDotH);vec3 F=LGL_H(Cspec0,si.metalness,si.eta,LDotH);float G=LGL_I(abs(NDotL),si.roughness)*LGL_I(abs(NDotV),si.roughness);return F*D*G;}vec3 LGL_P(SurfaceInteraction si,vec3 Cspec0,vec3 V,vec3 N,vec3 L,vec3 H,out float pdf){pdf=0.0;if(dot(N,L)>=0.0)return vec3(0.0);float F=LGL_G(abs(dot(V,H)),si.eta);float D=LGL_K(dot(N,H),si.roughness);float denomSqrt=dot(L,H)+dot(V,H)*si.eta;pdf=D*dot(N,H)*abs(dot(L,H))/(denomSqrt*denomSqrt);float G=LGL_I(abs(dot(N,L)),si.roughness)*LGL_I(abs(dot(N,V)),si.roughness);vec3 specColor=pow(si.color,vec3(0.5));return specColor*(1.0-si.metalness)*si.specTrans*(1.0-F)*D*G*abs(dot(V,H))*abs(dot(L,H))*4.0*si.eta*si.eta/(denomSqrt*denomSqrt);}vec3 LGL_Q(SurfaceInteraction si,vec3 V,vec3 N,vec3 L,vec3 H,out float pdf){float NDotL=dot(N,L);pdf=0.0;if(NDotL<=0.0)return vec3(0.0);float NDotV=dot(N,V);float NDotH=dot(N,H);float LDotH=dot(L,H);float F=LGL_F(.04,LDotH);float D=LGL_J(NDotH,mix(0.1,0.001,1.-si.clearcoatRoughness));pdf=D*NDotH/(4.0*LDotH);float G=LGL_I(NDotL,0.25)*LGL_I(NDotV,0.25);return vec3(0.25*si.clearcoat*F*D*G);}void LGL_R(SurfaceInteraction si,vec3 Cspec0,float fresnelWeight,out float diffuseWeight,out float specularWeight,out float transWeight,out float clearcoatWeight){diffuseWeight=max(LGL_AP(si.color),si.sheen)*(1.0-si.metalness)*(1.0-si.specTrans);specularWeight=LGL_AP(mix(Cspec0,vec3(1.0),fresnelWeight));transWeight=(1.0-fresnelWeight)*(1.0-si.metalness)*si.specTrans*LGL_AP(si.color);clearcoatWeight=si.clearcoat*(1.0-si.metalness);float weightSum=diffuseWeight+specularWeight+transWeight+clearcoatWeight;diffuseWeight/=weightSum;specularWeight/=weightSum;transWeight/=weightSum;clearcoatWeight/=weightSum;}vec3 LGL_S(SurfaceInteraction si,vec3 V,vec3 N,out vec3 L,out float pdf,MaterialSamples LGL_AKomSamples){pdf=0.0;vec3 f=vec3(0.0);vec2 bounceDirSample=LGL_AKomSamples.s3;vec2 diffuseOrSpecular=LGL_AKomSamples.s4;float r1=bounceDirSample.x;float r2=bounceDirSample.y;vec3 Cspec0,Csheen;LGL_D(si,Cspec0,Csheen);float diffuseWeight,specularWeight,transWeight,clearcoatWeight;float fresnelWeight=LGL_H(si.metalness,si.eta,abs(dot(V,N)));LGL_R(si,Cspec0,fresnelWeight,diffuseWeight,specularWeight,transWeight,clearcoatWeight);float cdf[4];cdf[0]=diffuseWeight;cdf[1]=cdf[0]+specularWeight;cdf[2]=cdf[1]+transWeight;cdf[3]=cdf[2]+clearcoatWeight;vec3 T,B;LGL_AT(N,T,B);if(r1<cdf[0]){r1/=cdf[0];L=LGL_A(r1,r2);L=T*L.x+B*L.y+N*L.z;vec3 H=normalize(L+V);f=LGL_N(si,Csheen,V,N,L,H,pdf);pdf*=diffuseWeight;}else if(r1<cdf[1]){r1=(r1-cdf[0])/(cdf[1]-cdf[0]);vec3 H=ImportanceSampleLGL_K(si.roughness,r1,r2);H=T*H.x+B*H.y+N*H.z;if(dot(V,H)<0.0)H=-H;L=normalize(reflect(-V,H));f=LGL_O(si,Cspec0,V,N,L,H,pdf);pdf*=specularWeight;}else if(r1<cdf[2]){r1=(r1-cdf[1])/(cdf[2]-cdf[1]);vec3 H=ImportanceSampleLGL_K(si.roughness,r1,r2);H=T*H.x+B*H.y+N*H.z;if(dot(V,H)<0.0)H=-H;vec3 R=reflect(-V,H);L=normalize(refract(-V,H,si.eta));f=LGL_P(si,Cspec0,V,N,L,H,pdf);pdf*=transWeight;}else{r1=(r1-cdf[2])/(1.0-cdf[2]);vec3 H=ImportanceSampleLGL_J(mix(0.1,0.001,1.-si.clearcoatRoughness),r1,r2);H=T*H.x+B*H.y+N*H.z;if(dot(V,H)<0.0)H=-H;L=normalize(reflect(-V,H));f=LGL_Q(si,V,N,L,H,pdf);pdf*=clearcoatWeight;}return f*abs(dot(N,L));}vec3 LGL_T(inout SurfaceInteraction si,vec3 V,vec3 L,out float bsdfPdf){bsdfPdf=0.0;vec3 f=vec3(0.0);vec3 N=si.ffnormal;vec3 H;float NDotL=dot(N,L);float NDotV=dot(N,V);if(NDotL>0.0){H=normalize(L+V);}else{H=normalize(L+V*si.eta);}if(dot(V,H)<0.0){H=-H;}vec3 Cspec0,Csheen;LGL_D(si,Cspec0,Csheen);float diffuseWeight,specularWeight,transWeight,clearcoatWeight;float fresnelWeight=LGL_H(si.metalness,si.eta,abs(dot(L,H)));LGL_R(si,Cspec0,fresnelWeight,diffuseWeight,specularWeight,transWeight,clearcoatWeight);float pdf;if(diffuseWeight>0.0&&NDotL>0.0){f+=LGL_N(si,Csheen,V,N,L,H,pdf);bsdfPdf+=pdf*diffuseWeight;}if(specularWeight>0.0&&NDotL>0.0&&NDotV>0.0){f+=LGL_O(si,Cspec0,V,N,L,H,pdf);bsdfPdf+=pdf*specularWeight;}if(transWeight>0.0&&NDotL<0.0){f+=LGL_P(si,Cspec0,V,N,L,H,pdf);bsdfPdf+=pdf*transWeight;}if(clearcoatWeight>0.0&&NDotL>0.0&&NDotV>0.0){f+=LGL_Q(si,V,N,L,H,pdf);bsdfPdf+=pdf*clearcoatWeight;}return f*abs(dot(N,L));}vec3 LGL_a(inout SurfaceInteraction si,in Path path,in vec2 s1,in vec2 s2){si.eta=dot(si.normal,si.ffnormal)>0.0 ?(1.0/si.ior): si.ior;vec3 viewDir=-path.ray.d;vec3 surfacePos=si.position+EPS*si.normal;vec3 Li=vec3(0.0);BsdfSampleRec bsdfSampleRec;vec2 lightDirSample=s1;vec2 envDirSample=s2;vec3 lightDir;vec2 uv;float lightPdf;bool brdfSample=false;
#ifndef CONST_COLOR_ENV
lightDir=LGL_Z(envDirSample,uv,lightPdf);LGL_AQ(path.ray,surfacePos,lightDir);if(!LGL_i(path.ray,INF-EPS)){vec3 irr=LGL_Ag(envMap,uv).rgb*envMapIntensity;bsdfSampleRec.f=LGL_T(si,viewDir,lightDir,bsdfSampleRec.pdf);if(bsdfSampleRec.pdf>0.0){float misWeight=LGL_AZ(lightPdf,bsdfSampleRec.pdf);if(misWeight>0.0){Li+=misWeight*bsdfSampleRec.f*irr/lightPdf;}}}
#endif
#if defined(NUM_LIGHTS)
LightSampleRec lightSampleRec;Light light;int i=int(lightDirSample.x*float(NUM_LIGHTS));vec3 position=lights.position[i];vec3 emission=lights.emission[i];vec3 p1=lights.p1[i];vec3 p2=lights.p2[i];vec4 params=lights.params[i];float radius=params.x;float area=params.y;float type=params.z;float visible=params.w;light=Light(position,emission,p1,p2,radius,area,type,visible);LGL_Af(light,surfacePos,lightSampleRec,lightDirSample);if(dot(lightSampleRec.direction,lightSampleRec.normal)<0.0){LGL_AQ(path.ray,surfacePos,lightSampleRec.direction);if(!LGL_i(path.ray,lightSampleRec.dist-EPS)){bsdfSampleRec.f=LGL_T(si,viewDir,lightSampleRec.direction,bsdfSampleRec.pdf);float weight=1.0;if(light.area>0.0)weight=LGL_AZ(lightSampleRec.pdf,bsdfSampleRec.pdf);if(bsdfSampleRec.pdf>0.0)Li+=weight*bsdfSampleRec.f*lightSampleRec.emission/lightSampleRec.pdf;}}
#endif
return Li;}layout(location=0)out vec4 out_light;void bounce(inout Path path,int depth,inout SurfaceInteraction si,inout BsdfSampleRec bsdfSampleRec,inout LightSampleRec lightSampleRec){if(!si.hit){
#ifdef CONST_COLOR_ENV
path.li+=backgroundColor*path.beta;path.abort=true;return;
#else
float misWeight=1.0;if(depth>0&&!path.specularBounce){float lightPdf=LGL_Y(LGL_U(path.ray.d));misWeight=LGL_AZ(bsdfSampleRec.pdf,lightPdf);}vec3 irr=LGL_V(path.ray.d)*envMapIntensity;path.li+=misWeight*path.beta*irr;path.abort=true;return;
#endif
}if(si.isEmitter){path.li+=LGL_Aa(path.ray,depth,path.specularBounce,lightSampleRec,bsdfSampleRec)*path.beta;path.abort=true;return;}if(dot(si.normal,si.ffnormal)>0.0){path.absorption=vec3(0.0);}path.li+=path.beta*si.emissive;path.beta*=exp(-path.absorption*si.t);MaterialSamples LGL_AKomSamples=getRandomMaterialSamples();if(si.materialType==DISNEY){path.li+=LGL_a(si,path,LGL_AKomSamples.s1,LGL_AKomSamples.s2)*path.beta;}bsdfSampleRec.f=LGL_S(si,-path.ray.d,si.ffnormal,bsdfSampleRec.L,bsdfSampleRec.pdf,LGL_AKomSamples);if(dot(si.ffnormal,bsdfSampleRec.L)<0.0){path.absorption=-log(si.extinction)/si.atDistance;}if(bsdfSampleRec.pdf>0.0){path.beta*=bsdfSampleRec.f/bsdfSampleRec.pdf;}else{path.abort=true;return;}if(depth>=2){float q=1.0-LGL_AP(path.beta);if(LGL_AKomSample()<q){path.abort=true;return;}path.beta/=1.0-q;}LGL_AQ(path.ray,si.position+EPS*bsdfSampleRec.L,bsdfSampleRec.L);}vec4 LGL_Ah(inout Ray ray){SurfaceInteraction si;Path path;BsdfSampleRec bsdfSampleRec;LightSampleRec lightSampleRec;path.ray=ray;path.li=vec3(0);path.alpha=1.0;path.specularBounce=false;path.abort=false;path.misWeight=1.0;path.absorption=vec3(0.0);path.beta=vec3(1.0);LGL_j(path.ray,si,lightSampleRec,0);bounce(path,0,si,bsdfSampleRec,lightSampleRec);for(int i=1;i<bounces;i++){if(path.abort){return vec4(path.li,path.alpha);}LGL_j(path.ray,si,lightSampleRec,i);bounce(path,i,si,bsdfSampleRec,lightSampleRec);}return vec4(path.li,path.alpha);}void main(){LGL_AM(frameCount);vec2 vCoordAntiAlias=vCoord+jitter;vec3 direction=normalize(vec3(vCoordAntiAlias-0.5,-1.0)*vec3(camera.aspect,1.0,camera.fov));
#ifdef USE_LENS_CAMERA
vec2 lensPoint=camera.aperture*LGL_AU(vec2(LGL_AH(vCoordAntiAlias)));vec3 focusPoint=-direction*camera.focus/direction.z;vec3 origin=vec3(lensPoint,0.0);direction=normalize(focusPoint-origin);origin=vec3(camera.transform*vec4(origin,1.0));direction=mat3(camera.transform)*direction;
#else
vec3 origin=camera.transform[3].xyz;direction=mat3(camera.transform)*direction;
#endif
Ray cam;LGL_AQ(cam,origin,direction);vec4 liAndAlpha=LGL_Ah(cam);if(!(liAndAlpha.x<INF&&liAndAlpha.x>-EPS)){liAndAlpha=vec4(0,0,0,1);}out_light=liAndAlpha;}`};function Ei(a,e){const t=[],n=a**e;for(let l=0;l<n;l++)t[l]=l;let i=t.length;const s=[];function o(){i=0}function r(){i>=t.length&&(Ya(t),o());let l=t[i++];for(let c=0;c<e;c++)s[c]=l%a+Math.random(),l=Math.floor(l/a);return s}return{next:r,restart:o,strataCount:a}}function mn(a,e){const t=[];for(const o of e)t.push(Ei(a,o));const n=[];function i(){let o=0;for(const r of t){const l=r.next();for(const c of l)n[o++]=c}return n}function s(){for(const o of t)o.restart()}return{next:i,restart:s,strataCount:a}}const hn="KCgpPT57KGZ1bmN0aW9uKCl7InVzZSBzdHJpY3QiO2NsYXNzIHp7Y29uc3RydWN0b3IodD0wLG49MCxpPTApe3RoaXMueD10LHRoaXMueT1uLHRoaXMuej1pfWxlbmd0aCgpe3JldHVybiBNYXRoLnNxcnQodGhpcy54KnRoaXMueCt0aGlzLnkqdGhpcy55K3RoaXMueip0aGlzLnopfWFkZFZlY3RvcnModCxuKXtyZXR1cm4gdGhpcy54PXQueCtuLngsdGhpcy55PXQueStuLnksdGhpcy56PXQueituLnosdGhpc31zdWJWZWN0b3JzKHQsbil7cmV0dXJuIHRoaXMueD10Lngtbi54LHRoaXMueT10Lnktbi55LHRoaXMuej10Lnotbi56LHRoaXN9bXVsdGlwbHlTY2FsYXIodCl7cmV0dXJuIHRoaXMueCo9dCx0aGlzLnkqPXQsdGhpcy56Kj10LHRoaXN9ZGl2aWRlKHQpe3JldHVybiB0aGlzLngvPXQueCx0aGlzLnkvPXQueSx0aGlzLnovPXQueix0aGlzfWRpdmlkZVNjYWxhcih0KXtyZXR1cm4gdGhpcy5tdWx0aXBseVNjYWxhcigxL3QpfW1pbih0KXtyZXR1cm4gdGhpcy54PU1hdGgubWluKHRoaXMueCx0LngpLHRoaXMueT1NYXRoLm1pbih0aGlzLnksdC55KSx0aGlzLno9TWF0aC5taW4odGhpcy56LHQueiksdGhpc31tYXgodCl7cmV0dXJuIHRoaXMueD1NYXRoLm1heCh0aGlzLngsdC54KSx0aGlzLnk9TWF0aC5tYXgodGhpcy55LHQueSksdGhpcy56PU1hdGgubWF4KHRoaXMueix0LnopLHRoaXN9ZG90KHQpe3JldHVybiB0aGlzLngqdC54K3RoaXMueSp0LnkrdGhpcy56KnQuen1ub3JtYWxpemUoKXtyZXR1cm4gdGhpcy5kaXZpZGVTY2FsYXIodGhpcy5sZW5ndGgoKXx8MSl9Y3Jvc3NWZWN0b3JzKHQsbil7Y29uc3QgaT10LngseD10Lnksbz10LnosbD1uLngsYz1uLnksdT1uLno7cmV0dXJuIHRoaXMueD14KnUtbypjLHRoaXMueT1vKmwtaSp1LHRoaXMuej1pKmMteCpsLHRoaXN9ZnJvbUJ1ZmZlckF0dHJpYnV0ZSh0LG4saSl7cmV0dXJuIGkhPT12b2lkIDAmJmNvbnNvbGUud2FybigiVEhSRUUuVmVjdG9yMzogb2Zmc2V0IGhhcyBiZWVuIHJlbW92ZWQgZnJvbSAuZnJvbUJ1ZmZlckF0dHJpYnV0ZSgpLiIpLHRoaXMueD10LmdldFgobiksdGhpcy55PXQuZ2V0WShuKSx0aGlzLno9dC5nZXRaKG4pLHRoaXN9fWNsYXNzIGJ7Y29uc3RydWN0b3IodD1uZXcgeigxLzAsMS8wLDEvMCksbj1uZXcgeigtMS8wLC0xLzAsLTEvMCkpe3RoaXMubWluPXQsdGhpcy5tYXg9bn1pc0VtcHR5KCl7cmV0dXJuIHRoaXMubWF4Lng8dGhpcy5taW4ueHx8dGhpcy5tYXgueTx0aGlzLm1pbi55fHx0aGlzLm1heC56PHRoaXMubWluLnp9Z2V0Q2VudGVyKHQpe3JldHVybiB0aGlzLmlzRW1wdHkoKT90LnNldCgwLDAsMCk6dC5hZGRWZWN0b3JzKHRoaXMubWluLHRoaXMubWF4KS5tdWx0aXBseVNjYWxhciguNSl9Z2V0U2l6ZSh0KXtyZXR1cm4gdGhpcy5pc0VtcHR5KCk/dC5zZXQoMCwwLDApOnQuc3ViVmVjdG9ycyh0aGlzLm1heCx0aGlzLm1pbil9ZXhwYW5kQnlQb2ludCh0KXtyZXR1cm4gdGhpcy5taW4ubWluKHQpLHRoaXMubWF4Lm1heCh0KSx0aGlzfXVuaW9uKHQpe3JldHVybiB0aGlzLm1pbi5taW4odC5taW4pLHRoaXMubWF4Lm1heCh0Lm1heCksdGhpc319ZnVuY3Rpb24gSShlLHQsbj0wLGk9ZS5sZW5ndGgpe2Zvcig7biE9PWk7KXtmb3IoO3QoZVtuXSk7KWlmKG4rKyxuPT09aSlyZXR1cm4gbjtkbyBpZihpLS0sbj09PWkpcmV0dXJuIG47d2hpbGUoIXQoZVtpXSkpO1MoZSxuLGkpLG4rK31yZXR1cm4gbn1mdW5jdGlvbiBrKGUsdCxuPTAsaT1lLmxlbmd0aCx4PU1hdGguZmxvb3IoKG4raSkvMikpe2ZvcihsZXQgbz1uO288PXg7bysrKXtsZXQgbD1vLGM9ZVtvXTtmb3IobGV0IHU9bysxO3U8aTt1KyspdChjLGVbdV0pfHwobD11LGM9ZVt1XSxTKGUsbyxsKSl9fWZ1bmN0aW9uIFMoZSx0LG4pe2NvbnN0IGk9ZVtuXTtlW25dPWVbdF0sZVt0XT1pfWNvbnN0IHk9bmV3IHo7ZnVuY3Rpb24gRShlKXtjb25zdCB0PVtdLG49W10saT17eDowLHk6MSx6OjJ9O2xldCB4PTE7Y29uc3Qgbz0ocixzPTEpPT57aWYoeD1NYXRoLm1heChzLHgpLHIucHJpbWl0aXZlcylmb3IobGV0IGE9MDthPHIucHJpbWl0aXZlcy5sZW5ndGg7YSsrKXtjb25zdCBmPXIucHJpbWl0aXZlc1thXTt0LnB1c2goZi5pbmRpY2VzWzBdLGYuaW5kaWNlc1sxXSxmLmluZGljZXNbMl0sci5wcmltaXRpdmVzLmxlbmd0aCxmLmZhY2VOb3JtYWwueCxmLmZhY2VOb3JtYWwueSxmLmZhY2VOb3JtYWwueixmLm1hdGVyaWFsSW5kZXgpLG4ucHVzaCghMSl9ZWxzZXtjb25zdCBhPXIuYm91bmRzO3QucHVzaChhLm1pbi54LGEubWluLnksYS5taW4ueixpW3Iuc3BsaXRBeGlzXSxhLm1heC54LGEubWF4LnksYS5tYXgueixudWxsKTtjb25zdCBmPXQubGVuZ3RoLTE7bi5wdXNoKCEwKSxvKHIuY2hpbGQwLHMrMSksdFtmXT10Lmxlbmd0aC80LG8oci5jaGlsZDEscysxKX19O28oZSk7Y29uc3QgbD1uZXcgQXJyYXlCdWZmZXIoNCp0Lmxlbmd0aCksYz1uZXcgRmxvYXQzMkFycmF5KGwpLHU9bmV3IEludDMyQXJyYXkobCk7Zm9yKGxldCByPTA7cjxuLmxlbmd0aDtyKyspe2xldCBzPTgqcjtuW3JdPyhjW3NdPXRbc10sY1tzKzFdPXRbcysxXSxjW3MrMl09dFtzKzJdLHVbcyszXT10W3MrM10pOih1W3NdPXRbc10sdVtzKzFdPXRbcysxXSx1W3MrMl09dFtzKzJdLHVbcyszXT0tdFtzKzNdKSxjW3MrNF09dFtzKzRdLGNbcys1XT10W3MrNV0sY1tzKzZdPXRbcys2XSx1W3MrN109dFtzKzddfXJldHVybnttYXhEZXB0aDp4LGNvdW50OnQubGVuZ3RoLzQsYnVmZmVyOmN9fWZ1bmN0aW9uIFAoZSl7Y29uc3QgdD1bXSxuPWUuZ2V0SW5kZXg/ZS5nZXRJbmRleCgpLmFycmF5OmUuaW5kZXguYXJyYXksaT1lLmdldEF0dHJpYnV0ZT9lLmdldEF0dHJpYnV0ZSgicG9zaXRpb24iKTplLmF0dHJpYnV0ZXMucG9zaXRpb24seD1lLmdldEF0dHJpYnV0ZT9lLmdldEF0dHJpYnV0ZSgibWF0ZXJpYWxNZXNoSW5kZXgiKTplLmF0dHJpYnV0ZXMubWF0ZXJpYWxNZXNoSW5kZXgsbz1uZXcgeixsPW5ldyB6LGM9bmV3IHosdT1uZXcgeixyPW5ldyB6O2ZvcihsZXQgcz0wO3M8bi5sZW5ndGg7cys9Myl7Y29uc3QgYT1uW3NdLGY9bltzKzFdLGg9bltzKzJdLG09bmV3IGI7aS5nZXRYPyhvLmZyb21CdWZmZXJBdHRyaWJ1dGUoaSxhKSxsLmZyb21CdWZmZXJBdHRyaWJ1dGUoaSxmKSxjLmZyb21CdWZmZXJBdHRyaWJ1dGUoaSxoKSk6KG8ueD1pLmFycmF5W2EqaS5pdGVtU2l6ZV0sby55PWkuYXJyYXlbYSppLml0ZW1TaXplKzFdLG8uej1pLmFycmF5W2EqaS5pdGVtU2l6ZSsyXSxsLng9aS5hcnJheVtmKmkuaXRlbVNpemVdLGwueT1pLmFycmF5W2YqaS5pdGVtU2l6ZSsxXSxsLno9aS5hcnJheVtmKmkuaXRlbVNpemUrMl0sYy54PWkuYXJyYXlbaCppLml0ZW1TaXplXSxjLnk9aS5hcnJheVtoKmkuaXRlbVNpemUrMV0sYy56PWkuYXJyYXlbaCppLml0ZW1TaXplKzJdKSxtLmV4cGFuZEJ5UG9pbnQobyksbS5leHBhbmRCeVBvaW50KGwpLG0uZXhwYW5kQnlQb2ludChjKSx1LnN1YlZlY3RvcnMoYyxvKSxyLnN1YlZlY3RvcnMobCxvKTtjb25zdCB3PW5ldyB6KCkuY3Jvc3NWZWN0b3JzKHIsdSkubm9ybWFsaXplKCksZz17Ym91bmRzOm0sY2VudGVyOm0uZ2V0Q2VudGVyKG5ldyB6KSxpbmRpY2VzOlthLGYsaF0sZmFjZU5vcm1hbDp3LG1hdGVyaWFsSW5kZXg6eC5nZXRYP3guZ2V0WChhKTp4LmFycmF5W2EqeC5pdGVtU2l6ZV19O3QucHVzaChnKX1yZXR1cm4gdH1mdW5jdGlvbiBNKGUsdCl7cmV0dXJue3ByaW1pdGl2ZXM6ZSxib3VuZHM6dH19ZnVuY3Rpb24gTihlLHQsbil7cmV0dXJue2NoaWxkMDp0LGNoaWxkMTpuLGJvdW5kczpuZXcgYigpLnVuaW9uKHQuYm91bmRzKS51bmlvbihuLmJvdW5kcyksc3BsaXRBeGlzOmV9fWZ1bmN0aW9uIHYoZSl7cmV0dXJuIGUuZ2V0U2l6ZSh5KSx5Lng+eS56P3kueD55Lnk/IngiOiJ5Ijp5Lno+eS55PyJ6IjoieSJ9ZnVuY3Rpb24gQShlLHQsbil7bGV0IGk9blt0XS1lLm1pblt0XTtyZXR1cm4gZS5tYXhbdF0+ZS5taW5bdF0mJihpLz1lLm1heFt0XS1lLm1pblt0XSksaX1mdW5jdGlvbiBwKGUpe3JldHVybiBlLmdldFNpemUoeSksMiooeS54Knkueit5LngqeS55K3kueip5LnkpfWZ1bmN0aW9uIEIoZSx0LG4pe2NvbnN0IGk9bmV3IGI7Zm9yKGxldCBvPXQ7bzxuO28rKylpLnVuaW9uKGVbb10uYm91bmRzKTtjb25zdCB4PW4tdDtpZih4PT09MSlyZXR1cm4gTShlLnNsaWNlKHQsbiksaSk7e2NvbnN0IG89bmV3IGI7Zm9yKGxldCB1PXQ7dTxuO3UrKylvLmV4cGFuZEJ5UG9pbnQoZVt1XS5jZW50ZXIpO2NvbnN0IGw9dihvKTtsZXQgYz1NYXRoLmZsb29yKCh0K24pLzIpO2lmKHg8PTQpayhlLCh1LHIpPT51LmNlbnRlcltsXTxyLmNlbnRlcltsXSx0LG4sYyk7ZWxzZXtpZihvLm1heFtsXT09PW8ubWluW2xdKXJldHVybiBNKGUuc2xpY2UodCxuKSxpKTt7Y29uc3QgdT0xMixyPVtdO2ZvcihsZXQgaD0wO2g8dTtoKyspci5wdXNoKHtib3VuZHM6bmV3IGIsY291bnQ6MH0pO2ZvcihsZXQgaD10O2g8bjtoKyspe2xldCBtPU1hdGguZmxvb3IodSpBKG8sbCxlW2hdLmNlbnRlcikpO209PT1yLmxlbmd0aCYmKG09ci5sZW5ndGgtMSksclttXS5jb3VudCsrLHJbbV0uYm91bmRzLnVuaW9uKGVbaF0uYm91bmRzKX1jb25zdCBzPVtdO2ZvcihsZXQgaD0wO2g8ci5sZW5ndGgtMTtoKyspe2NvbnN0IG09bmV3IGIsdz1uZXcgYjtsZXQgZz0wLFY9MDtmb3IobGV0IGQ9MDtkPD1oO2QrKyltLnVuaW9uKHJbZF0uYm91bmRzKSxnKz1yW2RdLmNvdW50O2ZvcihsZXQgZD1oKzE7ZDxyLmxlbmd0aDtkKyspdy51bmlvbihyW2RdLmJvdW5kcyksVis9cltkXS5jb3VudDtzLnB1c2goLjErKGcqcChtKStWKnAodykpL3AoaSkpfWxldCBhPXNbMF0sZj0wO2ZvcihsZXQgaD0xO2g8cy5sZW5ndGg7aCsrKXNbaF08YSYmKGE9c1toXSxmPWgpO2M9SShlLGg9PntsZXQgbT1NYXRoLmZsb29yKHIubGVuZ3RoKkEobyxsLGguY2VudGVyKSk7cmV0dXJuIG09PT1yLmxlbmd0aCYmKG09ci5sZW5ndGgtMSksbTw9Zn0sdCxuKX19cmV0dXJuIE4obCxCKGUsdCxjKSxCKGUsYyxuKSl9fWZ1bmN0aW9uIEMoZSl7Y29uc3QgdD1QKGUpO3JldHVybiBCKHQsMCx0Lmxlbmd0aCl9c2VsZi5vbm1lc3NhZ2U9ZnVuY3Rpb24oe2RhdGE6ZX0pe2NvbnN0e2dlb21ldHJ5OnR9PWU7dHJ5e2NvbnN0IG49Qyh0KSxpPUUobik7c2VsZi5wb3N0TWVzc2FnZSh7ZXJyb3I6bnVsbCxmbGF0dGVuZWRCdmg6aX0pfWNhdGNoKG4pe3NlbGYucG9zdE1lc3NhZ2Uoe2Vycm9yOm4sZmxhdHRlbmVkQnZoOm51bGx9KX19fSkoKTt9KSgpOwo=",xn=typeof window!="undefined"&&window.Blob&&new Blob([atob(hn)],{type:"text/javascript;charset=utf-8"});function Gi(){const a=xn&&(window.URL||window.webkitURL).createObjectURL(xn);try{return a?new Worker(a):new Worker("data:application/javascript;base64,"+hn,{type:"module"})}finally{a&&(window.URL||window.webkitURL).revokeObjectURL(a)}}class wi{constructor(){this.worker=new Gi,this.building=!1}build(e){if(this.building)throw new Error("BVHWorker is building");this.building=!0;const{worker:t}=this;return new Promise((n,i)=>{t.onmessage=s=>{this.building=!1,t.onmessage=null;const{flattenedBvh:o,error:r}=s.data;r?i(new Error(r)):n(o)},t.postMessage({geometry:e})})}}function at(a){const e=Math.round(Math.log2(Math.sqrt(a))),t=2**e,n=Math.ceil(a/t);return{columnsLog:e,columns:t,rows:n,size:n*t}}function it(a,e,t){const n=at(e.length/t);return Z(a,{data:Ui(e,t*n.size),width:n.columns,height:n.rows})}function Ui(a,e){const t=new a.constructor(e);return t.set(a),t}function Xi(a,e=!0){return e&&window.Worker?new wi().build(a):new Promise(t=>{const n=Si(a),i=gi(n);t(i)})}async function Di({decomposedScene:a,fullscreenQuad:e,gl:t,materialBuffer:n,mergedMesh:i,optionalExtensions:s,useWorker:o,loadingCallback:r}){const{OES_texture_float_linear:l}=s,{camera:c,meshLightsNum:u,isTextureEnv:f}=a,{geometry:d,materials:p}=i;r&&r.onProgress&&typeof r.onProgress=="function"&&r.onProgress("Building BVH...");const h=await Xi(d,o),L=d.index.count/3,x=Ae(t,{defines:ht({OES_texture_float_linear:l,BVH_COLUMNS:at(h.count).columnsLog,INDEX_COLUMNS:at(L).columnsLog,VERTEX_COLUMNS:at(d.attributes.position.count).columnsLog,STACK_SIZE:h.maxDepth,USE_LENS_CAMERA:c.isLensCamera,NUM_LIGHTS:u,CONST_COLOR_ENV:!f},n.defines),fragment:Ri,vertex:e.vertexShader});return x.setTexture("diffuseMap",n.textures.diffuseMap),x.setTexture("normalMap",n.textures.normalMap),x.setTexture("pbrMap",n.textures.pbrMap),x.setTexture("pbrSGMap",n.textures.pbrSGMap),n.textures.emissiveMap&&x.setTexture("emissiveMap",n.textures.emissiveMap),x.setTexture("positionBuffer",it(t,d.getAttribute("position").array,3)),x.setTexture("normalBuffer",it(t,d.getAttribute("normal").array,3)),x.setTexture("uvBuffer",it(t,d.getAttribute("uv").array,2)),x.setTexture("bvhBuffer",it(t,h.buffer,4)),x}async function Ci(a,{bounces:e,decomposedScene:t,fullscreenQuad:n,materialBuffer:i,mergedMesh:s,optionalExtensions:o,envMapIntensity:r,useWorker:l,loadingCallback:c}){let u;const f=await Di({bounces:e,decomposedScene:t,fullscreenQuad:n,gl:a,materialBuffer:i,mergedMesh:s,optionalExtensions:o,envMapIntensity:r,useWorker:l,loadingCallback:c}),d=[];p(e),h(t),L(t);function p(_){d.length=0,_=be(_,2,8);for(let N=1;N<=_;N++)d.push(2,2,2,2),N>=2&&d.push(1);f.setUniform("bounces",_),u&&(u.strataCount=-1)}function h(_){const{OES_texture_float_linear:N}=o,{environment:w,isTextureEnv:B}=_;if(B){const G=Ii(w);if(G){const Q=Z(a,{data:G.data,storage:G.dataFormat,minFilter:N?a.LINEAR:a.NEAREST,magFilter:N?a.LINEAR:a.NEAREST,width:G.width,height:G.height});f.setTexture("envMap",Q);const k=Pi(G);f.setTexture("envMapDistribution",Z(a,{data:k.data,storage:"halfFloat",width:k.width,height:k.height})),f.setUniform("envMapIntensity",r)}}else{const G=w.data;G&&G.isColor?f.setUniform("backgroundColor",[G.r,G.g,G.b]):f.setUniform("backgroundColor",[0,0,0])}}function L(_){const{meshLights:N}=_;N&&(f.setUniform("lights.position[0]",N.position),f.setUniform("lights.emission[0]",N.emission),f.setUniform("lights.p1[0]",N.p1),f.setUniform("lights.p2[0]",N.p2),f.setUniform("lights.params[0]",N.params))}function x(_){f.setUniform("envMapIntensity",_)}function g(_){f.setTexture("noiseTex",Z(a,{data:_,wrapS:a.REPEAT,wrapT:a.REPEAT,storage:"halfFloat"}))}function M(_){f.setUniform("frameCount",_)}function A(){f.setUniform("stratifiedSamples[0]",u.next())}function T(_,N){f.setUniform("jitter",_,N)}function S(_){_>1&&_!==u.strataCount?u=mn(_,d):u.restart(),f.setUniform("strataSize",1/_),A()}function F(_,N){f.setUniform("pixelSize",1/_,1/N)}function I(_){f.setUniform("camera.transform",_.matrixWorld.elements),f.setUniform("camera.aspect",_.aspect),f.setUniform("camera.fov",.5/Math.tan(.5*Math.PI*_.fov/180)),_.isLensCamera&&(f.setUniform("camera.aperture",_.aperture),f.setUniform("camera.focus",_.focus))}function P({position:_}){f.setTexture("gPosition",_)}function y(){f.bindTextures()}function E(){f.useProgram(!1),n.draw()}return u=mn(1,d),{bindTextures:y,draw:E,outputLocs:f.outputLocs,textures:f.textures,setSize:F,setCamera:I,setGBuffers:P,setNoise:g,setJitter:T,setFrameCount:M,setStrataCount:S,nextSeed:A,setEnvMapIntensity:x,updateBounces:p,updateEnvLight:h,updateMeshLight:L}}var ki={source:"in vec3 aPosition;in vec3 aNormal;in vec2 aUv;in ivec2 aMaterialMeshIndex;uniform mat4 projView;out vec3 vPosition;out vec3 vNormal;out vec2 vUv;flat out ivec2 vMaterialMeshIndex;void main(){vPosition=aPosition;vNormal=aNormal;vUv=aUv;vMaterialMeshIndex=aMaterialMeshIndex;gl_Position=projView*vec4(aPosition,1);}"},Oi={source:`
#define PI 3.14159265359
#define TWOPI 6.28318530718
#define INVPI 0.31830988618
#define INVPI2 0.10132118364
#define EPS 0.0001
#define ONE_MINUS_EPS 0.999999
#define INF 1000000.0
#define ROUGHNESS_MIN 0.001
uniform Materials{vec4 colorAndMaterialType[NUM_MATERIALS];vec4 roughnessMetalnessNormalScale[NUM_MATERIALS];vec4 specularTintSheenSheenTint[NUM_MATERIALS];vec4 clearcoaRoughnessSubfaceTransmission[NUM_MATERIALS];vec4 iorAtDistanceAnisotropicWorkflow[NUM_MATERIALS];vec4 extinction[NUM_MATERIALS];vec4 specularColorGlossiness[NUM_MATERIALS];
#if defined(NUM_DIFFUSE_MAPS) || defined(NUM_NORMAL_MAPS) || defined(NUM_PBR_MAPS)
ivec4 diffuseNormalRoughnessMetalnessMapIndex[NUM_MATERIALS];
#endif
#if defined(NUM_EMISSIVE_MAPS) || defined(NUM_PBR_SG_MAPS)
ivec4 emissiveSpecularGlossinessMapIndex[NUM_MATERIALS];
#endif
#if defined(NUM_DIFFUSE_MAPS) || defined(NUM_NORMAL_MAPS)
vec4 diffuseNormalMapSize[NUM_DIFFUSE_NORMAL_MAPS];
#endif
#if defined(NUM_PBR_MAPS)
vec2 pbrMapSize[NUM_PBR_MAPS];
#else
#if defined(NUM_PBR_SG_MAPS)
vec2 pbrMapSize[NUM_PBR_SG_MAPS];
#else
#if defined(NUM_EMISSIVE_MAPS)
vec2 pbrMapSize[NUM_EMISSIVE_MAPS];
#endif
#endif
#endif
}materials;
#ifdef NUM_DIFFUSE_MAPS
uniform mediump sampler2DArray diffuseMap;
#endif
#ifdef NUM_NORMAL_MAPS
uniform mediump sampler2DArray normalMap;
#endif
#ifdef NUM_PBR_MAPS
uniform mediump sampler2DArray pbrMap;
#endif
#ifdef NUM_PBR_SG_MAPS
uniform mediump sampler2DArray pbrSGMap;
#endif
#ifdef NUM_EMISSIVE_MAPS
uniform mediump sampler2DArray emissiveMap;
#endif
float LGL_k(int materialIndex){return materials.colorAndMaterialType[materialIndex].w;}float LGL_l(int materialIndex){return materials.iorAtDistanceAnisotropicWorkflow[materialIndex].w;}vec3 LGL_m(int materialIndex,vec2 uv){vec3 emissive=vec3(0.0);
#ifdef NUM_EMISSIVE_MAPS
int emissiveMapIndex=materials.emissiveSpecularGlossinessMapIndex[materialIndex].x;if(emissiveMapIndex>=0){emissive=texture(emissiveMap,vec3(uv*materials.pbrMapSize[emissiveMapIndex].xy,emissiveMapIndex)).rgb;}
#endif
return emissive;}vec3 LGL_n(int materialIndex,vec2 uv){vec3 specularColor=materials.specularColorGlossiness[materialIndex].rgb;
#ifdef NUM_PBR_SG_MAPS
int specularMapIndex=materials.emissiveSpecularGlossinessMapIndex[materialIndex].y;if(specularMapIndex>=0){vec3 texelSpecular=texture(pbrSGMap,vec3(uv*materials.pbrMapSize[specularMapIndex].xy,specularMapIndex)).rgb;texelSpecular=pow(texelSpecular,vec3(2.2));specularColor*=texelSpecular;}
#endif
return specularColor;}float LGL_o(int materialIndex,vec2 uv){float glossiness=materials.specularColorGlossiness[materialIndex].a;
#ifdef NUM_PBR_SG_MAPS
int glossinessMapIndex=materials.emissiveSpecularGlossinessMapIndex[materialIndex].z;if(glossinessMapIndex>=0){float texelGlossiness=texture(pbrSGMap,vec3(uv*materials.pbrMapSize[glossinessMapIndex].xy,glossinessMapIndex)).a;glossiness*=texelGlossiness;}
#endif
return glossiness;}float LGL_p(int materialIndex,vec2 uv){float workflow=LGL_l(materialIndex);float roughness=0.0;if(workflow>0.1){roughness=1.0-LGL_o(materialIndex,uv);}else{roughness=materials.roughnessMetalnessNormalScale[materialIndex].x;
#ifdef NUM_PBR_MAPS
int roughnessMapIndex=materials.diffuseNormalRoughnessMetalnessMapIndex[materialIndex].z;if(roughnessMapIndex>=0){roughness*=texture(pbrMap,vec3(uv*materials.pbrMapSize[roughnessMapIndex].xy,roughnessMapIndex)).g;}
#endif
}return roughness*roughness;}float LGL_q(const vec3 v){return max(v.x,max(v.y,v.z));}float LGL_r(const vec3 specularColor){return LGL_q(specularColor);}vec3 LGL_s(const vec3 baseColor,float metallic){return baseColor*(1.0-metallic);}float LGL_t(int materialIndex,vec2 uv){float workflow=LGL_l(materialIndex);float metalness=0.0;if(workflow>0.1){vec3 specularFactor=LGL_n(materialIndex,uv);metalness=LGL_r(specularFactor);}else{metalness=materials.roughnessMetalnessNormalScale[materialIndex].y;
#ifdef NUM_PBR_MAPS
int metalnessMapIndex=materials.diffuseNormalRoughnessMetalnessMapIndex[materialIndex].w;if(metalnessMapIndex>=0){metalness*=texture(pbrMap,vec3(uv*materials.pbrMapSize[metalnessMapIndex].xy,metalnessMapIndex)).b;}
#endif
}return metalness;}vec3 LGL_u(int materialIndex,vec2 uv){vec3 color=materials.colorAndMaterialType[materialIndex].rgb;
#ifdef NUM_DIFFUSE_MAPS
int diffuseMapIndex=materials.diffuseNormalRoughnessMetalnessMapIndex[materialIndex].x;if(diffuseMapIndex>=0){color*=texture(diffuseMap,vec3(uv*materials.diffuseNormalMapSize[diffuseMapIndex].xy,diffuseMapIndex)).rgb;}
#endif
float workflow=LGL_l(materialIndex);if(workflow>0.1){vec3 specularFactor=LGL_n(materialIndex,uv);color=LGL_s(color,LGL_r(specularFactor));}return color;}vec3 LGL_v(int materialIndex,vec2 uv,vec3 normal,vec3 dp1,vec3 dp2,vec2 duv1,vec2 duv2,inout vec3 tangent,inout vec3 bitangent){vec3 dp2perp=cross(dp2,normal);vec3 dp1perp=cross(normal,dp1);vec3 dpdu=dp2perp*duv1.x+dp1perp*duv2.x;vec3 dpdv=dp2perp*duv1.y+dp1perp*duv2.y;float invmax=inversesqrt(max(dot(dpdu,dpdu),dot(dpdv,dpdv)));dpdu*=invmax;dpdv*=invmax;tangent=normalize(dpdu);bitangent=normalize(dpdv);
#ifdef NUM_NORMAL_MAPS
int normalMapIndex=materials.diffuseNormalRoughnessMetalnessMapIndex[materialIndex].y;if(normalMapIndex>=0){vec3 n=2.0*texture(normalMap,vec3(uv*materials.diffuseNormalMapSize[normalMapIndex].zw,normalMapIndex)).rgb-1.0;n.xy*=materials.roughnessMetalnessNormalScale[materialIndex].zw;mat3 tbn=mat3(dpdu,dpdv,normal);return normalize(tbn*n);}else{return normal;}
#endif
return normal;}float LGL_w(int materialIndex){return materials.specularTintSheenSheenTint[materialIndex].y;}float LGL_x(int materialIndex){return materials.specularTintSheenSheenTint[materialIndex].z;}float LGL_xTint(int materialIndex){return materials.specularTintSheenSheenTint[materialIndex].w;}float LGL_z(int materialIndex){return materials.clearcoaRoughnessSubfaceTransmission[materialIndex].x;}float LGL_zRoughness(int materialIndex){return materials.clearcoaRoughnessSubfaceTransmission[materialIndex].y;}float LGL_AB(int materialIndex){return materials.clearcoaRoughnessSubfaceTransmission[materialIndex].z;}float LGL_AC(int materialIndex){return materials.clearcoaRoughnessSubfaceTransmission[materialIndex].w;}float LGL_AD(int materialIndex){return materials.iorAtDistanceAnisotropicWorkflow[materialIndex].x;}float LGL_AE(int materialIndex){return materials.iorAtDistanceAnisotropicWorkflow[materialIndex].y;}float LGL_AF(int materialIndex){return materials.iorAtDistanceAnisotropicWorkflow[materialIndex].z;}vec3 LGL_AG(int materialIndex){return materials.extinction[materialIndex].rgb;}layout(location=0)out vec4 out_position;layout(location=1)out vec4 out_normal;layout(location=2)out vec4 out_color;in vec3 vPosition;in vec3 vNormal;in vec2 vUv;flat in ivec2 vMaterialMeshIndex;vec3 faceNormals(vec3 pos){vec3 fdx=dFdx(pos);vec3 fdy=dFdy(pos);return cross(fdx,fdy);}void main(){int materialIndex=vMaterialMeshIndex.x;int meshIndex=vMaterialMeshIndex.y;vec2 uv=fract(vUv);vec3 color=LGL_u(materialIndex,uv);float materialType=LGL_k(materialIndex);vec3 normal=normalize(vNormal);vec3 faceNormal=normalize(faceNormals(vPosition));normal*=sign(dot(normal,faceNormal));
#ifdef NUM_NORMAL_MAPS
vec3 dp1=dFdx(vPosition);vec3 dp2=dFdy(vPosition);vec2 duv1=dFdx(vUv);vec2 duv2=dFdy(vUv);vec3 tangent,bitangent;normal=LGL_v(materialIndex,uv,normal,dp1,dp2,duv1,duv2,tangent,bitangent);
#endif
out_position=vec4(vPosition,float(meshIndex)+EPS);out_normal=vec4(normal,materialType);out_color=vec4(color,0.);}`};function st(a,e,t){if(e===void 0)return;const{itemSize:n,array:i}=t;if(a.enableVertexAttribArray(e),a.bindBuffer(a.ARRAY_BUFFER,a.createBuffer()),a.bufferData(a.ARRAY_BUFFER,i,a.STATIC_DRAW),i instanceof Float32Array)a.vertexAttribPointer(e,n,a.FLOAT,!1,0,0);else if(i instanceof Int32Array)a.vertexAttribIPointer(e,n,a.INT,0,0);else throw"Unsupported buffer type"}function zi(a,e,t){st(a,e.attribLocs.aPosition,t.getAttribute("position")),st(a,e.attribLocs.aNormal,t.getAttribute("normal")),st(a,e.attribLocs.aUv,t.getAttribute("uv")),st(a,e.attribLocs.aMaterialMeshIndex,t.getAttribute("materialMeshIndex")),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,a.createBuffer()),a.bufferData(a.ELEMENT_ARRAY_BUFFER,t.getIndex().array,a.STATIC_DRAW)}function Bi(a,{materialBuffer:e,mergedMesh:t}){const n=Ae(a,{defines:e.defines,vertex:ki,fragment:Oi});n.setTexture("diffuseMap",e.textures.diffuseMap),n.setTexture("normalMap",e.textures.normalMap);const i=t.geometry,s=i.getIndex().count,o=a.createVertexArray();a.bindVertexArray(o),zi(a,n,i),a.bindVertexArray(null);let r=0,l=0;function c(L,x){r=L,l=x}let u;function f(L){u=L}let d=new tt;function p(){d.copy(u.projectionMatrix),d.elements[8]+=2*r,d.elements[9]+=2*l,d.multiply(u.matrixWorldInverse),n.setUniform("projView",d.elements)}function h(){p(),a.bindVertexArray(o),n.useProgram(),a.enable(a.DEPTH_TEST),a.drawElements(a.TRIANGLES,s,a.UNSIGNED_INT,0),a.disable(a.DEPTH_TEST)}return{draw:h,outputLocs:n.outputLocs,setCamera:f,setJitter:c}}var Hi={source:`vec4 LGL_Ag(sampler2D map,vec2 uv){
#ifdef OES_texture_float_linear
return texture(map,uv);
#else
vec2 size=vec2(textureSize(map,0));vec2 texelSize=1.0/size;uv=uv*size-0.5;vec2 f=fract(uv);uv=floor(uv)+0.5;vec4 s1=texture(map,(uv+vec2(0,0))*texelSize);vec4 s2=texture(map,(uv+vec2(1,0))*texelSize);vec4 s3=texture(map,(uv+vec2(0,1))*texelSize);vec4 s4=texture(map,(uv+vec2(1,1))*texelSize);return mix(mix(s1,s2,f.x),mix(s3,s4,f.x),f.y);
#endif
}layout(location=0)out vec4 out_color;in vec2 vCoord;uniform sampler2D lightTex;uniform vec2 lightScale;uniform int toneMappingFun;vec3 linear(vec3 color){return color;}vec3 LGL_Ao(vec3 color){return clamp(color/(vec3(1.0)+color),vec3(0.0),vec3(1.0));}vec3 LGL_Ap(vec3 color){color=max(vec3(0.0),color-0.004);return pow((color*(6.2*color+0.5))/(color*(6.2*color+1.7)+0.06),vec3(2.2));}vec3 LGL_Aq(vec3 color){return clamp((color*(2.51*color+0.03))/(color*(2.43*color+0.59)+0.14),vec3(0.0),vec3(1.0));}void main(){vec4 upscaledLight=texture(lightTex,lightScale*vCoord);vec3 light=upscaledLight.rgb/upscaledLight.a;if(toneMappingFun==0){light=linear(light);}if(toneMappingFun==1){light=LGL_Aq(light);}if(toneMappingFun==2){light=LGL_Ao(light);}if(toneMappingFun==3){light=LGL_Ap(light);}light=pow(light,vec3(1.0/2.2));out_color=vec4(light,1.0);}`};const Ln={[Zt]:0,[zn]:1,[Bn]:2,[Hn]:3};function Vi(a,e){const{fullscreenQuad:t,toneMapping:n}=e;let i;function s(d,p){i=(()=>De(a,{color:{0:Z(a,{width:d,height:p,storage:"byte",magFilter:a.LINEAR,minFilter:a.LINEAR})}}))()}const o={gl:a,vertex:t.vertexShader,fragment:Hi},r=Ae(a,o);r.setUniform("toneMappingFun",Ln[n]);const l=new V(1,1);function c(d,p){let{light:h,lightScale:L}=d;if(L=L||l,r.setTexture("lightTex",h),r.setUniform("lightScale",L.x,L.y),p)return i.bind(),a.clear(a.COLOR_BUFFER_BIT),a.viewport(0,0,a.drawingBufferWidth,a.drawingBufferHeight),r.useProgram(),t.draw(),i.unbind(),i;r.useProgram(),t.draw()}function u(d,p){s(d,p)}function f(d){r.setUniform("toneMappingFun",Ln[d])}return{draw:c,setToneMapping:f,setSize:u}}var Yi={source:`layout(location=0)out vec4 out_color;uniform sampler2D inputBuffer;uniform vec2 resolution;in vec2 vCoord;
#define FXAA_PC 1
#define FXAA_GLSL_100 1
#define FXAA_QUALITY_PRESET 12
#define FXAA_GREEN_AS_LUMA 1
#ifndef FXAA_PC_CONSOLE
#define FXAA_PC_CONSOLE 0
#endif
#ifndef FXAA_GLSL_120
#define FXAA_GLSL_120 0
#endif
#ifndef FXAA_GLSL_130
#define FXAA_GLSL_130 0
#endif
#ifndef FXAA_HLSL_3
#define FXAA_HLSL_3 0
#endif
#ifndef FXAA_HLSL_4
#define FXAA_HLSL_4 0
#endif
#ifndef FXAA_HLSL_5
#define FXAA_HLSL_5 0
#endif
#ifndef FXAA_GREEN_AS_LUMA
#define FXAA_GREEN_AS_LUMA 0
#endif
#ifndef FXAA_EARLY_EXIT
#define FXAA_EARLY_EXIT 1
#endif
#ifndef FXAA_DISCARD
#define FXAA_DISCARD 0
#endif
#ifndef FXAA_FAST_PIXEL_OFFSET
#ifdef GL_EXT_gpu_shader4
#define FXAA_FAST_PIXEL_OFFSET 1
#endif
#ifdef GL_NV_gpu_shader5
#define FXAA_FAST_PIXEL_OFFSET 1
#endif
#ifdef GL_ARB_gpu_shader5
#define FXAA_FAST_PIXEL_OFFSET 1
#endif
#ifndef FXAA_FAST_PIXEL_OFFSET
#define FXAA_FAST_PIXEL_OFFSET 0
#endif
#endif
#ifndef FXAA_GATHER4_ALPHA
#if (FXAA_HLSL_5 == 1)
#define FXAA_GATHER4_ALPHA 1
#endif
#ifdef GL_ARB_gpu_shader5
#define FXAA_GATHER4_ALPHA 1
#endif
#ifdef GL_NV_gpu_shader5
#define FXAA_GATHER4_ALPHA 1
#endif
#ifndef FXAA_GATHER4_ALPHA
#define FXAA_GATHER4_ALPHA 0
#endif
#endif
/*============================================================================FXAA QUALITY-TUNING KNOBS------------------------------------------------------------------------------NOTE the other tuning knobs are now in the shader function inputs!============================================================================*/
#ifndef FXAA_QUALITY_PRESET
#define FXAA_QUALITY_PRESET 12
#endif
/*============================================================================FXAA QUALITY-PRESETS============================================================================*//*============================================================================FXAA QUALITY-MEDIUM DITHER PRESETS============================================================================*/
#if (FXAA_QUALITY_PRESET == 10)
#define FXAA_QUALITY_PS 3
#define FXAA_QUALITY_P0 1.5
#define FXAA_QUALITY_P1 3.0
#define FXAA_QUALITY_P2 12.0
#endif
#if (FXAA_QUALITY_PRESET == 11)
#define FXAA_QUALITY_PS 4
#define FXAA_QUALITY_P0 1.0
#define FXAA_QUALITY_P1 1.5
#define FXAA_QUALITY_P2 3.0
#define FXAA_QUALITY_P3 12.0
#endif
#if (FXAA_QUALITY_PRESET == 12)
#define FXAA_QUALITY_PS 5
#define FXAA_QUALITY_P0 1.0
#define FXAA_QUALITY_P1 1.5
#define FXAA_QUALITY_P2 2.0
#define FXAA_QUALITY_P3 4.0
#define FXAA_QUALITY_P4 12.0
#endif
#if (FXAA_QUALITY_PRESET == 13)
#define FXAA_QUALITY_PS 6
#define FXAA_QUALITY_P0 1.0
#define FXAA_QUALITY_P1 1.5
#define FXAA_QUALITY_P2 2.0
#define FXAA_QUALITY_P3 2.0
#define FXAA_QUALITY_P4 4.0
#define FXAA_QUALITY_P5 12.0
#endif
#if (FXAA_QUALITY_PRESET == 14)
#define FXAA_QUALITY_PS 7
#define FXAA_QUALITY_P0 1.0
#define FXAA_QUALITY_P1 1.5
#define FXAA_QUALITY_P2 2.0
#define FXAA_QUALITY_P3 2.0
#define FXAA_QUALITY_P4 2.0
#define FXAA_QUALITY_P5 4.0
#define FXAA_QUALITY_P6 12.0
#endif
#if (FXAA_QUALITY_PRESET == 15)
#define FXAA_QUALITY_PS 8
#define FXAA_QUALITY_P0 1.0
#define FXAA_QUALITY_P1 1.5
#define FXAA_QUALITY_P2 2.0
#define FXAA_QUALITY_P3 2.0
#define FXAA_QUALITY_P4 2.0
#define FXAA_QUALITY_P5 2.0
#define FXAA_QUALITY_P6 4.0
#define FXAA_QUALITY_P7 12.0
#endif
/*============================================================================FXAA QUALITY-LOW DITHER PRESETS============================================================================*/
#if (FXAA_QUALITY_PRESET == 20)
#define FXAA_QUALITY_PS 3
#define FXAA_QUALITY_P0 1.5
#define FXAA_QUALITY_P1 2.0
#define FXAA_QUALITY_P2 8.0
#endif
#if (FXAA_QUALITY_PRESET == 21)
#define FXAA_QUALITY_PS 4
#define FXAA_QUALITY_P0 1.0
#define FXAA_QUALITY_P1 1.5
#define FXAA_QUALITY_P2 2.0
#define FXAA_QUALITY_P3 8.0
#endif
#if (FXAA_QUALITY_PRESET == 22)
#define FXAA_QUALITY_PS 5
#define FXAA_QUALITY_P0 1.0
#define FXAA_QUALITY_P1 1.5
#define FXAA_QUALITY_P2 2.0
#define FXAA_QUALITY_P3 2.0
#define FXAA_QUALITY_P4 8.0
#endif
#if (FXAA_QUALITY_PRESET == 23)
#define FXAA_QUALITY_PS 6
#define FXAA_QUALITY_P0 1.0
#define FXAA_QUALITY_P1 1.5
#define FXAA_QUALITY_P2 2.0
#define FXAA_QUALITY_P3 2.0
#define FXAA_QUALITY_P4 2.0
#define FXAA_QUALITY_P5 8.0
#endif
#if (FXAA_QUALITY_PRESET == 24)
#define FXAA_QUALITY_PS 7
#define FXAA_QUALITY_P0 1.0
#define FXAA_QUALITY_P1 1.5
#define FXAA_QUALITY_P2 2.0
#define FXAA_QUALITY_P3 2.0
#define FXAA_QUALITY_P4 2.0
#define FXAA_QUALITY_P5 3.0
#define FXAA_QUALITY_P6 8.0
#endif
#if (FXAA_QUALITY_PRESET == 25)
#define FXAA_QUALITY_PS 8
#define FXAA_QUALITY_P0 1.0
#define FXAA_QUALITY_P1 1.5
#define FXAA_QUALITY_P2 2.0
#define FXAA_QUALITY_P3 2.0
#define FXAA_QUALITY_P4 2.0
#define FXAA_QUALITY_P5 2.0
#define FXAA_QUALITY_P6 4.0
#define FXAA_QUALITY_P7 8.0
#endif
#if (FXAA_QUALITY_PRESET == 26)
#define FXAA_QUALITY_PS 9
#define FXAA_QUALITY_P0 1.0
#define FXAA_QUALITY_P1 1.5
#define FXAA_QUALITY_P2 2.0
#define FXAA_QUALITY_P3 2.0
#define FXAA_QUALITY_P4 2.0
#define FXAA_QUALITY_P5 2.0
#define FXAA_QUALITY_P6 2.0
#define FXAA_QUALITY_P7 4.0
#define FXAA_QUALITY_P8 8.0
#endif
#if (FXAA_QUALITY_PRESET == 27)
#define FXAA_QUALITY_PS 10
#define FXAA_QUALITY_P0 1.0
#define FXAA_QUALITY_P1 1.5
#define FXAA_QUALITY_P2 2.0
#define FXAA_QUALITY_P3 2.0
#define FXAA_QUALITY_P4 2.0
#define FXAA_QUALITY_P5 2.0
#define FXAA_QUALITY_P6 2.0
#define FXAA_QUALITY_P7 2.0
#define FXAA_QUALITY_P8 4.0
#define FXAA_QUALITY_P9 8.0
#endif
#if (FXAA_QUALITY_PRESET == 28)
#define FXAA_QUALITY_PS 11
#define FXAA_QUALITY_P0 1.0
#define FXAA_QUALITY_P1 1.5
#define FXAA_QUALITY_P2 2.0
#define FXAA_QUALITY_P3 2.0
#define FXAA_QUALITY_P4 2.0
#define FXAA_QUALITY_P5 2.0
#define FXAA_QUALITY_P6 2.0
#define FXAA_QUALITY_P7 2.0
#define FXAA_QUALITY_P8 2.0
#define FXAA_QUALITY_P9 4.0
#define FXAA_QUALITY_P10 8.0
#endif
#if (FXAA_QUALITY_PRESET == 29)
#define FXAA_QUALITY_PS 12
#define FXAA_QUALITY_P0 1.0
#define FXAA_QUALITY_P1 1.5
#define FXAA_QUALITY_P2 2.0
#define FXAA_QUALITY_P3 2.0
#define FXAA_QUALITY_P4 2.0
#define FXAA_QUALITY_P5 2.0
#define FXAA_QUALITY_P6 2.0
#define FXAA_QUALITY_P7 2.0
#define FXAA_QUALITY_P8 2.0
#define FXAA_QUALITY_P9 2.0
#define FXAA_QUALITY_P10 4.0
#define FXAA_QUALITY_P11 8.0
#endif
/*============================================================================FXAA QUALITY-EXTREME QUALITY============================================================================*/
#if (FXAA_QUALITY_PRESET == 39)
#define FXAA_QUALITY_PS 12
#define FXAA_QUALITY_P0 1.0
#define FXAA_QUALITY_P1 1.0
#define FXAA_QUALITY_P2 1.0
#define FXAA_QUALITY_P3 1.0
#define FXAA_QUALITY_P4 1.0
#define FXAA_QUALITY_P5 1.5
#define FXAA_QUALITY_P6 2.0
#define FXAA_QUALITY_P7 2.0
#define FXAA_QUALITY_P8 2.0
#define FXAA_QUALITY_P9 2.0
#define FXAA_QUALITY_P10 4.0
#define FXAA_QUALITY_P11 8.0
#endif
/*============================================================================API PORTING============================================================================*/
#if (FXAA_GLSL_100 == 1) || (FXAA_GLSL_120 == 1) || (FXAA_GLSL_130 == 1)
#define FxaaBool bool
#define FxaaDiscard discard
#define FxaaFloat float
#define FxaaFloat2 vec2
#define FxaaFloat3 vec3
#define FxaaFloat4 vec4
#define FxaaHalf float
#define FxaaHalf2 vec2
#define FxaaHalf3 vec3
#define FxaaHalf4 vec4
#define FxaaInt2 ivec2
#define FxaaSat(x) clamp(x, 0.0, 1.0)
#define FxaaTex sampler2D
#else
#define FxaaBool bool
#define FxaaDiscard clip(-1)
#define FxaaFloat float
#define FxaaFloat2 float2
#define FxaaFloat3 float3
#define FxaaFloat4 float4
#define FxaaHalf half
#define FxaaHalf2 half2
#define FxaaHalf3 half3
#define FxaaHalf4 half4
#define FxaaSat(x) saturate(x)
#endif
#if (FXAA_GLSL_100 == 1)
#define FxaaTexTop(t, p) texture(t, p, 0.0)
#define FxaaTexOff(t, p, o, r) texture(t, p + (o * r), 0.0)
#endif
#if (FXAA_GLSL_120 == 1)
#define FxaaTexTop(t, p) textureLod(t, p, 0.0)
#if (FXAA_FAST_PIXEL_OFFSET == 1)
#define FxaaTexOff(t, p, o, r) textureLodOffset(t, p, 0.0, o)
#else
#define FxaaTexOff(t, p, o, r) textureLod(t, p + (o * r), 0.0)
#endif
#if (FXAA_GATHER4_ALPHA == 1)
#define FxaaTexAlpha4(t, p) textureGather(t, p, 3)
#define FxaaTexOffAlpha4(t, p, o) textureGatherOffset(t, p, o, 3)
#define FxaaTexGreen4(t, p) textureGather(t, p, 1)
#define FxaaTexOffGreen4(t, p, o) textureGatherOffset(t, p, o, 1)
#endif
#endif
#if (FXAA_GLSL_130 == 1)
#define FxaaTexTop(t, p) textureLod(t, p, 0.0)
#define FxaaTexOff(t, p, o, r) textureLodOffset(t, p, 0.0, o)
#if (FXAA_GATHER4_ALPHA == 1)
#define FxaaTexAlpha4(t, p) textureGather(t, p, 3)
#define FxaaTexOffAlpha4(t, p, o) textureGatherOffset(t, p, o, 3)
#define FxaaTexGreen4(t, p) textureGather(t, p, 1)
#define FxaaTexOffGreen4(t, p, o) textureGatherOffset(t, p, o, 1)
#endif
#endif
#if (FXAA_HLSL_3 == 1)
#define FxaaInt2 float2
#define FxaaTex sampler2D
#define FxaaTexTop(t, p) tex2Dlod(t, float4(p, 0.0, 0.0))
#define FxaaTexOff(t, p, o, r) tex2Dlod(t, float4(p + (o * r), 0, 0))
#endif
#if (FXAA_HLSL_4 == 1)
#define FxaaInt2 int2
struct FxaaTex{SamplerState smpl;texture tex;};
#define FxaaTexTop(t, p) t.tex.SampleLevel(t.smpl, p, 0.0)
#define FxaaTexOff(t, p, o, r) t.tex.SampleLevel(t.smpl, p, 0.0, o)
#endif
#if (FXAA_HLSL_5 == 1)
#define FxaaInt2 int2
struct FxaaTex{SamplerState smpl;texture tex;};
#define FxaaTexTop(t, p) t.tex.SampleLevel(t.smpl, p, 0.0)
#define FxaaTexOff(t, p, o, r) t.tex.SampleLevel(t.smpl, p, 0.0, o)
#define FxaaTexAlpha4(t, p) t.tex.GatherAlpha(t.smpl, p)
#define FxaaTexOffAlpha4(t, p, o) t.tex.GatherAlpha(t.smpl, p, o)
#define FxaaTexGreen4(t, p) t.tex.GatherGreen(t.smpl, p)
#define FxaaTexOffGreen4(t, p, o) t.tex.GatherGreen(t.smpl, p, o)
#endif
/*============================================================================GREEN AS LUMA OPTION SUPPORT FUNCTION============================================================================*/
#if (FXAA_GREEN_AS_LUMA == 0)
FxaaFloat FxaaLuma(FxaaFloat4 rgba){return rgba.w;}
#else
FxaaFloat FxaaLuma(FxaaFloat4 rgba){return rgba.y;}
#endif
/*============================================================================FXAA3 QUALITY-PC============================================================================*/
#if (FXAA_PC == 1)
FxaaFloat4 FxaaPixelShader(FxaaFloat2 pos,FxaaFloat4 fxaaConsolePosPos,FxaaTex tex,FxaaTex fxaaConsole360TexExpBiasNegOne,FxaaTex fxaaConsole360TexExpBiasNegTwo,FxaaFloat2 fxaaQualityRcpFrame,FxaaFloat4 fxaaConsoleRcpFrameOpt,FxaaFloat4 fxaaConsoleRcpFrameOpt2,FxaaFloat4 fxaaConsole360RcpFrameOpt2,FxaaFloat fxaaQualitySubpix,FxaaFloat fxaaQualityEdgeThreshold,FxaaFloat fxaaQualityEdgeThresholdMin,FxaaFloat fxaaConsoleEdgeSharpness,FxaaFloat fxaaConsoleEdgeThreshold,FxaaFloat fxaaConsoleEdgeThresholdMin,FxaaFloat4 fxaaConsole360ConstDir){FxaaFloat2 posM;posM.x=pos.x;posM.y=pos.y;
#if (FXAA_GATHER4_ALPHA == 1)
#if (FXAA_DISCARD == 0)
FxaaFloat4 rgbyM=FxaaTexTop(tex,posM);
#if (FXAA_GREEN_AS_LUMA == 0)
#define lumaM rgbyM.w
#else
#define lumaM rgbyM.y
#endif
#endif
#if (FXAA_GREEN_AS_LUMA == 0)
FxaaFloat4 luma4A=FxaaTexAlpha4(tex,posM);FxaaFloat4 luma4B=FxaaTexOffAlpha4(tex,posM,FxaaInt2(-1,-1));
#else
FxaaFloat4 luma4A=FxaaTexGreen4(tex,posM);FxaaFloat4 luma4B=FxaaTexOffGreen4(tex,posM,FxaaInt2(-1,-1));
#endif
#if (FXAA_DISCARD == 1)
#define lumaM luma4A.w
#endif
#define lumaE luma4A.z
#define lumaS luma4A.x
#define lumaSE luma4A.y
#define lumaNW luma4B.w
#define lumaN luma4B.z
#define lumaW luma4B.x
#else
FxaaFloat4 rgbyM=FxaaTexTop(tex,posM);
#if (FXAA_GREEN_AS_LUMA == 0)
#define lumaM rgbyM.w
#else
#define lumaM rgbyM.y
#endif
#if (FXAA_GLSL_100 == 1)
FxaaFloat lumaS=FxaaLuma(FxaaTexOff(tex,posM,FxaaFloat2(0.0,1.0),fxaaQualityRcpFrame.xy));FxaaFloat lumaE=FxaaLuma(FxaaTexOff(tex,posM,FxaaFloat2(1.0,0.0),fxaaQualityRcpFrame.xy));FxaaFloat lumaN=FxaaLuma(FxaaTexOff(tex,posM,FxaaFloat2(0.0,-1.0),fxaaQualityRcpFrame.xy));FxaaFloat lumaW=FxaaLuma(FxaaTexOff(tex,posM,FxaaFloat2(-1.0,0.0),fxaaQualityRcpFrame.xy));
#else
FxaaFloat lumaS=FxaaLuma(FxaaTexOff(tex,posM,FxaaInt2(0,1),fxaaQualityRcpFrame.xy));FxaaFloat lumaE=FxaaLuma(FxaaTexOff(tex,posM,FxaaInt2(1,0),fxaaQualityRcpFrame.xy));FxaaFloat lumaN=FxaaLuma(FxaaTexOff(tex,posM,FxaaInt2(0,-1),fxaaQualityRcpFrame.xy));FxaaFloat lumaW=FxaaLuma(FxaaTexOff(tex,posM,FxaaInt2(-1,0),fxaaQualityRcpFrame.xy));
#endif
#endif
FxaaFloat maxSM=max(lumaS,lumaM);FxaaFloat minSM=min(lumaS,lumaM);FxaaFloat maxESM=max(lumaE,maxSM);FxaaFloat minESM=min(lumaE,minSM);FxaaFloat maxWN=max(lumaN,lumaW);FxaaFloat minWN=min(lumaN,lumaW);FxaaFloat rangeMax=max(maxWN,maxESM);FxaaFloat rangeMin=min(minWN,minESM);FxaaFloat rangeMaxScaled=rangeMax*fxaaQualityEdgeThreshold;FxaaFloat range=rangeMax-rangeMin;FxaaFloat rangeMaxClamped=max(fxaaQualityEdgeThresholdMin,rangeMaxScaled);FxaaBool earlyExit=range<rangeMaxClamped;if(earlyExit)
#if (FXAA_DISCARD == 1)
FxaaDiscard;
#else
return rgbyM;
#endif
#if (FXAA_GATHER4_ALPHA == 0)
#if (FXAA_GLSL_100 == 1)
FxaaFloat lumaNW=FxaaLuma(FxaaTexOff(tex,posM,FxaaFloat2(-1.0,-1.0),fxaaQualityRcpFrame.xy));FxaaFloat lumaSE=FxaaLuma(FxaaTexOff(tex,posM,FxaaFloat2(1.0,1.0),fxaaQualityRcpFrame.xy));FxaaFloat lumaNE=FxaaLuma(FxaaTexOff(tex,posM,FxaaFloat2(1.0,-1.0),fxaaQualityRcpFrame.xy));FxaaFloat lumaSW=FxaaLuma(FxaaTexOff(tex,posM,FxaaFloat2(-1.0,1.0),fxaaQualityRcpFrame.xy));
#else
FxaaFloat lumaNW=FxaaLuma(FxaaTexOff(tex,posM,FxaaInt2(-1,-1),fxaaQualityRcpFrame.xy));FxaaFloat lumaSE=FxaaLuma(FxaaTexOff(tex,posM,FxaaInt2(1,1),fxaaQualityRcpFrame.xy));FxaaFloat lumaNE=FxaaLuma(FxaaTexOff(tex,posM,FxaaInt2(1,-1),fxaaQualityRcpFrame.xy));FxaaFloat lumaSW=FxaaLuma(FxaaTexOff(tex,posM,FxaaInt2(-1,1),fxaaQualityRcpFrame.xy));
#endif
#else
FxaaFloat lumaNE=FxaaLuma(FxaaTexOff(tex,posM,FxaaInt2(1,-1),fxaaQualityRcpFrame.xy));FxaaFloat lumaSW=FxaaLuma(FxaaTexOff(tex,posM,FxaaInt2(-1,1),fxaaQualityRcpFrame.xy));
#endif
FxaaFloat lumaNS=lumaN+lumaS;FxaaFloat lumaWE=lumaW+lumaE;FxaaFloat subpixRcpRange=1.0/range;FxaaFloat subpixNSWE=lumaNS+lumaWE;FxaaFloat edgeHorz1=(-2.0*lumaM)+lumaNS;FxaaFloat edgeVert1=(-2.0*lumaM)+lumaWE;FxaaFloat lumaNESE=lumaNE+lumaSE;FxaaFloat lumaNWNE=lumaNW+lumaNE;FxaaFloat edgeHorz2=(-2.0*lumaE)+lumaNESE;FxaaFloat edgeVert2=(-2.0*lumaN)+lumaNWNE;FxaaFloat lumaNWSW=lumaNW+lumaSW;FxaaFloat lumaSWSE=lumaSW+lumaSE;FxaaFloat edgeHorz4=(abs(edgeHorz1)*2.0)+abs(edgeHorz2);FxaaFloat edgeVert4=(abs(edgeVert1)*2.0)+abs(edgeVert2);FxaaFloat edgeHorz3=(-2.0*lumaW)+lumaNWSW;FxaaFloat edgeVert3=(-2.0*lumaS)+lumaSWSE;FxaaFloat edgeHorz=abs(edgeHorz3)+edgeHorz4;FxaaFloat edgeVert=abs(edgeVert3)+edgeVert4;FxaaFloat subpixNWSWNESE=lumaNWSW+lumaNESE;FxaaFloat lengthSign=fxaaQualityRcpFrame.x;FxaaBool horzSpan=edgeHorz>=edgeVert;FxaaFloat subpixA=subpixNSWE*2.0+subpixNWSWNESE;if(!horzSpan)lumaN=lumaW;if(!horzSpan)lumaS=lumaE;if(horzSpan)lengthSign=fxaaQualityRcpFrame.y;FxaaFloat subpixB=(subpixA*(1.0/12.0))-lumaM;FxaaFloat gradientN=lumaN-lumaM;FxaaFloat gradientS=lumaS-lumaM;FxaaFloat lumaNN=lumaN+lumaM;FxaaFloat lumaSS=lumaS+lumaM;FxaaBool pairN=abs(gradientN)>=abs(gradientS);FxaaFloat gradient=max(abs(gradientN),abs(gradientS));if(pairN)lengthSign=-lengthSign;FxaaFloat subpixC=FxaaSat(abs(subpixB)*subpixRcpRange);FxaaFloat2 posB;posB.x=posM.x;posB.y=posM.y;FxaaFloat2 offNP;offNP.x=(!horzSpan)? 0.0 : fxaaQualityRcpFrame.x;offNP.y=(horzSpan)? 0.0 : fxaaQualityRcpFrame.y;if(!horzSpan)posB.x+=lengthSign*0.5;if(horzSpan)posB.y+=lengthSign*0.5;FxaaFloat2 posN;posN.x=posB.x-offNP.x*FXAA_QUALITY_P0;posN.y=posB.y-offNP.y*FXAA_QUALITY_P0;FxaaFloat2 posP;posP.x=posB.x+offNP.x*FXAA_QUALITY_P0;posP.y=posB.y+offNP.y*FXAA_QUALITY_P0;FxaaFloat subpixD=((-2.0)*subpixC)+3.0;FxaaFloat lumaEndN=FxaaLuma(FxaaTexTop(tex,posN));FxaaFloat subpixE=subpixC*subpixC;FxaaFloat lumaEndP=FxaaLuma(FxaaTexTop(tex,posP));if(!pairN)lumaNN=lumaSS;FxaaFloat gradientScaled=gradient*1.0/4.0;FxaaFloat lumaMM=lumaM-lumaNN*0.5;FxaaFloat subpixF=subpixD*subpixE;FxaaBool lumaMLTZero=lumaMM<0.0;lumaEndN-=lumaNN*0.5;lumaEndP-=lumaNN*0.5;FxaaBool doneN=abs(lumaEndN)>=gradientScaled;FxaaBool doneP=abs(lumaEndP)>=gradientScaled;if(!doneN)posN.x-=offNP.x*FXAA_QUALITY_P1;if(!doneN)posN.y-=offNP.y*FXAA_QUALITY_P1;FxaaBool doneNP=(!doneN)||(!doneP);if(!doneP)posP.x+=offNP.x*FXAA_QUALITY_P1;if(!doneP)posP.y+=offNP.y*FXAA_QUALITY_P1;if(doneNP){if(!doneN)lumaEndN=FxaaLuma(FxaaTexTop(tex,posN.xy));if(!doneP)lumaEndP=FxaaLuma(FxaaTexTop(tex,posP.xy));if(!doneN)lumaEndN=lumaEndN-lumaNN*0.5;if(!doneP)lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if(!doneN)posN.x-=offNP.x*FXAA_QUALITY_P2;if(!doneN)posN.y-=offNP.y*FXAA_QUALITY_P2;doneNP=(!doneN)||(!doneP);if(!doneP)posP.x+=offNP.x*FXAA_QUALITY_P2;if(!doneP)posP.y+=offNP.y*FXAA_QUALITY_P2;
#if (FXAA_QUALITY_PS > 3)
if(doneNP){if(!doneN)lumaEndN=FxaaLuma(FxaaTexTop(tex,posN.xy));if(!doneP)lumaEndP=FxaaLuma(FxaaTexTop(tex,posP.xy));if(!doneN)lumaEndN=lumaEndN-lumaNN*0.5;if(!doneP)lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if(!doneN)posN.x-=offNP.x*FXAA_QUALITY_P3;if(!doneN)posN.y-=offNP.y*FXAA_QUALITY_P3;doneNP=(!doneN)||(!doneP);if(!doneP)posP.x+=offNP.x*FXAA_QUALITY_P3;if(!doneP)posP.y+=offNP.y*FXAA_QUALITY_P3;
#if (FXAA_QUALITY_PS > 4)
if(doneNP){if(!doneN)lumaEndN=FxaaLuma(FxaaTexTop(tex,posN.xy));if(!doneP)lumaEndP=FxaaLuma(FxaaTexTop(tex,posP.xy));if(!doneN)lumaEndN=lumaEndN-lumaNN*0.5;if(!doneP)lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if(!doneN)posN.x-=offNP.x*FXAA_QUALITY_P4;if(!doneN)posN.y-=offNP.y*FXAA_QUALITY_P4;doneNP=(!doneN)||(!doneP);if(!doneP)posP.x+=offNP.x*FXAA_QUALITY_P4;if(!doneP)posP.y+=offNP.y*FXAA_QUALITY_P4;
#if (FXAA_QUALITY_PS > 5)
if(doneNP){if(!doneN)lumaEndN=FxaaLuma(FxaaTexTop(tex,posN.xy));if(!doneP)lumaEndP=FxaaLuma(FxaaTexTop(tex,posP.xy));if(!doneN)lumaEndN=lumaEndN-lumaNN*0.5;if(!doneP)lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if(!doneN)posN.x-=offNP.x*FXAA_QUALITY_P5;if(!doneN)posN.y-=offNP.y*FXAA_QUALITY_P5;doneNP=(!doneN)||(!doneP);if(!doneP)posP.x+=offNP.x*FXAA_QUALITY_P5;if(!doneP)posP.y+=offNP.y*FXAA_QUALITY_P5;
#if (FXAA_QUALITY_PS > 6)
if(doneNP){if(!doneN)lumaEndN=FxaaLuma(FxaaTexTop(tex,posN.xy));if(!doneP)lumaEndP=FxaaLuma(FxaaTexTop(tex,posP.xy));if(!doneN)lumaEndN=lumaEndN-lumaNN*0.5;if(!doneP)lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if(!doneN)posN.x-=offNP.x*FXAA_QUALITY_P6;if(!doneN)posN.y-=offNP.y*FXAA_QUALITY_P6;doneNP=(!doneN)||(!doneP);if(!doneP)posP.x+=offNP.x*FXAA_QUALITY_P6;if(!doneP)posP.y+=offNP.y*FXAA_QUALITY_P6;
#if (FXAA_QUALITY_PS > 7)
if(doneNP){if(!doneN)lumaEndN=FxaaLuma(FxaaTexTop(tex,posN.xy));if(!doneP)lumaEndP=FxaaLuma(FxaaTexTop(tex,posP.xy));if(!doneN)lumaEndN=lumaEndN-lumaNN*0.5;if(!doneP)lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if(!doneN)posN.x-=offNP.x*FXAA_QUALITY_P7;if(!doneN)posN.y-=offNP.y*FXAA_QUALITY_P7;doneNP=(!doneN)||(!doneP);if(!doneP)posP.x+=offNP.x*FXAA_QUALITY_P7;if(!doneP)posP.y+=offNP.y*FXAA_QUALITY_P7;
#if (FXAA_QUALITY_PS > 8)
if(doneNP){if(!doneN)lumaEndN=FxaaLuma(FxaaTexTop(tex,posN.xy));if(!doneP)lumaEndP=FxaaLuma(FxaaTexTop(tex,posP.xy));if(!doneN)lumaEndN=lumaEndN-lumaNN*0.5;if(!doneP)lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if(!doneN)posN.x-=offNP.x*FXAA_QUALITY_P8;if(!doneN)posN.y-=offNP.y*FXAA_QUALITY_P8;doneNP=(!doneN)||(!doneP);if(!doneP)posP.x+=offNP.x*FXAA_QUALITY_P8;if(!doneP)posP.y+=offNP.y*FXAA_QUALITY_P8;
#if (FXAA_QUALITY_PS > 9)
if(doneNP){if(!doneN)lumaEndN=FxaaLuma(FxaaTexTop(tex,posN.xy));if(!doneP)lumaEndP=FxaaLuma(FxaaTexTop(tex,posP.xy));if(!doneN)lumaEndN=lumaEndN-lumaNN*0.5;if(!doneP)lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if(!doneN)posN.x-=offNP.x*FXAA_QUALITY_P9;if(!doneN)posN.y-=offNP.y*FXAA_QUALITY_P9;doneNP=(!doneN)||(!doneP);if(!doneP)posP.x+=offNP.x*FXAA_QUALITY_P9;if(!doneP)posP.y+=offNP.y*FXAA_QUALITY_P9;
#if (FXAA_QUALITY_PS > 10)
if(doneNP){if(!doneN)lumaEndN=FxaaLuma(FxaaTexTop(tex,posN.xy));if(!doneP)lumaEndP=FxaaLuma(FxaaTexTop(tex,posP.xy));if(!doneN)lumaEndN=lumaEndN-lumaNN*0.5;if(!doneP)lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if(!doneN)posN.x-=offNP.x*FXAA_QUALITY_P10;if(!doneN)posN.y-=offNP.y*FXAA_QUALITY_P10;doneNP=(!doneN)||(!doneP);if(!doneP)posP.x+=offNP.x*FXAA_QUALITY_P10;if(!doneP)posP.y+=offNP.y*FXAA_QUALITY_P10;
#if (FXAA_QUALITY_PS > 11)
if(doneNP){if(!doneN)lumaEndN=FxaaLuma(FxaaTexTop(tex,posN.xy));if(!doneP)lumaEndP=FxaaLuma(FxaaTexTop(tex,posP.xy));if(!doneN)lumaEndN=lumaEndN-lumaNN*0.5;if(!doneP)lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if(!doneN)posN.x-=offNP.x*FXAA_QUALITY_P11;if(!doneN)posN.y-=offNP.y*FXAA_QUALITY_P11;doneNP=(!doneN)||(!doneP);if(!doneP)posP.x+=offNP.x*FXAA_QUALITY_P11;if(!doneP)posP.y+=offNP.y*FXAA_QUALITY_P11;
#if (FXAA_QUALITY_PS > 12)
if(doneNP){if(!doneN)lumaEndN=FxaaLuma(FxaaTexTop(tex,posN.xy));if(!doneP)lumaEndP=FxaaLuma(FxaaTexTop(tex,posP.xy));if(!doneN)lumaEndN=lumaEndN-lumaNN*0.5;if(!doneP)lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if(!doneN)posN.x-=offNP.x*FXAA_QUALITY_P12;if(!doneN)posN.y-=offNP.y*FXAA_QUALITY_P12;doneNP=(!doneN)||(!doneP);if(!doneP)posP.x+=offNP.x*FXAA_QUALITY_P12;if(!doneP)posP.y+=offNP.y*FXAA_QUALITY_P12;}
#endif
}
#endif
}
#endif
}
#endif
}
#endif
}
#endif
}
#endif
}
#endif
}
#endif
}
#endif
}FxaaFloat dstN=posM.x-posN.x;FxaaFloat dstP=posP.x-posM.x;if(!horzSpan)dstN=posM.y-posN.y;if(!horzSpan)dstP=posP.y-posM.y;FxaaBool goodSpanN=(lumaEndN<0.0)!=lumaMLTZero;FxaaFloat spanLength=(dstP+dstN);FxaaBool goodSpanP=(lumaEndP<0.0)!=lumaMLTZero;FxaaFloat spanLengthRcp=1.0/spanLength;FxaaBool directionN=dstN<dstP;FxaaFloat dst=min(dstN,dstP);FxaaBool goodSpan=directionN ? goodSpanN : goodSpanP;FxaaFloat subpixG=subpixF*subpixF;FxaaFloat pixelOffset=(dst*(-spanLengthRcp))+0.5;FxaaFloat subpixH=subpixG*fxaaQualitySubpix;FxaaFloat pixelOffsetGood=goodSpan ? pixelOffset : 0.0;FxaaFloat pixelOffsetSubpix=max(pixelOffsetGood,subpixH);if(!horzSpan)posM.x+=pixelOffsetSubpix*lengthSign;if(horzSpan)posM.y+=pixelOffsetSubpix*lengthSign;
#if (FXAA_DISCARD == 1)
return FxaaTexTop(tex,posM);
#else
return FxaaFloat4(FxaaTexTop(tex,posM).xyz,lumaM);
#endif
}
#endif
void main(){out_color=FxaaPixelShader(vCoord,vec4(0.0),inputBuffer,inputBuffer,inputBuffer,resolution,vec4(0.0),vec4(0.0),vec4(0.0),0.75,0.166,0.0833,0.0,0.0,0.0,vec4(0.0));out_color.a=texture(inputBuffer,vCoord).a;}`};function Wi(a,e){const{fullscreenQuad:t}=e,n={gl:a,vertex:t.vertexShader,fragment:Yi};function i(r,l){s.setUniform("resolution",1/r,1/l)}const s=Ae(a,n);function o(r){let{light:l}=r;s.setTexture("inputBuffer",l),s.useProgram(),t.draw()}return{draw:o,setSize:i}}var Qi={source:`vec4 LGL_Ag(sampler2D map,vec2 uv){
#ifdef OES_texture_float_linear
return texture(map,uv);
#else
vec2 size=vec2(textureSize(map,0));vec2 texelSize=1.0/size;uv=uv*size-0.5;vec2 f=fract(uv);uv=floor(uv)+0.5;vec4 s1=texture(map,(uv+vec2(0,0))*texelSize);vec4 s2=texture(map,(uv+vec2(1,0))*texelSize);vec4 s3=texture(map,(uv+vec2(0,1))*texelSize);vec4 s4=texture(map,(uv+vec2(1,1))*texelSize);return mix(mix(s1,s2,f.x),mix(s3,s4,f.x),f.y);
#endif
}layout(location=0)out vec4 out_light;layout(location=1)out vec4 out_momentLengthVariance;in vec2 vCoord;uniform mediump sampler2D lightTex;uniform mediump sampler2D positionTex;uniform mediump sampler2D colorTex;uniform mediump sampler2D previousLightTex;uniform mediump sampler2D previousPositionTex;uniform mediump sampler2D previousColorTex;uniform mediump sampler2D previousMomentLengthVarianceTex;uniform mat4 historyCamera;uniform float colorBlendFactor;uniform float momentBlendFactor;uniform float demodulateAlbedo;vec2 LGL_Al(vec3 position){vec4 historyCoord=historyCamera*vec4(position,1.0);return 0.5*historyCoord.xy/historyCoord.w+0.5;}float LGL_Am(sampler2D meshIdTex,vec2 vCoord){return floor(texture(meshIdTex,vCoord).w);}float LGL_An(float histMeshId,float currentMeshId,ivec2 coord,ivec2 size){if(histMeshId!=currentMeshId){return 0.0;}if(any(greaterThanEqual(coord,size))){return 0.0;}return 1.0;}void main(){vec3 currentPosition=LGL_Ag(positionTex,vCoord).xyz;float currentMeshId=LGL_Am(positionTex,vCoord);vec4 accumulatedLight=texture(lightTex,vCoord);vec3 currentLight=accumulatedLight.rgb/accumulatedLight.a;vec2 hCoord=LGL_Al(currentPosition);vec2 hSizef=vec2(textureSize(previousLightTex,0));vec2 hSizeInv=1.0/hSizef;ivec2 hSize=ivec2(hSizef);vec2 hTexelf=hCoord*hSizef-0.5;ivec2 hTexel=ivec2(hTexelf);vec2 f=fract(hTexelf);ivec2 texel[]=ivec2[](hTexel+ivec2(0,0),hTexel+ivec2(1,0),hTexel+ivec2(0,1),hTexel+ivec2(1,1));float weights[]=float[]((1.0-f.x)*(1.0-f.y),f.x*(1.0-f.y),(1.0-f.x)*f.y,f.x*f.y);vec4 historyLight=vec4(0.);;vec2 historyMoment=vec2(0.);float historyLength=0.;float sum=0.;float luminance=0.2126*currentLight.x+0.7152*currentLight.y+0.0722*currentLight.z;float N=texelFetch(previousMomentLengthVarianceTex,hTexel,0).b;if(N>0.0&&currentMeshId>0.0){for(int i=0;i<4;i++){vec2 gCoord=(vec2(texel[i])+0.5)*hSizeInv;float histMeshId=LGL_Am(previousPositionTex,gCoord);float isValid=LGL_An(histMeshId,currentMeshId,texel[i],hSize);float weight=isValid*weights[i];historyLight+=weight*texelFetch(previousLightTex,texel[i],0);historyMoment+=weight*texelFetch(previousMomentLengthVarianceTex,texel[i],0).rg;sum+=weight;}if(sum>0.0){historyLight/=sum;historyMoment/=sum;}else{hTexel=ivec2(hTexelf+0.5);for(int x=-1;x<=1;x++){for(int y=-1;y<=1;y++){ivec2 texel=hTexel+ivec2(x,y);vec2 gCoord=(vec2(texel)+0.5)*hSizeInv;float histMeshId=LGL_Am(previousPositionTex,gCoord);float isValid=LGL_An(histMeshId,currentMeshId,texel,hSize);float weight=isValid;historyLight+=weight*texelFetch(previousLightTex,texel,0);historyMoment+=weight*texelFetch(previousMomentLengthVarianceTex,texel,0).rg;sum+=weight;}}historyLight=sum>0.0 ? historyLight/sum : historyLight;historyMoment=sum>0.0 ? historyMoment/sum : historyMoment;}if(sum>0.0){historyLength=N+1.;float color_alpha_min=colorBlendFactor;float moment_alpha_min=momentBlendFactor;float color_alpha=max(1.0/historyLength,color_alpha_min);float moment_alpha=max(1.0/historyLength,moment_alpha_min);out_light=color_alpha*accumulatedLight+historyLight*(1.-color_alpha);float first_moment=moment_alpha*historyMoment.x+(1.0-moment_alpha)*luminance;float second_moment=moment_alpha*historyMoment.y+(1.0-moment_alpha)*luminance*luminance;float variance=second_moment-first_moment*first_moment;out_momentLengthVariance=vec4(first_moment,second_moment,historyLength,variance);return;}}out_light=accumulatedLight;out_momentLengthVariance=vec4(luminance,luminance*luminance,1.,100.);}`};function Ki(a,e){const{fullscreenQuad:t,maxReprojectedSamples:n}=e,i=Ae(a,{defines:{MAX_SAMPLES:n.toFixed(1)},vertex:t.vertexShader,fragment:Qi}),s=new tt;let o=.2,r=.2;function l(h){s.multiplyMatrices(h.projectionMatrix,h.matrixWorldInverse),i.setUniform("historyCamera",s.elements)}function c(h,L){i.setUniform("jitter",h,L)}function u(h){o=h}function f(h){r=h}function d(h){i.setUniform("demodulateAlbedo",h)}function p(h){const{light:L,position:x,color:g,previousColor:M,previousLight:A,previousPosition:T,previousMomentLengthVariance:S}=h;i.setTexture("lightTex",L),i.setTexture("positionTex",x),i.setTexture("colorTex",g),i.setTexture("previousLightTex",A),i.setTexture("previousPositionTex",T),i.setTexture("previousColorTex",M),i.setTexture("previousMomentLengthVarianceTex",S),i.setUniform("colorBlendFactor",o),i.setUniform("momentBlendFactor",r),i.useProgram(),t.draw()}return{draw:p,setJitter:c,setPreviousCamera:l,setDenoiseColorBlendFactor:u,setDenoiseMomentBlendFactor:f,setDemodulateAlbedo:d,getDenoiseFactors(){return{colorBlendFactor:o,momentBlendFactor:r}}}}var Zi={source:`vec4 LGL_Ag(sampler2D map,vec2 uv){
#ifdef OES_texture_float_linear
return texture(map,uv);
#else
vec2 size=vec2(textureSize(map,0));vec2 texelSize=1.0/size;uv=uv*size-0.5;vec2 f=fract(uv);uv=floor(uv)+0.5;vec4 s1=texture(map,(uv+vec2(0,0))*texelSize);vec4 s2=texture(map,(uv+vec2(1,0))*texelSize);vec4 s3=texture(map,(uv+vec2(0,1))*texelSize);vec4 s4=texture(map,(uv+vec2(1,1))*texelSize);return mix(mix(s1,s2,f.x),mix(s3,s4,f.x),f.y);
#endif
}layout(location=0)out vec4 out_color;in vec2 vCoord;uniform sampler2D lightTex;uniform sampler2D LGL_AlDataTex;uniform sampler2D gPosition;uniform sampler2D gNormal;uniform sampler2D gColor;uniform float colorFactor;uniform float normalFactor;uniform float positionFactor;uniform float stepwidth;uniform int level;uniform float useMomentVariance;uniform float demodulateAlbedo;float LGL_Ai(float v){return acos(min(max(v,0.0),1.0));}float LGL_Aj(vec2 uv){return max(texture(LGL_AlDataTex,uv).a,0.);}vec4 LGL_Ak(){vec4 upscaledLight=texture(lightTex,vCoord);float sampleFrame=upscaledLight.a;float sf2=sampleFrame*sampleFrame;vec3 color=upscaledLight.rgb/upscaledLight.a;vec3 normal=texture(gNormal,vCoord).rgb;vec4 positionAndMeshIndex=texture(gPosition,vCoord);vec3 position=positionAndMeshIndex.rgb;float meshIndex=positionAndMeshIndex.w;bool isBG=meshIndex>0.0 ? false : true;if(isBG){return upscaledLight;}vec2 size=vec2(textureSize(lightTex,0));int kernelRadius=9;float dx=1./size.x;float dy=1./size.y;float kernel[9]=float[9](1.0/16.0,1.0/8.0,1.0/16.0,1.0/8.0,1.0/4.0,1.0/8.0,1.0/16.0,1.0/8.0,1.0/16.0);vec2 offset[9]=vec2[9](vec2(-dx,-dy),vec2(0,-dy),vec2(dx,-dy),vec2(-dx,0),vec2(0,0),vec2(dx,0),vec2(-dx,dy),vec2(0,dy),vec2(dx,dy));vec3 colorSum=vec3(0.);float weightSum=0.;float var;float varSum;float varSumWeight;if(useMomentVariance>0.){for(int i=0;i<kernelRadius;i++){vec2 uv=vCoord+offset[i];if(uv.x<0.0||uv.x>1.0||uv.y<0.0||uv.y>1.0){continue;}vec4 positionAndMeshIndex=texture(gPosition,uv);float meshIndex=positionAndMeshIndex.w;bool isBG=meshIndex>0.0 ? false : true;if(isBG){continue;}varSum+=kernel[i]*LGL_Aj(uv);varSumWeight+=kernel[i];}if(varSumWeight>0.0){var=max(varSum/varSumWeight,0.0);}else{var=max(LGL_Aj(vCoord),0.0);}}for(int i=0;i<kernelRadius;i++){vec2 uv=vCoord+offset[i]*float(stepwidth);if(uv.x<0.0||uv.x>1.0||uv.y<0.0||uv.y>1.0){continue;}vec4 positionAndMeshIndex=texture(gPosition,uv);float meshIndex=positionAndMeshIndex.w;bool isBG=meshIndex>0.0 ? false : true;if(isBG){continue;}vec4 upscaledLight=texture(lightTex,uv);vec3 kernelColor=upscaledLight.rgb/upscaledLight.a;float Dc=distance(color,kernelColor);float Wc;if(useMomentVariance>0.){Wc=min(exp(-Dc/((1.+sqrt(var))*colorFactor+1e-6)),1.0);}else{Wc=min(exp(-Dc/(colorFactor+1e-6)),1.0);}vec3 kernelNormal=texture(gNormal,uv).rgb;float Dn=dot(normal,kernelNormal);Dn=Dn/float(stepwidth*stepwidth+1e-6);if(Dn<1e-3){continue;}float Wn=Dn;vec3 kernelPosition=positionAndMeshIndex.rgb;float Dp=distance(position,kernelPosition);float Wp=min(exp(-Dp/(positionFactor+1e-6)),1.0);float weight=Wc*Wn*Wp*kernel[i];weightSum+=weight;colorSum+=kernelColor*weight;}colorSum=colorSum/weightSum;return vec4(colorSum*sampleFrame,sampleFrame);}void main(){vec4 light=LGL_Ak();out_color=light;}`};function ji(a,e){const{fullscreenQuad:t}=e;let n,i;function s(T,S){const F=()=>De(a,{color:{0:Z(a,{width:T,height:S,storage:"float",magFilter:a.NEAREST,minFilter:a.NEAREST})}});n=F(),i=F()}function o(){let T=i;i=n,n=T}function r(T,S){s(T,S)}const l={gl:a,vertex:t.vertexShader,fragment:Zi},c=Ae(a,l),u=3;let f=.5,d=.2,p=.35;function h({position:T,normal:S,color:F}){c.setTexture("gPosition",T),c.setTexture("gNormal",S),c.setTexture("gColor",F)}function L(T){f=T}function x(T){d=T}function g(T){p=T}function M(T){c.setUniform("demodulateAlbedo",T)}function A(T){let{light:S,reprojectData:F}=T;for(let I=0;I<u;I++)c.setUniform("level",I),c.setUniform("colorFactor",1/(1<<I)*f),c.setUniform("normalFactor",1/(1<<I)*d),c.setUniform("positionFactor",1/(1<<I)*p),c.setUniform("stepwidth",(1<<I+1)-1),I===0?c.setTexture("lightTex",S):c.setTexture("lightTex",n.color[0]),F?(c.setUniform("useMomentVariance",1),c.setTexture("reprojectDataTex",F)):(c.setUniform("useMomentVariance",0),c.setTexture("reprojectDataTex",null)),i.bind(),a.clear(a.COLOR_BUFFER_BIT),a.viewport(0,0,a.drawingBufferWidth,a.drawingBufferHeight),c.useProgram(),t.draw(),i.unbind(),o();return n}return{draw:A,setGBuffers:h,setColorFactor:L,setNormalFactor:x,setPositionFactor:g,setDemodulateAlbedo:M,getDenoiseFactors(){return{colorFactor:f,normalFactor:d,positionFactor:p}},setSize:r}}function qi(a){const e=a.getParameter(a.MAX_RENDERBUFFER_SIZE);if(e<=8192)return 2e5;if(e===16384)return 4e5;if(e>=32768)return 6e5}function Ji(a){const e=21;let t=-1,n=1,i,s,o,r,l=0,c=0,u,f=qi(a);function d(){const g=u/n,M=e-g;f+=5e3*Math.sign(M)*Math.sqrt(Math.abs(M)),f=be(f,8192,l*c)}function p(){const g=l/c;i=Math.ceil(l/Math.round(l/Math.sqrt(f*g))),s=Math.ceil(i/g),o=Math.ceil(l/i),r=Math.ceil(c/s),n=o*r}function h(g,M){l=g,c=M,L(),p()}function L(){t=-1,u=NaN}function x(g){t++,u+=g,t%n==0&&(u&&(d(),p()),u=0,t=0);const M=t===n-1,A=t%o,T=Math.floor(t/o)%r;return{x:A*i,y:T*s,tileWidth:i,tileHeight:s,isFirstTile:t===0,isLastTile:M}}return{nextTile:x,reset:L,setSize:h}}var $i="data:image/png;base64,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";function es(a){const e=a.getParameter(a.MAX_RENDERBUFFER_SIZE);if(e<=8192)return 8e4;if(e===16384)return 15e4;if(e>=32768)return 4e5}function ts(a){const e=20;let t,n,i,s,o=new V(1,1),r=es(a);function l(){const f=t/n;i=Math.round(be(Math.sqrt(r*f),1,t)),s=Math.round(be(i/f,1,n)),o.set(i/t,s/n)}function c(f,d){t=f,n=d,l()}function u(f){if(!f)return;const d=600,p=e-f;r+=d*p,r=be(r,8192,t*n),l()}return{adjustSize:u,setSize:c,scale:o,get width(){return i},get height(){return s}}}async function ns({gl:a,optionalExtensions:e,scene:t,camera:n,toneMapping:i,bounces:s,envMapIntensity:o,movingDownsampling:r,enableDenoise:l,enableTemporalDenoise:c,enableSpatialDenoise:u,useWorker:f,loadingCallback:d}){const p=20,h=4,L=6,x=new jt,g=ts(a),M=Ji(a),A=Rt(t,n),T=li(A.meshes),S=xi(a,T.materials),F=Va(a),I=Bi(a,{materialBuffer:S,mergedMesh:T}),P=Vi(a,{fullscreenQuad:F,toneMapping:i}),y=Wi(a,{fullscreenQuad:F}),E=Ki(a,{fullscreenQuad:F,maxReprojectedSamples:p}),_=ji(a,{fullscreenQuad:F,toneMapping:i});let N=!1,w=0,B,G,Q=!0,k=()=>{};const X=await Ci(a,{bounces:s,decomposedScene:A,fullscreenQuad:F,materialBuffer:S,mergedMesh:T,optionalExtensions:e,scene:t,envMapIntensity:o,useWorker:f,loadingCallback:d}),fe=new Image;fe.src=$i,fe.onload=()=>{X.setNoise(fe),N=!0};let j,me,z,te,K,re;function Be(v,R){z=(()=>De(a,{color:{0:Z(a,{width:v,height:R,storage:"float",magFilter:a.LINEAR,minFilter:a.LINEAR})}}))(),te=z.color[0];const de=()=>De(a,{color:{0:Z(a,{width:v,height:R,storage:"float",magFilter:a.LINEAR,minFilter:a.LINEAR}),1:Z(a,{width:v,height:R,storage:"float",channels:4,magFilter:a.LINEAR,minFilter:a.LINEAR})}});K=de(),re=de();const xe=Z(a,{width:v,height:R,storage:"halfFloat"}),mt=Z(a,{width:v,height:R,storage:"float"}),$e=Qa(a,v,R),Bt=()=>De(a,{color:{0:Z(a,{width:v,height:R,storage:"float"}),1:xe,2:mt},depth:$e});j=Bt(),me=Bt()}function He(){let v=K;K=re,re=v}function Ve(){let v=j;j=me,me=v}function Ye(v){X.updateBounces(v)}function We(){const v=Rt(t,n);X.updateEnvLight(v)}function Qe(){const v=Rt(t,n);X.updateMeshLight(v)}function rt(v){X.setEnvMapIntensity(v)}function lt(v){P.setToneMapping(v)}function Ke(v){r=v}function Ne(v){l=v}function Pe(v){c=v,_e()}function Ze(v){E.setDenoiseColorBlendFactor(v)}function ct(v){E.setDenoiseMomentBlendFactor(v)}function ut(v){u=v,_e()}function ft(v){_.setColorFactor(v)}function je(v){_.setNormalFactor(v)}function qe(v){_.setPositionFactor(v)}_e(!1);function _e(v=!0){const R=Number(v&&c&&u);E.setDemodulateAlbedo(R),_.setDemodulateAlbedo(R)}function dt(){return Object.assign(_.getDenoiseFactors(),E.getDenoiseFactors())}let le=0,ne=0;function pt(v,R){le=v,ne=R,M.setSize(v,R),g.setSize(v,R),Be(v,R),_.setSize(v,R),P.setSize(v,R),y.setSize(v,R),Q=!0}function Te(v,R){X.setCamera(v),I.setCamera(v),E.setPreviousCamera(R),R.copy(v)}function Se(v,R,ee=!0){X.setSize(v,R),X.setFrameCount(w);const de=ee?(Math.random()-.5)/v:0,xe=ee?(Math.random()-.5)/R:0;l||X.setJitter(de,xe),w===0?X.setStrataCount(1):w===h?X.setStrataCount(L):X.nextSeed()}function Re(v){G=v-B,B=v}function m(v,R){return Wa(v.matrixWorld.elements,R.matrixWorld.elements)&&v.aspect===R.aspect&&v.fov===R.fov}function b(v){v.bind(),a.clear(a.COLOR_BUFFER_BIT),v.unbind()}function O(v,R,ee){v.bind(),a.blendEquation(a.FUNC_ADD),a.blendFunc(a.ONE,a.ONE),a.enable(a.BLEND),a.viewport(0,0,R,ee),X.draw(),a.disable(a.BLEND),v.unbind()}function H(v,R,ee){v.bind(),a.viewport(0,0,R,ee),X.draw(),v.unbind()}function Y(v,R){a.viewport(0,0,a.drawingBufferWidth,a.drawingBufferHeight),P.draw({light:v,lightScale:R}),te=v}function ae(v){let R=P.draw({light:v},!0);y.draw({light:R.color[0]})}function he(){j.bind(),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT),a.viewport(0,0,le,ne),I.draw(),j.unbind(),_.setGBuffers({position:j.color[0],normal:j.color[1],color:j.color[2]})}function Je(v,R,ee,de,xe){a.scissor(R,ee,de,xe),a.enable(a.SCISSOR_TEST),O(v,le,ne),a.disable(a.SCISSOR_TEST)}function $(){w=0,M.reset(),b(z),b(K),b(re)}function q(){if(c&&(K.bind(),a.viewport(0,0,le,ne),E.draw({light:z.color[0],position:j.color[0],color:j.color[2],previousLight:te,previousPosition:me.color[0],previousColor:me.color[2],previousMomentLengthVariance:re.color[1]}),K.unbind(),u||(ae(K.color[0]),te=K.color[0])),u)if(c){const v=_.draw({light:K.color[0],reprojectData:re.color[1]});ae(v.color[0]),te=K.color[0]}else{const v=_.draw({light:z.color[0],reprojectData:null});ae(v.color[0]),te=z.color[0]}}function Ot(v=!1){const{x:R,y:ee,tileWidth:de,tileHeight:xe,isFirstTile:mt,isLastTile:$e}=M.nextTile(G);mt&&(w===0&&(b(z),E.setPreviousCamera(x)),Se(le,ne,!0),he(),X.bindTextures()),Je(z,R,ee,de,xe),v&&!$e&&Y(z.color[0]),$e&&(l&&(c||u)?(te=z.color[0],q(),te=z.color[0]):Y(z.color[0]),He(),Ve(),w++,k())}function zt(){Se(g.width,g.height,!1),X.bindTextures(),H(z,g.width,g.height),Y(z.color[0],g.scale),b(z)}function Pn(v){!N||(m(v,x)?Ot():(Te(v,x),Q?Q=!1:r?zt():Ot(!0),w=0,M.reset()))}function Rn(v){if(!!N){if(Ve(),He(),m(v,x))w++;else{if(r){Te(v,x),w=0,zt();return}w=0,b(z)}Te(v,x),Se(le,ne,!0),he(),X.bindTextures(),O(z,le,ne),l&&(c||u)?q():Y(z.color[0]),k()}}return{draw:Pn,fullDraw:Rn,setSize:pt,time:Re,reset:$,getTotalSamplesRendered(){return w},setfullSampleCallbackCallBack(v){k=v},updateBounces:Ye,updateEnvLight:We,updateMeshLight:Qe,setEnvMapIntensity:rt,setToneMapping:lt,setMovingDownsampling:Ke,setDenoiseStatus:Ne,setTemporalDenoiseStatus:Pe,setDenoiseColorBlendFactor:Ze,setDenoiseMomentBlendFactor:ct,setSpatialDenoiseStatus:ut,setDenoiseColorFactor:ft,setDenoiseNormalFactor:je,setDenoisePositionFactor:qe,getDenoiseFactors:dt,setDemodulateAlbedo:_e}}class Cs{constructor(e={}){this.canvas=e.canvas||document.createElement("canvas"),this.gl=this.canvas.getContext("webgl2",{alpha:!1,depth:!0,stencil:!1,antialias:!1,powerPreference:"high-performance",failIfMajorPerformanceCaveat:!0}),It(this.gl,an),this.optionalExtensions=It(this.gl,Ua),this._bounces=2,this._envMapIntensity=1,this._toneMapping=Zt,this._movingDownsampling=!1,this._enableDenoise=!1,this._enableTemporalDenoise=!0,this._enableSpatialDenoise=!0,this._fullSampleCallback=null,this.useTileRender=!1,this.renderWhenOffFocus=!0,this.useWorker=e.useWorker||!0,this.loadingCallback=e.loadingCallback||{onProgress:t=>console.log(t),onComplete:t=>console.log(t)},this._isBuilding=!0,this.needsUpdate=!1,this.size=new V(this.canvas.width,this.canvas.height),this.pixelRatio=1,this.pipeline=null,this.currentTime=NaN,this.isValidTime=1,this.lastFocus=!1,this.domElement=this.canvas}static isSupported(){const e=document.createElement("canvas").getContext("webgl2",{failIfMajorPerformanceCaveat:!0});if(!e)return!1;const t=It(e,an);for(let n in t)if(!t[n])return!1;return!0}async buildScene(e,t){const{gl:n,optionalExtensions:i,bounces:s,size:o,toneMapping:r,envMapIntensity:l,movingDownsampling:c,enableDenoise:u,enableTemporalDenoise:f,enableSpatialDenoise:d,useWorker:p,loadingCallback:h}=this;this._isBuilding=!0,e.updateMatrixWorld(),this.pipeline=await ns({gl:n,optionalExtensions:i,scene:e,camera:t,toneMapping:r,bounces:s,envMapIntensity:l,movingDownsampling:c,enableDenoise:u,enableTemporalDenoise:f,enableSpatialDenoise:d,useWorker:p,loadingCallback:h}),this.setSize(o.width,o.height),this._isBuilding=!1,h&&h.onComplete&&typeof h.onComplete=="function"&&h.onComplete("Complete!")}set bounces(e){this._bounces=e,this.pipeline&&this.pipeline.updateBounces(e)}get bounces(){return this._bounces}set envMapIntensity(e){e=Number(e),this._envMapIntensity=e,this.pipeline&&this.pipeline.setEnvMapIntensity(e)}get envMapIntensity(){return this._envMapIntensity}set toneMapping(e){this._toneMapping=e,this.pipeline&&this.pipeline.setToneMapping(e)}get toneMapping(){return this._toneMapping}set movingDownsampling(e){e=!!e,this._movingDownsampling=e,this.pipeline&&this.pipeline.setMovingDownsampling(e)}get movingDownsampling(){return this._movingDownsampling}set enableDenoise(e){e=!!e,this._enableDenoise=e,this.pipeline&&this.pipeline.setDenoiseStatus(e)}get enableDenoise(){return this._enableDenoise}set enableTemporalDenoise(e){e=!!e,this._enableTemporalDenoise=e,this.pipeline&&this.pipeline.setTemporalDenoiseStatus(e)}get enableTemporalDenoise(){return this._enableTemporalDenoise}set enableSpatialDenoise(e){e=!!e,this._enableSpatialDenoise=e,this.pipeline&&this.pipeline.setSpatialDenoiseStatus(e)}get enableSpatialDenoise(){return this._enableSpatialDenoise}set fullSampleCallback(e){e&&typeof e=="function"&&(this._fullSampleCallback=e,this.pipeline&&this.pipeline.setfullSampleCallbackCallBack(e))}get fullSampleCallback(){return this._fullSampleCallback}updateEnvLight(){this.pipeline&&this.pipeline.updateEnvLight()}updateMeshLight(){this.pipeline&&this.pipeline.updateMeshLight()}setDenoiseColorBlendFactor(e){this.pipeline&&this.pipeline.setDenoiseColorBlendFactor(e)}setDenoiseMomentBlendFactor(e){this.pipeline&&this.pipeline.setDenoiseMomentBlendFactor(e)}setDenoiseColorFactor(e){this.pipeline&&this.pipeline.setDenoiseColorFactor(e)}setDenoiseNormalFactor(e){this.pipeline&&this.pipeline.setDenoiseNormalFactor(e)}setDenoisePositionFactor(e){this.pipeline&&this.pipeline.setDenoisePositionFactor(e)}setDemodulateAlbedo(e){this.pipeline&&this.pipeline.setDemodulateAlbedo(e),this.needsUpdate=!0}getDenoiseFactors(){if(this.pipeline)return this.pipeline.getDenoiseFactors()}setSize(e,t,n=!0){const{size:i,canvas:s,pipeline:o,pixelRatio:r}=this;i.set(e,t),s.width=i.width*r,s.height=i.height*r,n&&(s.style.width=`${i.width}px`,s.style.height=`${i.height}px`),this.pipeline&&o.setSize(i.width*r,i.height*r)}getSize(e){const{size:t}=this;return e||(e=new V),e.copy(t)}setPixelRatio(e){const{size:t}=this;!e||(this.pixelRatio=e,this.setSize(t.width,t.height,!1))}getPixelRatio(){return this.pixelRatio}getTotalSamples(){if(this.pipeline)return this.pipeline.getTotalSamplesRendered()}restartTimer(){this.isValidTime=NaN}render(e,t){if(!this._isBuilding){if(!this.pipeline){console.error("The scene needs to be built first!");return}if(this.needsUpdate&&(this.needsUpdate=!1,this.pipeline.reset()),!this.renderWhenOffFocus){const n=document.hasFocus();if(n)n&&!this.lastFocus&&(this.lastFocus=n,this.restartTimer());else{this.lastFocus=n;return}}this.currentTime=performance.now(),this.pipeline.time(this.isValidTime*this.currentTime),this.isValidTime=1,this.currentTime=NaN,t.updateMatrixWorld(),this.useTileRender?this.pipeline.draw(t):this.pipeline.fullDraw(t)}}dispose(){}}class as extends we{constructor(e,t,n=10,i=10){super(e,t);this.type="RectAreaLight",this.width=n,this.height=i,this.target=new D}copy(e){super.copy(e),this.width=e.width,this.height=e.height}}class is extends we{constructor(e,t,n,i){super(e,t);this.type="QuadLight",this.v1=n,this.v2=i}}class ss extends we{constructor(e,t,n=1){super(e,t);this.type="SphereAreaLight",this.radius=n}}class os extends we{constructor(e,t){super(e,t);this.type="PointLight"}}class rs extends we{constructor(e,t){super(e,t);this.type="DirectionalLight",this.target=new D}}const ks={Sunset:"/envMaps/sunset_1k.hdr",Konzerthaus:"/envMaps/konzerthaus_1k.hdr",Dirlight:"/envMaps/gray-background-with-dirlight_1k.hdr",VeniceSunset:"/envMaps/venice_sunset_2k.hdr",LightBooth:"/envMaps/LightBooth.hdr",Powerplant:"/envMaps/peppermint_powerplant_4k.hdr",LightRoom:"/envMaps/lightroom_14b.hdr",PaperMill:"/envMaps/PaperMill_E_3k.hdr",Arches:"/envMaps/Arches_E_PineTree_3k.hdr",GCanyon:"/envMaps/GCanyon_C_YumaPoint_3k.hdr",Milkyway:"/envMaps/Milkyway_small.hdr",Studio:"/envMaps/studio_small_02_2k.hdr"},Os={CornellBox:"/models/cornellBox/scene.gltf",DamagedHelmet:"/models/DamagedHelmet/scene.gltf",Dragon:"/models/Dragon/dragon.glb",DragonDraco:"/models/Dragon/dragonDraco.glb",Miku:"/models/miku2/scene.gltf",DiningRoom:"/models/DiningRoom/scene.gltf",MaterialBall:"/models/ball/scene.gltf",dracoDishModelPath:"/models/draco/IridescentDishWithOlives.glb",Car:"/models/car/scene.gltf",TeapotDraco:"/models/teapot/teapotDraco.glb",Zelda:"/models/zelda/scene.gltf",SG:"/models/SpecGlossVsMetalRough/scene.gltf",SSSDragon:"/models/SSS/Dragon/scene.gltf",SSSDragonDraco:"/models/SSS/Dragon/dragonDraco.glb"},zs={Checker:"/models/teapot/checker.glb",Teapot:"/models/teapot/teapot.glb",TeapotBase:"/models/teapot/base.glb",TeapotCloth:"/models/teapot/cloth.glb"},Bs="/models/bedRoom/scene.gltf",Hs="/models/diningRoom/scene.gltf",Vs="/models/diningRoom/diningRoom.glb",Ys="/models/Stormtrooper/stormtrooper.glb";class wt extends qt{constructor(e){super(e);this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(t){return new fs(t)}),this.register(function(t){return new xs(t)}),this.register(function(t){return new Ls(t)}),this.register(function(t){return new ds(t)}),this.register(function(t){return new ps(t)}),this.register(function(t){return new ms(t)}),this.register(function(t){return new hs(t)}),this.register(function(t){return new cs(t)}),this.register(function(t){return new As(t)})}load(e,t,n,i){const s=this;let o;this.resourcePath!==""?o=this.resourcePath:this.path!==""?o=this.path:o=Le.extractUrlBase(e),this.manager.itemStart(e);const r=function(c){i?i(c):console.error(c),s.manager.itemError(e),s.manager.itemEnd(e)},l=new nt(this.manager);l.setPath(this.path),l.setResponseType("arraybuffer"),l.setRequestHeader(this.requestHeader),l.setWithCredentials(this.withCredentials),l.load(e,function(c){try{s.parse(c,o,function(u){t(u),s.manager.itemEnd(e)},r)}catch(u){r(u)}},n,r)}setDRACOLoader(e){return this.dracoLoader=e,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return this.pluginCallbacks.indexOf(e)===-1&&this.pluginCallbacks.push(e),this}unregister(e){return this.pluginCallbacks.indexOf(e)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,n,i){let s;const o={},r={};if(typeof e=="string")s=e;else if(Le.decodeText(new Uint8Array(e,0,4))===An){try{o[U.KHR_BINARY_GLTF]=new gs(e)}catch(f){i&&i(f);return}s=o[U.KHR_BINARY_GLTF].content}else s=Le.decodeText(new Uint8Array(e));const l=JSON.parse(s);if(l.asset===void 0||l.asset.version[0]<2){i&&i(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}const c=new Ns(l,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});c.fileLoader.setRequestHeader(this.requestHeader);for(let u=0;u<this.pluginCallbacks.length;u++){const f=this.pluginCallbacks[u](c);r[f.name]=f,o[f.name]=!0}if(l.extensionsUsed)for(let u=0;u<l.extensionsUsed.length;++u){const f=l.extensionsUsed[u],d=l.extensionsRequired||[];switch(f){case U.KHR_MATERIALS_UNLIT:o[f]=new us;break;case U.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:o[f]=new Ts;break;case U.KHR_DRACO_MESH_COMPRESSION:o[f]=new vs(l,this.dracoLoader);break;case U.KHR_TEXTURE_TRANSFORM:o[f]=new _s;break;case U.KHR_MESH_QUANTIZATION:o[f]=new Ss;break;default:d.indexOf(f)>=0&&r[f]===void 0&&console.warn('THREE.GLTFLoader: Unknown extension "'+f+'".')}}c.setExtensions(o),c.setPlugins(r),c.parse(n,i)}}function ls(){let a={};return{get:function(e){return a[e]},add:function(e,t){a[e]=t},remove:function(e){delete a[e]},removeAll:function(){a={}}}}const U={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression"};class cs{constructor(e){this.parser=e,this.name=U.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let n=0,i=t.length;n<i;n++){const s=t[n];s.extensions&&s.extensions[this.name]&&s.extensions[this.name].light!==void 0&&e._addNodeRef(this.cache,s.extensions[this.name].light)}}_loadLight(e){const t=this.parser,n="light:"+e;let i=t.cache.get(n);if(i)return i;const s=t.json,l=((s.extensions&&s.extensions[this.name]||{}).lights||[])[e];let c;const u=new C(16777215);l.color!==void 0&&u.fromArray(l.color);const f=l.range!==void 0?l.range:0;switch(l.type){case"directional":c=new Wn(u),c.target.position.set(0,0,-1),c.add(c.target);break;case"point":c=new Yn(u),c.distance=f;break;case"spot":c=new Vn(u),c.distance=f,l.spot=l.spot||{},l.spot.innerConeAngle=l.spot.innerConeAngle!==void 0?l.spot.innerConeAngle:0,l.spot.outerConeAngle=l.spot.outerConeAngle!==void 0?l.spot.outerConeAngle:Math.PI/4,c.angle=l.spot.outerConeAngle,c.penumbra=1-l.spot.innerConeAngle/l.spot.outerConeAngle,c.target.position.set(0,0,-1),c.add(c.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+l.type)}return c.position.set(0,0,0),c.decay=2,l.intensity!==void 0&&(c.intensity=l.intensity),c.name=t.createUniqueName(l.name||"light_"+e),i=Promise.resolve(c),t.cache.add(n,i),i}createNodeAttachment(e){const t=this,n=this.parser,s=n.json.nodes[e],r=(s.extensions&&s.extensions[this.name]||{}).light;return r===void 0?null:this._loadLight(r).then(function(l){return n._getNodeRef(t.cache,r,l)})}}class us{constructor(){this.name=U.KHR_MATERIALS_UNLIT}getMaterialType(){return Ue}extendParams(e,t,n){const i=[];e.color=new C(1,1,1),e.opacity=1;const s=t.pbrMetallicRoughness;if(s){if(Array.isArray(s.baseColorFactor)){const o=s.baseColorFactor;e.color.fromArray(o),e.opacity=o[3]}s.baseColorTexture!==void 0&&i.push(n.assignTexture(e,"map",s.baseColorTexture))}return Promise.all(i)}}class fs{constructor(e){this.parser=e,this.name=U.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const n=this.parser.json.materials[e];return!n.extensions||!n.extensions[this.name]?null:Xe}extendMaterialParams(e,t){const n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const s=[],o=i.extensions[this.name];if(o.clearcoatFactor!==void 0&&(t.clearcoat=o.clearcoatFactor),o.clearcoatTexture!==void 0&&s.push(n.assignTexture(t,"clearcoatMap",o.clearcoatTexture)),o.clearcoatRoughnessFactor!==void 0&&(t.clearcoatRoughness=o.clearcoatRoughnessFactor),o.clearcoatRoughnessTexture!==void 0&&s.push(n.assignTexture(t,"clearcoatRoughnessMap",o.clearcoatRoughnessTexture)),o.clearcoatNormalTexture!==void 0&&(s.push(n.assignTexture(t,"clearcoatNormalMap",o.clearcoatNormalTexture)),o.clearcoatNormalTexture.scale!==void 0)){const r=o.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new V(r,-r)}return Promise.all(s)}}class ds{constructor(e){this.parser=e,this.name=U.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const n=this.parser.json.materials[e];return!n.extensions||!n.extensions[this.name]?null:Xe}extendMaterialParams(e,t){const n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const s=[],o=i.extensions[this.name];return o.transmissionFactor!==void 0&&(t.transmission=o.transmissionFactor),o.transmissionTexture!==void 0&&s.push(n.assignTexture(t,"transmissionMap",o.transmissionTexture)),Promise.all(s)}}class ps{constructor(e){this.parser=e,this.name=U.KHR_MATERIALS_VOLUME}getMaterialType(e){const n=this.parser.json.materials[e];return!n.extensions||!n.extensions[this.name]?null:Xe}extendMaterialParams(e,t){const n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const s=[],o=i.extensions[this.name];t.thickness=o.thicknessFactor!==void 0?o.thicknessFactor:0,o.thicknessTexture!==void 0&&s.push(n.assignTexture(t,"thicknessMap",o.thicknessTexture)),t.attenuationDistance=o.attenuationDistance||0;const r=o.attenuationColor||[1,1,1];return t.attenuationTint=new C(r[0],r[1],r[2]),Promise.all(s)}}class ms{constructor(e){this.parser=e,this.name=U.KHR_MATERIALS_IOR}getMaterialType(e){const n=this.parser.json.materials[e];return!n.extensions||!n.extensions[this.name]?null:Xe}extendMaterialParams(e,t){const i=this.parser.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const s=i.extensions[this.name];return t.ior=s.ior!==void 0?s.ior:1.5,Promise.resolve()}}class hs{constructor(e){this.parser=e,this.name=U.KHR_MATERIALS_SPECULAR}getMaterialType(e){const n=this.parser.json.materials[e];return!n.extensions||!n.extensions[this.name]?null:Xe}extendMaterialParams(e,t){const n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const s=[],o=i.extensions[this.name];t.specularIntensity=o.specularFactor!==void 0?o.specularFactor:1,o.specularTexture!==void 0&&s.push(n.assignTexture(t,"specularIntensityMap",o.specularTexture));const r=o.specularColorFactor||[1,1,1];return t.specularTint=new C(r[0],r[1],r[2]),o.specularColorTexture!==void 0&&s.push(n.assignTexture(t,"specularTintMap",o.specularColorTexture).then(function(l){l.encoding=Tt})),Promise.all(s)}}class xs{constructor(e){this.parser=e,this.name=U.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,n=t.json,i=n.textures[e];if(!i.extensions||!i.extensions[this.name])return null;const s=i.extensions[this.name],o=n.images[s.source],r=t.options.ktx2Loader;if(!r){if(n.extensionsRequired&&n.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,o,r)}}class Ls{constructor(e){this.parser=e,this.name=U.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const t=this.name,n=this.parser,i=n.json,s=i.textures[e];if(!s.extensions||!s.extensions[t])return null;const o=s.extensions[t],r=i.images[o.source];let l=n.textureLoader;if(r.uri){const c=n.options.manager.getHandler(r.uri);c!==null&&(l=c)}return this.detectSupport().then(function(c){if(c)return n.loadTextureImage(e,r,l);if(i.extensionsRequired&&i.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return n.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(t.height===1)}})),this.isSupported}}class As{constructor(e){this.name=U.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,n=t.bufferViews[e];if(n.extensions&&n.extensions[this.name]){const i=n.extensions[this.name],s=this.parser.getDependency("buffer",i.buffer),o=this.parser.options.meshoptDecoder;if(!o||!o.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return Promise.all([s,o.ready]).then(function(r){const l=i.byteOffset||0,c=i.byteLength||0,u=i.count,f=i.byteStride,d=new ArrayBuffer(u*f),p=new Uint8Array(r[0],l,c);return o.decodeGltfBuffer(new Uint8Array(d),u,f,p,i.mode,i.filter),d})}else return null}}const An="glTF",ke=12,gn={JSON:1313821514,BIN:5130562};class gs{constructor(e){this.name=U.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,ke);if(this.header={magic:Le.decodeText(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==An)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const n=this.header.length-ke,i=new DataView(e,ke);let s=0;for(;s<n;){const o=i.getUint32(s,!0);s+=4;const r=i.getUint32(s,!0);if(s+=4,r===gn.JSON){const l=new Uint8Array(e,ke+s,o);this.content=Le.decodeText(l)}else if(r===gn.BIN){const l=ke+s;this.body=e.slice(l,l+o)}s+=o}if(this.content===null)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class vs{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=U.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const n=this.json,i=this.dracoLoader,s=e.extensions[this.name].bufferView,o=e.extensions[this.name].attributes,r={},l={},c={};for(const u in o){const f=Xt[u]||u.toLowerCase();r[f]=o[u]}for(const u in e.attributes){const f=Xt[u]||u.toLowerCase();if(o[u]!==void 0){const d=n.accessors[e.attributes[u]],p=Oe[d.componentType];c[f]=p,l[f]=d.normalized===!0}}return t.getDependency("bufferView",s).then(function(u){return new Promise(function(f){i.decodeDracoFile(u,function(d){for(const p in d.attributes){const h=d.attributes[p],L=l[p];L!==void 0&&(h.normalized=L)}f(d)},r,c)})})}}class _s{constructor(){this.name=U.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return t.texCoord!==void 0&&console.warn('THREE.GLTFLoader: Custom UV sets in "'+this.name+'" extension not yet supported.'),t.offset===void 0&&t.rotation===void 0&&t.scale===void 0||(e=e.clone(),t.offset!==void 0&&e.offset.fromArray(t.offset),t.rotation!==void 0&&(e.rotation=t.rotation),t.scale!==void 0&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class Ut extends St{constructor(e){super();this.isGLTFSpecularGlossinessMaterial=!0;const t=["#ifdef USE_SPECULARMAP","	uniform sampler2D specularMap;","#endif"].join(`
`),n=["#ifdef USE_GLOSSINESSMAP","	uniform sampler2D glossinessMap;","#endif"].join(`
`),i=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","	vec4 texelSpecular = texture2D( specularMap, vUv );","	texelSpecular = sRGBToLinear( texelSpecular );","	// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","	specularFactor *= texelSpecular.rgb;","#endif"].join(`
`),s=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","	vec4 texelGlossiness = texture2D( glossinessMap, vUv );","	// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","	glossinessFactor *= texelGlossiness.a;","#endif"].join(`
`),o=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb * ( 1. - max( specularFactor.r, max( specularFactor.g, specularFactor.b ) ) );","vec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );","float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );","material.specularRoughness = max( 1.0 - glossinessFactor, 0.0525 ); // 0.0525 corresponds to the base mip of a 256 cubemap.","material.specularRoughness += geometryRoughness;","material.specularRoughness = min( material.specularRoughness, 1.0 );","material.specularColor = specularFactor;"].join(`
`),r={specular:{value:new C().setHex(16777215)},glossiness:{value:1},specularMap:{value:null},glossinessMap:{value:null}};this._extraUniforms=r,this.onBeforeCompile=function(l){for(const c in r)l.uniforms[c]=r[c];l.fragmentShader=l.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;").replace("uniform float metalness;","uniform float glossiness;").replace("#include <roughnessmap_pars_fragment>",t).replace("#include <metalnessmap_pars_fragment>",n).replace("#include <roughnessmap_fragment>",i).replace("#include <metalnessmap_fragment>",s).replace("#include <lights_physical_fragment>",o)},Object.defineProperties(this,{specular:{get:function(){return r.specular.value},set:function(l){r.specular.value=l}},specularMap:{get:function(){return r.specularMap.value},set:function(l){r.specularMap.value=l,l?this.defines.USE_SPECULARMAP="":delete this.defines.USE_SPECULARMAP}},glossiness:{get:function(){return r.glossiness.value},set:function(l){r.glossiness.value=l}},glossinessMap:{get:function(){return r.glossinessMap.value},set:function(l){r.glossinessMap.value=l,l?(this.defines.USE_GLOSSINESSMAP="",this.defines.USE_UV=""):(delete this.defines.USE_GLOSSINESSMAP,delete this.defines.USE_UV)}}}),delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this.setValues(e)}copy(e){return super.copy(e),this.specularMap=e.specularMap,this.specular.copy(e.specular),this.glossinessMap=e.glossinessMap,this.glossiness=e.glossiness,delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this}}class Ts{constructor(){this.name=U.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,this.specularGlossinessParams=["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","normalMapType","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity","refractionRatio"]}getMaterialType(){return Ut}extendParams(e,t,n){const i=t.extensions[this.name];e.color=new C(1,1,1),e.opacity=1;const s=[];if(Array.isArray(i.diffuseFactor)){const o=i.diffuseFactor;e.color.fromArray(o),e.opacity=o[3]}if(i.diffuseTexture!==void 0&&s.push(n.assignTexture(e,"map",i.diffuseTexture)),e.emissive=new C(0,0,0),e.glossiness=i.glossinessFactor!==void 0?i.glossinessFactor:1,e.specular=new C(1,1,1),Array.isArray(i.specularFactor)&&e.specular.fromArray(i.specularFactor),i.specularGlossinessTexture!==void 0){const o=i.specularGlossinessTexture;s.push(n.assignTexture(e,"glossinessMap",o)),s.push(n.assignTexture(e,"specularMap",o))}return Promise.all(s)}createMaterial(e){const t=new Ut(e);return t.fog=!0,t.color=e.color,t.map=e.map===void 0?null:e.map,t.lightMap=null,t.lightMapIntensity=1,t.aoMap=e.aoMap===void 0?null:e.aoMap,t.aoMapIntensity=1,t.emissive=e.emissive,t.emissiveIntensity=1,t.emissiveMap=e.emissiveMap===void 0?null:e.emissiveMap,t.bumpMap=e.bumpMap===void 0?null:e.bumpMap,t.bumpScale=1,t.normalMap=e.normalMap===void 0?null:e.normalMap,t.normalMapType=Qn,e.normalScale&&(t.normalScale=e.normalScale),t.displacementMap=null,t.displacementScale=1,t.displacementBias=0,t.specularMap=e.specularMap===void 0?null:e.specularMap,t.specular=e.specular,t.glossinessMap=e.glossinessMap===void 0?null:e.glossinessMap,t.glossiness=e.glossiness,t.alphaMap=null,t.envMap=e.envMap===void 0?null:e.envMap,t.envMapIntensity=1,t.refractionRatio=.98,t}}class Ss{constructor(){this.name=U.KHR_MESH_QUANTIZATION}}class Ie extends Kn{constructor(e,t,n,i){super(e,t,n,i)}copySampleValue_(e){const t=this.resultBuffer,n=this.sampleValues,i=this.valueSize,s=e*i*3+i;for(let o=0;o!==i;o++)t[o]=n[s+o];return t}}Ie.prototype.beforeStart_=Ie.prototype.copySampleValue_;Ie.prototype.afterEnd_=Ie.prototype.copySampleValue_;Ie.prototype.interpolate_=function(a,e,t,n){const i=this.resultBuffer,s=this.sampleValues,o=this.valueSize,r=o*2,l=o*3,c=n-e,u=(t-e)/c,f=u*u,d=f*u,p=a*l,h=p-l,L=-2*d+3*f,x=d-f,g=1-L,M=x-f+u;for(let A=0;A!==o;A++){const T=s[h+A+o],S=s[h+A+r]*c,F=s[p+A+o],I=s[p+A]*c;i[A]=g*T+M*S+L*F+x*I}return i};const ue={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},Oe={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},vn={9728:vt,9729:ye,9984:Zn,9985:jn,9986:qn,9987:Jt},_n={33071:Jn,33648:$n,10497:Mt},Tn={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},Xt={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},pe={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},Ms={CUBICSPLINE:void 0,LINEAR:$t,STEP:ea},Dt={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function Sn(a,e){return typeof a!="string"||a===""?"":(/^https?:\/\//i.test(e)&&/^\//.test(a)&&(e=e.replace(/(^https?:\/\/[^\/]+).*/i,"$1")),/^(https?:)?\/\//i.test(a)||/^data:.*,.*$/i.test(a)||/^blob:.*$/i.test(a)?a:e+a)}function Fs(a){return a.DefaultMaterial===void 0&&(a.DefaultMaterial=new St({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:Fa})),a.DefaultMaterial}function ze(a,e,t){for(const n in t.extensions)a[n]===void 0&&(e.userData.gltfExtensions=e.userData.gltfExtensions||{},e.userData.gltfExtensions[n]=t.extensions[n])}function ve(a,e){e.extras!==void 0&&(typeof e.extras=="object"?Object.assign(a.userData,e.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+e.extras))}function ys(a,e,t){let n=!1,i=!1;for(let r=0,l=e.length;r<l;r++){const c=e[r];if(c.POSITION!==void 0&&(n=!0),c.NORMAL!==void 0&&(i=!0),n&&i)break}if(!n&&!i)return Promise.resolve(a);const s=[],o=[];for(let r=0,l=e.length;r<l;r++){const c=e[r];if(n){const u=c.POSITION!==void 0?t.getDependency("accessor",c.POSITION):a.attributes.position;s.push(u)}if(i){const u=c.NORMAL!==void 0?t.getDependency("accessor",c.NORMAL):a.attributes.normal;o.push(u)}}return Promise.all([Promise.all(s),Promise.all(o)]).then(function(r){const l=r[0],c=r[1];return n&&(a.morphAttributes.position=l),i&&(a.morphAttributes.normal=c),a.morphTargetsRelative=!0,a})}function bs(a,e){if(a.updateMorphTargets(),e.weights!==void 0)for(let t=0,n=e.weights.length;t<n;t++)a.morphTargetInfluences[t]=e.weights[t];if(e.extras&&Array.isArray(e.extras.targetNames)){const t=e.extras.targetNames;if(a.morphTargetInfluences.length===t.length){a.morphTargetDictionary={};for(let n=0,i=t.length;n<i;n++)a.morphTargetDictionary[t[n]]=n}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function Is(a){const e=a.extensions&&a.extensions[U.KHR_DRACO_MESH_COMPRESSION];let t;return e?t="draco:"+e.bufferView+":"+e.indices+":"+Mn(e.attributes):t=a.indices+":"+Mn(a.attributes)+":"+a.mode,t}function Mn(a){let e="";const t=Object.keys(a).sort();for(let n=0,i=t.length;n<i;n++)e+=t[n]+":"+a[t[n]]+";";return e}function Ct(a){switch(a){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}class Ns{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new ls,this.associations=new Map,this.primitiveCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.textureCache={},this.nodeNamesUsed={},typeof createImageBitmap!="undefined"&&/Firefox/.test(navigator.userAgent)===!1?this.textureLoader=new ta(this.options.manager):this.textureLoader=new na(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new nt(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),this.options.crossOrigin==="use-credentials"&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const n=this,i=this.json,s=this.extensions;this.cache.removeAll(),this._invokeAll(function(o){return o._markDefs&&o._markDefs()}),Promise.all(this._invokeAll(function(o){return o.beforeRoot&&o.beforeRoot()})).then(function(){return Promise.all([n.getDependencies("scene"),n.getDependencies("animation"),n.getDependencies("camera")])}).then(function(o){const r={scene:o[0][i.scene||0],scenes:o[0],animations:o[1],cameras:o[2],asset:i.asset,parser:n,userData:{}};ze(s,r,i),ve(r,i),Promise.all(n._invokeAll(function(l){return l.afterRoot&&l.afterRoot(r)})).then(function(){e(r)})}).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],n=this.json.meshes||[];for(let i=0,s=t.length;i<s;i++){const o=t[i].joints;for(let r=0,l=o.length;r<l;r++)e[o[r]].isBone=!0}for(let i=0,s=e.length;i<s;i++){const o=e[i];o.mesh!==void 0&&(this._addNodeRef(this.meshCache,o.mesh),o.skin!==void 0&&(n[o.mesh].isSkinnedMesh=!0)),o.camera!==void 0&&this._addNodeRef(this.cameraCache,o.camera)}}_addNodeRef(e,t){t!==void 0&&(e.refs[t]===void 0&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,n){if(e.refs[t]<=1)return n;const i=n.clone();return i.name+="_instance_"+e.uses[t]++,i}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let n=0;n<t.length;n++){const i=e(t[n]);if(i)return i}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const n=[];for(let i=0;i<t.length;i++){const s=e(t[i]);s&&n.push(s)}return n}getDependency(e,t){const n=e+":"+t;let i=this.cache.get(n);if(!i){switch(e){case"scene":i=this.loadScene(t);break;case"node":i=this.loadNode(t);break;case"mesh":i=this._invokeOne(function(s){return s.loadMesh&&s.loadMesh(t)});break;case"accessor":i=this.loadAccessor(t);break;case"bufferView":i=this._invokeOne(function(s){return s.loadBufferView&&s.loadBufferView(t)});break;case"buffer":i=this.loadBuffer(t);break;case"material":i=this._invokeOne(function(s){return s.loadMaterial&&s.loadMaterial(t)});break;case"texture":i=this._invokeOne(function(s){return s.loadTexture&&s.loadTexture(t)});break;case"skin":i=this.loadSkin(t);break;case"animation":i=this.loadAnimation(t);break;case"camera":i=this.loadCamera(t);break;default:throw new Error("Unknown type: "+e)}this.cache.add(n,i)}return i}getDependencies(e){let t=this.cache.get(e);if(!t){const n=this,i=this.json[e+(e==="mesh"?"es":"s")]||[];t=Promise.all(i.map(function(s,o){return n.getDependency(e,o)})),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],n=this.fileLoader;if(t.type&&t.type!=="arraybuffer")throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(t.uri===void 0&&e===0)return Promise.resolve(this.extensions[U.KHR_BINARY_GLTF].body);const i=this.options;return new Promise(function(s,o){n.load(Sn(t.uri,i.path),s,void 0,function(){o(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(n){const i=t.byteLength||0,s=t.byteOffset||0;return n.slice(s,s+i)})}loadAccessor(e){const t=this,n=this.json,i=this.json.accessors[e];if(i.bufferView===void 0&&i.sparse===void 0)return Promise.resolve(null);const s=[];return i.bufferView!==void 0?s.push(this.getDependency("bufferView",i.bufferView)):s.push(null),i.sparse!==void 0&&(s.push(this.getDependency("bufferView",i.sparse.indices.bufferView)),s.push(this.getDependency("bufferView",i.sparse.values.bufferView))),Promise.all(s).then(function(o){const r=o[0],l=Tn[i.type],c=Oe[i.componentType],u=c.BYTES_PER_ELEMENT,f=u*l,d=i.byteOffset||0,p=i.bufferView!==void 0?n.bufferViews[i.bufferView].byteStride:void 0,h=i.normalized===!0;let L,x;if(p&&p!==f){const g=Math.floor(d/p),M="InterleavedBuffer:"+i.bufferView+":"+i.componentType+":"+g+":"+i.count;let A=t.cache.get(M);A||(L=new c(r,g*p,i.count*p/u),A=new aa(L,p/u),t.cache.add(M,A)),x=new ia(A,l,d%p/u,h)}else r===null?L=new c(i.count*l):L=new c(r,d,i.count*l),x=new ie(L,l,h);if(i.sparse!==void 0){const g=Tn.SCALAR,M=Oe[i.sparse.indices.componentType],A=i.sparse.indices.byteOffset||0,T=i.sparse.values.byteOffset||0,S=new M(o[1],A,i.sparse.count*g),F=new c(o[2],T,i.sparse.count*l);r!==null&&(x=new ie(x.array.slice(),x.itemSize,x.normalized));for(let I=0,P=S.length;I<P;I++){const y=S[I];if(x.setX(y,F[I*l]),l>=2&&x.setY(y,F[I*l+1]),l>=3&&x.setZ(y,F[I*l+2]),l>=4&&x.setW(y,F[I*l+3]),l>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return x})}loadTexture(e){const t=this.json,n=this.options,i=t.textures[e],s=t.images[i.source];let o=this.textureLoader;if(s.uri){const r=n.manager.getHandler(s.uri);r!==null&&(o=r)}return this.loadTextureImage(e,s,o)}loadTextureImage(e,t,n){const i=this,s=this.json,o=this.options,r=s.textures[e],l=(t.uri||t.bufferView)+":"+r.sampler;if(this.textureCache[l])return this.textureCache[l];const c=self.URL||self.webkitURL;let u=t.uri||"",f=!1,d=!0;const p=u.search(/\.jpe?g($|\?)/i)>0||u.search(/^data\:image\/jpeg/)===0;if((t.mimeType==="image/jpeg"||p)&&(d=!1),t.bufferView!==void 0)u=i.getDependency("bufferView",t.bufferView).then(function(L){if(t.mimeType==="image/png"){const g=new DataView(L,25,1).getUint8(0,!1);d=g===6||g===4||g===3}f=!0;const x=new Blob([L],{type:t.mimeType});return u=c.createObjectURL(x),u});else if(t.uri===void 0)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const h=Promise.resolve(u).then(function(L){return new Promise(function(x,g){let M=x;n.isImageBitmapLoader===!0&&(M=function(A){const T=new ya(A);T.needsUpdate=!0,x(T)}),n.load(Sn(L,o.path),M,void 0,g)})}).then(function(L){f===!0&&c.revokeObjectURL(u),L.flipY=!1,r.name&&(L.name=r.name),d||(L.format=Lt);const g=(s.samplers||{})[r.sampler]||{};return L.magFilter=vn[g.magFilter]||ye,L.minFilter=vn[g.minFilter]||Jt,L.wrapS=_n[g.wrapS]||Mt,L.wrapT=_n[g.wrapT]||Mt,i.associations.set(L,{type:"textures",index:e}),L}).catch(function(){return console.error("THREE.GLTFLoader: Couldn't load texture",u),null});return this.textureCache[l]=h,h}assignTexture(e,t,n){const i=this;return this.getDependency("texture",n.index).then(function(s){if(n.texCoord!==void 0&&n.texCoord!=0&&!(t==="aoMap"&&n.texCoord==1)&&console.warn("THREE.GLTFLoader: Custom UV set "+n.texCoord+" for texture "+t+" not yet supported."),i.extensions[U.KHR_TEXTURE_TRANSFORM]){const o=n.extensions!==void 0?n.extensions[U.KHR_TEXTURE_TRANSFORM]:void 0;if(o){const r=i.associations.get(s);s=i.extensions[U.KHR_TEXTURE_TRANSFORM].extendTexture(s,o),i.associations.set(s,r)}}return e[t]=s,s})}assignFinalMaterial(e){const t=e.geometry;let n=e.material;const i=t.attributes.tangent!==void 0,s=t.attributes.color!==void 0,o=t.attributes.normal===void 0;if(e.isPoints){const r="PointsMaterial:"+n.uuid;let l=this.cache.get(r);l||(l=new sa,_t.prototype.copy.call(l,n),l.color.copy(n.color),l.map=n.map,l.sizeAttenuation=!1,this.cache.add(r,l)),n=l}else if(e.isLine){const r="LineBasicMaterial:"+n.uuid;let l=this.cache.get(r);l||(l=new oa,_t.prototype.copy.call(l,n),l.color.copy(n.color),this.cache.add(r,l)),n=l}if(i||s||o){let r="ClonedMaterial:"+n.uuid+":";n.isGLTFSpecularGlossinessMaterial&&(r+="specular-glossiness:"),i&&(r+="vertex-tangents:"),s&&(r+="vertex-colors:"),o&&(r+="flat-shading:");let l=this.cache.get(r);l||(l=n.clone(),s&&(l.vertexColors=!0),o&&(l.flatShading=!0),i&&(l.normalScale&&(l.normalScale.y*=-1),l.clearcoatNormalScale&&(l.clearcoatNormalScale.y*=-1)),this.cache.add(r,l),this.associations.set(l,this.associations.get(n))),n=l}n.aoMap&&t.attributes.uv2===void 0&&t.attributes.uv!==void 0&&t.setAttribute("uv2",t.attributes.uv),e.material=n}getMaterialType(){return St}loadMaterial(e){const t=this,n=this.json,i=this.extensions,s=n.materials[e];let o;const r={},l=s.extensions||{},c=[];if(l[U.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){const f=i[U.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];o=f.getMaterialType(),c.push(f.extendParams(r,s,t))}else if(l[U.KHR_MATERIALS_UNLIT]){const f=i[U.KHR_MATERIALS_UNLIT];o=f.getMaterialType(),c.push(f.extendParams(r,s,t))}else{const f=s.pbrMetallicRoughness||{};if(r.color=new C(1,1,1),r.opacity=1,Array.isArray(f.baseColorFactor)){const d=f.baseColorFactor;r.color.fromArray(d),r.opacity=d[3]}f.baseColorTexture!==void 0&&c.push(t.assignTexture(r,"map",f.baseColorTexture)),r.metalness=f.metallicFactor!==void 0?f.metallicFactor:1,r.roughness=f.roughnessFactor!==void 0?f.roughnessFactor:1,f.metallicRoughnessTexture!==void 0&&(c.push(t.assignTexture(r,"metalnessMap",f.metallicRoughnessTexture)),c.push(t.assignTexture(r,"roughnessMap",f.metallicRoughnessTexture))),o=this._invokeOne(function(d){return d.getMaterialType&&d.getMaterialType(e)}),c.push(Promise.all(this._invokeAll(function(d){return d.extendMaterialParams&&d.extendMaterialParams(e,r)})))}s.doubleSided===!0&&(r.side=ra);const u=s.alphaMode||Dt.OPAQUE;return u===Dt.BLEND?(r.transparent=!0,r.depthWrite=!1):(r.transparent=!1,u===Dt.MASK&&(r.alphaTest=s.alphaCutoff!==void 0?s.alphaCutoff:.5)),s.normalTexture!==void 0&&o!==Ue&&(c.push(t.assignTexture(r,"normalMap",s.normalTexture)),r.normalScale=new V(1,-1),s.normalTexture.scale!==void 0&&r.normalScale.set(s.normalTexture.scale,-s.normalTexture.scale)),s.occlusionTexture!==void 0&&o!==Ue&&(c.push(t.assignTexture(r,"aoMap",s.occlusionTexture)),s.occlusionTexture.strength!==void 0&&(r.aoMapIntensity=s.occlusionTexture.strength)),s.emissiveFactor!==void 0&&o!==Ue&&(r.emissive=new C().fromArray(s.emissiveFactor)),s.emissiveTexture!==void 0&&o!==Ue&&c.push(t.assignTexture(r,"emissiveMap",s.emissiveTexture)),Promise.all(c).then(function(){let f;return o===Ut?f=i[U.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(r):f=new o(r),s.name&&(f.name=s.name),f.map&&(f.map.encoding=Tt),f.emissiveMap&&(f.emissiveMap.encoding=Tt),ve(f,s),t.associations.set(f,{type:"materials",index:e}),s.extensions&&ze(i,f,s),f})}createUniqueName(e){const t=la.sanitizeNodeName(e||"");let n=t;for(let i=1;this.nodeNamesUsed[n];++i)n=t+"_"+i;return this.nodeNamesUsed[n]=!0,n}loadGeometries(e){const t=this,n=this.extensions,i=this.primitiveCache;function s(r){return n[U.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(r,t).then(function(l){return yn(l,r,t)})}const o=[];for(let r=0,l=e.length;r<l;r++){const c=e[r],u=Is(c),f=i[u];if(f)o.push(f.promise);else{let d;c.extensions&&c.extensions[U.KHR_DRACO_MESH_COMPRESSION]?d=s(c):d=yn(new Ge,c,t),i[u]={primitive:c,promise:d},o.push(d)}}return Promise.all(o)}loadMesh(e){const t=this,n=this.json,i=this.extensions,s=n.meshes[e],o=s.primitives,r=[];for(let l=0,c=o.length;l<c;l++){const u=o[l].material===void 0?Fs(this.cache):this.getDependency("material",o[l].material);r.push(u)}return r.push(t.loadGeometries(o)),Promise.all(r).then(function(l){const c=l.slice(0,l.length-1),u=l[l.length-1],f=[];for(let p=0,h=u.length;p<h;p++){const L=u[p],x=o[p];let g;const M=c[p];if(x.mode===ue.TRIANGLES||x.mode===ue.TRIANGLE_STRIP||x.mode===ue.TRIANGLE_FAN||x.mode===void 0)g=s.isSkinnedMesh===!0?new ca(L,M):new ua(L,M),g.isSkinnedMesh===!0&&!g.geometry.attributes.skinWeight.normalized&&g.normalizeSkinWeights(),x.mode===ue.TRIANGLE_STRIP?g.geometry=bn(g.geometry,fa):x.mode===ue.TRIANGLE_FAN&&(g.geometry=bn(g.geometry,en));else if(x.mode===ue.LINES)g=new da(L,M);else if(x.mode===ue.LINE_STRIP)g=new pa(L,M);else if(x.mode===ue.LINE_LOOP)g=new ma(L,M);else if(x.mode===ue.POINTS)g=new ha(L,M);else throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+x.mode);Object.keys(g.geometry.morphAttributes).length>0&&bs(g,s),g.name=t.createUniqueName(s.name||"mesh_"+e),ve(g,s),x.extensions&&ze(i,g,x),t.assignFinalMaterial(g),f.push(g)}if(f.length===1)return f[0];const d=new Ft;for(let p=0,h=f.length;p<h;p++)d.add(f[p]);return d})}loadCamera(e){let t;const n=this.json.cameras[e],i=n[n.type];if(!i){console.warn("THREE.GLTFLoader: Missing camera parameters.");return}return n.type==="perspective"?t=new jt(xa.radToDeg(i.yfov),i.aspectRatio||1,i.znear||1,i.zfar||2e6):n.type==="orthographic"&&(t=new La(-i.xmag,i.xmag,i.ymag,-i.ymag,i.znear,i.zfar)),n.name&&(t.name=this.createUniqueName(n.name)),ve(t,n),Promise.resolve(t)}loadSkin(e){const t=this.json.skins[e],n={joints:t.joints};return t.inverseBindMatrices===void 0?Promise.resolve(n):this.getDependency("accessor",t.inverseBindMatrices).then(function(i){return n.inverseBindMatrices=i,n})}loadAnimation(e){const n=this.json.animations[e],i=[],s=[],o=[],r=[],l=[];for(let c=0,u=n.channels.length;c<u;c++){const f=n.channels[c],d=n.samplers[f.sampler],p=f.target,h=p.node!==void 0?p.node:p.id,L=n.parameters!==void 0?n.parameters[d.input]:d.input,x=n.parameters!==void 0?n.parameters[d.output]:d.output;i.push(this.getDependency("node",h)),s.push(this.getDependency("accessor",L)),o.push(this.getDependency("accessor",x)),r.push(d),l.push(p)}return Promise.all([Promise.all(i),Promise.all(s),Promise.all(o),Promise.all(r),Promise.all(l)]).then(function(c){const u=c[0],f=c[1],d=c[2],p=c[3],h=c[4],L=[];for(let g=0,M=u.length;g<M;g++){const A=u[g],T=f[g],S=d[g],F=p[g],I=h[g];if(A===void 0)continue;A.updateMatrix(),A.matrixAutoUpdate=!0;let P;switch(pe[I.path]){case pe.weights:P=va;break;case pe.rotation:P=ga;break;case pe.position:case pe.scale:default:P=Aa;break}const y=A.name?A.name:A.uuid,E=F.interpolation!==void 0?Ms[F.interpolation]:$t,_=[];pe[I.path]===pe.weights?A.traverse(function(w){w.isMesh===!0&&w.morphTargetInfluences&&_.push(w.name?w.name:w.uuid)}):_.push(y);let N=S.array;if(S.normalized){const w=Ct(N.constructor),B=new Float32Array(N.length);for(let G=0,Q=N.length;G<Q;G++)B[G]=N[G]*w;N=B}for(let w=0,B=_.length;w<B;w++){const G=new P(_[w]+"."+pe[I.path],T.array,N,E);F.interpolation==="CUBICSPLINE"&&(G.createInterpolant=function(k){return new Ie(this.times,this.values,this.getValueSize()/3,k)},G.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),L.push(G)}}const x=n.name?n.name:"animation_"+e;return new _a(x,void 0,L)})}createNodeMesh(e){const t=this.json,n=this,i=t.nodes[e];return i.mesh===void 0?null:n.getDependency("mesh",i.mesh).then(function(s){const o=n._getNodeRef(n.meshCache,i.mesh,s);return i.weights!==void 0&&o.traverse(function(r){if(!!r.isMesh)for(let l=0,c=i.weights.length;l<c;l++)r.morphTargetInfluences[l]=i.weights[l]}),o})}loadNode(e){const t=this.json,n=this.extensions,i=this,s=t.nodes[e],o=s.name?i.createUniqueName(s.name):"";return function(){const r=[],l=i._invokeOne(function(c){return c.createNodeMesh&&c.createNodeMesh(e)});return l&&r.push(l),s.camera!==void 0&&r.push(i.getDependency("camera",s.camera).then(function(c){return i._getNodeRef(i.cameraCache,s.camera,c)})),i._invokeAll(function(c){return c.createNodeAttachment&&c.createNodeAttachment(e)}).forEach(function(c){r.push(c)}),Promise.all(r)}().then(function(r){let l;if(s.isBone===!0?l=new Ta:r.length>1?l=new Ft:r.length===1?l=r[0]:l=new Sa,l!==r[0])for(let c=0,u=r.length;c<u;c++)l.add(r[c]);if(s.name&&(l.userData.name=s.name,l.name=o),ve(l,s),s.extensions&&ze(n,l,s),s.matrix!==void 0){const c=new tt;c.fromArray(s.matrix),l.applyMatrix4(c)}else s.translation!==void 0&&l.position.fromArray(s.translation),s.rotation!==void 0&&l.quaternion.fromArray(s.rotation),s.scale!==void 0&&l.scale.fromArray(s.scale);return i.associations.set(l,{type:"nodes",index:e}),l})}loadScene(e){const t=this.json,n=this.extensions,i=this.json.scenes[e],s=this,o=new Ft;i.name&&(o.name=s.createUniqueName(i.name)),ve(o,i),i.extensions&&ze(n,o,i);const r=i.nodes||[],l=[];for(let c=0,u=r.length;c<u;c++)l.push(Fn(r[c],o,t,s));return Promise.all(l).then(function(){return o})}}function Fn(a,e,t,n){const i=t.nodes[a];return n.getDependency("node",a).then(function(s){if(i.skin===void 0)return s;let o;return n.getDependency("skin",i.skin).then(function(r){o=r;const l=[];for(let c=0,u=o.joints.length;c<u;c++)l.push(n.getDependency("node",o.joints[c]));return Promise.all(l)}).then(function(r){return s.traverse(function(l){if(!l.isMesh)return;const c=[],u=[];for(let f=0,d=r.length;f<d;f++){const p=r[f];if(p){c.push(p);const h=new tt;o.inverseBindMatrices!==void 0&&h.fromArray(o.inverseBindMatrices.array,f*16),u.push(h)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',o.joints[f])}l.bind(new Ma(c,u),l.matrixWorld)}),s})}).then(function(s){e.add(s);const o=[];if(i.children){const r=i.children;for(let l=0,c=r.length;l<c;l++){const u=r[l];o.push(Fn(u,s,t,n))}}return Promise.all(o)})}function Ps(a,e,t){const n=e.attributes,i=new tn;if(n.POSITION!==void 0){const r=t.json.accessors[n.POSITION],l=r.min,c=r.max;if(l!==void 0&&c!==void 0){if(i.set(new D(l[0],l[1],l[2]),new D(c[0],c[1],c[2])),r.normalized){const u=Ct(Oe[r.componentType]);i.min.multiplyScalar(u),i.max.multiplyScalar(u)}}else{console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");return}}else return;const s=e.targets;if(s!==void 0){const r=new D,l=new D;for(let c=0,u=s.length;c<u;c++){const f=s[c];if(f.POSITION!==void 0){const d=t.json.accessors[f.POSITION],p=d.min,h=d.max;if(p!==void 0&&h!==void 0){if(l.setX(Math.max(Math.abs(p[0]),Math.abs(h[0]))),l.setY(Math.max(Math.abs(p[1]),Math.abs(h[1]))),l.setZ(Math.max(Math.abs(p[2]),Math.abs(h[2]))),d.normalized){const L=Ct(Oe[d.componentType]);l.multiplyScalar(L)}r.max(l)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}i.expandByVector(r)}a.boundingBox=i;const o=new ba;i.getCenter(o.center),o.radius=i.min.distanceTo(i.max)/2,a.boundingSphere=o}function yn(a,e,t){const n=e.attributes,i=[];function s(o,r){return t.getDependency("accessor",o).then(function(l){a.setAttribute(r,l)})}for(const o in n){const r=Xt[o]||o.toLowerCase();r in a.attributes||i.push(s(n[o],r))}if(e.indices!==void 0&&!a.index){const o=t.getDependency("accessor",e.indices).then(function(r){a.setIndex(r)});i.push(o)}return ve(a,e),Ps(a,e,t),Promise.all(i).then(function(){return e.targets!==void 0?ys(a,e.targets,t):a})}function bn(a,e){let t=a.getIndex();if(t===null){const o=[],r=a.getAttribute("position");if(r!==void 0){for(let l=0;l<r.count;l++)o.push(l);a.setIndex(o),t=a.getIndex()}else return console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),a}const n=t.count-2,i=[];if(e===en)for(let o=1;o<=n;o++)i.push(t.getX(0)),i.push(t.getX(o)),i.push(t.getX(o+1));else for(let o=0;o<n;o++)o%2==0?(i.push(t.getX(o)),i.push(t.getX(o+1)),i.push(t.getX(o+2))):(i.push(t.getX(o+2)),i.push(t.getX(o+1)),i.push(t.getX(o)));i.length/3!==n&&console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const s=a.clone();return s.setIndex(i),s}const kt=new WeakMap;class In extends qt{constructor(e){super(e);this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setDecoderPath(e){return this.decoderPath=e,this}setDecoderConfig(e){return this.decoderConfig=e,this}setWorkerLimit(e){return this.workerLimit=e,this}load(e,t,n,i){const s=new nt(this.manager);s.setPath(this.path),s.setResponseType("arraybuffer"),s.setRequestHeader(this.requestHeader),s.setWithCredentials(this.withCredentials),s.load(e,o=>{const r={attributeIDs:this.defaultAttributeIDs,attributeTypes:this.defaultAttributeTypes,useUniqueIDs:!1};this.decodeGeometry(o,r).then(t).catch(i)},n,i)}decodeDracoFile(e,t,n,i){const s={attributeIDs:n||this.defaultAttributeIDs,attributeTypes:i||this.defaultAttributeTypes,useUniqueIDs:!!n};this.decodeGeometry(e,s).then(t)}decodeGeometry(e,t){for(const l in t.attributeTypes){const c=t.attributeTypes[l];c.BYTES_PER_ELEMENT!==void 0&&(t.attributeTypes[l]=c.name)}const n=JSON.stringify(t);if(kt.has(e)){const l=kt.get(e);if(l.key===n)return l.promise;if(e.byteLength===0)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let i;const s=this.workerNextTaskID++,o=e.byteLength,r=this._getWorker(s,o).then(l=>(i=l,new Promise((c,u)=>{i._callbacks[s]={resolve:c,reject:u},i.postMessage({type:"decode",id:s,taskConfig:t,buffer:e},[e])}))).then(l=>this._createGeometry(l.geometry));return r.catch(()=>!0).then(()=>{i&&s&&this._releaseTask(i,s)}),kt.set(e,{key:n,promise:r}),r}_createGeometry(e){const t=new Ge;e.index&&t.setIndex(new ie(e.index.array,1));for(let n=0;n<e.attributes.length;n++){const i=e.attributes[n],s=i.name,o=i.array,r=i.itemSize;t.setAttribute(s,new ie(o,r))}return t}_loadLibrary(e,t){const n=new nt(this.manager);return n.setPath(this.decoderPath),n.setResponseType(t),n.setWithCredentials(this.withCredentials),new Promise((i,s)=>{n.load(e,i,void 0,s)})}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const e=typeof WebAssembly!="object"||this.decoderConfig.type==="js",t=[];return e?t.push(this._loadLibrary("draco_decoder.js","text")):(t.push(this._loadLibrary("draco_wasm_wrapper.js","text")),t.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(t).then(n=>{const i=n[0];e||(this.decoderConfig.wasmBinary=n[1]);const s=Rs.toString(),o=["/* draco decoder */",i,"","/* worker */",s.substring(s.indexOf("{")+1,s.lastIndexOf("}"))].join(`
`);this.workerSourceURL=URL.createObjectURL(new Blob([o]))}),this.decoderPending}_getWorker(e,t){return this._initDecoder().then(()=>{if(this.workerPool.length<this.workerLimit){const i=new Worker(this.workerSourceURL);i._callbacks={},i._taskCosts={},i._taskLoad=0,i.postMessage({type:"init",decoderConfig:this.decoderConfig}),i.onmessage=function(s){const o=s.data;switch(o.type){case"decode":i._callbacks[o.id].resolve(o);break;case"error":i._callbacks[o.id].reject(o);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+o.type+'"')}},this.workerPool.push(i)}else this.workerPool.sort(function(i,s){return i._taskLoad>s._taskLoad?-1:1});const n=this.workerPool[this.workerPool.length-1];return n._taskCosts[e]=t,n._taskLoad+=t,n})}_releaseTask(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]}debug(){console.log("Task load: ",this.workerPool.map(e=>e._taskLoad))}dispose(){for(let e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,this}}function Rs(){let a,e;onmessage=function(o){const r=o.data;switch(r.type){case"init":a=r.decoderConfig,e=new Promise(function(u){a.onModuleLoaded=function(f){u({draco:f})},DracoDecoderModule(a)});break;case"decode":const l=r.buffer,c=r.taskConfig;e.then(u=>{const f=u.draco,d=new f.Decoder,p=new f.DecoderBuffer;p.Init(new Int8Array(l),l.byteLength);try{const h=t(f,d,p,c),L=h.attributes.map(x=>x.array.buffer);h.index&&L.push(h.index.array.buffer),self.postMessage({type:"decode",id:r.id,geometry:h},L)}catch(h){console.error(h),self.postMessage({type:"error",id:r.id,error:h.message})}finally{f.destroy(p),f.destroy(d)}});break}};function t(o,r,l,c){const u=c.attributeIDs,f=c.attributeTypes;let d,p;const h=r.GetEncodedGeometryType(l);if(h===o.TRIANGULAR_MESH)d=new o.Mesh,p=r.DecodeBufferToMesh(l,d);else if(h===o.POINT_CLOUD)d=new o.PointCloud,p=r.DecodeBufferToPointCloud(l,d);else throw new Error("THREE.DRACOLoader: Unexpected geometry type.");if(!p.ok()||d.ptr===0)throw new Error("THREE.DRACOLoader: Decoding failed: "+p.error_msg());const L={index:null,attributes:[]};for(const x in u){const g=self[f[x]];let M,A;if(c.useUniqueIDs)A=u[x],M=r.GetAttributeByUniqueId(d,A);else{if(A=r.GetAttributeId(d,o[u[x]]),A===-1)continue;M=r.GetAttribute(d,A)}L.attributes.push(i(o,r,d,x,g,M))}return h===o.TRIANGULAR_MESH&&(L.index=n(o,r,d)),o.destroy(d),L}function n(o,r,l){const u=l.num_faces()*3,f=u*4,d=o._malloc(f);r.GetTrianglesUInt32Array(l,f,d);const p=new Uint32Array(o.HEAPF32.buffer,d,u).slice();return o._free(d),{array:p,itemSize:1}}function i(o,r,l,c,u,f){const d=f.num_components(),h=l.num_points()*d,L=h*u.BYTES_PER_ELEMENT,x=s(o,u),g=o._malloc(L);r.GetAttributeDataArrayForAllPoints(l,f,x,L,g);const M=new u(o.HEAPF32.buffer,g,h).slice();return o._free(g),{name:c,array:M,itemSize:d}}function s(o,r){switch(r){case Float32Array:return o.DT_FLOAT32;case Int8Array:return o.DT_INT8;case Int16Array:return o.DT_INT16;case Int32Array:return o.DT_INT32;case Uint8Array:return o.DT_UINT8;case Uint16Array:return o.DT_UINT16;case Uint32Array:return o.DT_UINT32}}}function Es(a){const e=new tn;return e.setFromObject(a),e}function Ws(a,e,t){const n=Es(t),i=new D;n.getCenter(i);const s=n.min.distanceTo(n.max);a.position.set(0,(n.max.y-n.min.y)*.5,s*1),a.aperture=.01*s,e.target.copy(i),e.update()}function Nn(a,e,t){const n=new Ia;return n.setURLModifier((i,s)=>{const o=e+i.replace(a,"").replace(/^(\.?\/)/,"");if(t&&t.has(o)){const r=t.get(o);return URL.createObjectURL(r)}return(s||"")+i}),n}function Qs(a){return new Promise((e,t)=>{new wt().load(a,i=>{e(i)},void 0,t)})}function Ks(a){return new Promise((e,t)=>{const n=new wt;n.setDRACOLoader(new In().setDecoderPath("/draco/gltf/")),n.setCrossOrigin("anonymous"),n.load(a,i=>{e(i)},void 0,t)})}function Gs(a,e,t){const n=Le.extractUrlBase(a);return new Promise((i,s)=>{const o=Nn(n,e,t),r=new wt(o);r.setDRACOLoader(new In().setDecoderPath("/draco/gltf/")),r.setCrossOrigin("anonymous"),r.load(a,l=>{i(l)},void 0,s)})}function Zs(a){let e,t;Array.from(a).forEach(([i,s])=>{s.name.match(/\.(gltf|glb)$/)&&(e=s,t=i.replace(s.name,""))}),e||console.error("No .gltf or .glb asset found.");const n=typeof e=="string"?e:URL.createObjectURL(e);return Gs(n,t,a)}function ws(a,e){const t=Le.extractUrlBase(a);return new Promise((n,i)=>{const s=Nn(t,e);new Pa(s).load(a,r=>{n(r)},void 0,i)})}function js(a){let e,t;Array.from(a).forEach(([i,s])=>{s.name.match(/\.(hdr)$/)&&(e=s,t=i.replace(s.name,""))}),e||console.error("No .hdr asset found.");const n=typeof e=="string"?e:URL.createObjectURL(e);return ws(n,t)}function qs(a,e){!a||a.length==0||a.forEach(t=>{switch(t.type){case"PointLight":const n=new os(new C().fromArray(t.emission),1);n.position.fromArray(t.position),e.add(n);break;case"QuadLight":const i=new is(new C().fromArray(t.emission),1,new D().fromArray(t.v1),new D().fromArray(t.v2));i.position.fromArray(t.position),t.visible!=null&&(i.visible=t.visible),e.add(i);break;case"RectAreaLight":const s=new as(new C().fromArray(t.emission),1,t.width,t.height);s.position.fromArray(t.position),t.target&&s.target.fromArray(t.target),t.visible!=null&&(s.visible=t.visible),e.add(s);break;case"SphereAreaLight":const o=new ss(new C().fromArray(t.emission),1,t.radius);o.position.fromArray(t.position),t.visible!=null&&(o.visible=t.visible),e.add(o);break;case"DirectionalLight":const r=new rs(new C().fromArray(t.emission),1);r.position.fromArray(t.position),t.target&&r.target.fromArray(t.target),e.add(r);break;default:console.warn(`No support light type: ${t.type}`);break}})}var ot=function(){var a=0,e=document.createElement("div");e.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",e.addEventListener("click",function(u){u.preventDefault(),n(++a%e.children.length)},!1);function t(u){return e.appendChild(u.dom),u}function n(u){for(var f=0;f<e.children.length;f++)e.children[f].style.display=f===u?"block":"none";a=u}var i=(performance||Date).now(),s=i,o=0,r=t(new ot.Panel("FPS","#0ff","#002")),l=t(new ot.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var c=t(new ot.Panel("MB","#f08","#201"));return n(0),{REVISION:16,dom:e,addPanel:t,showPanel:n,begin:function(){i=(performance||Date).now()},end:function(){o++;var u=(performance||Date).now();if(l.update(u-i,200),u>=s+1e3&&(r.update(o*1e3/(u-s),100),s=u,o=0,c)){var f=performance.memory;c.update(f.usedJSHeapSize/1048576,f.jsHeapSizeLimit/1048576)}return u},update:function(){i=this.end()},domElement:e,setMode:n}};ot.Panel=function(a,e,t){var n=1/0,i=0,s=Math.round,o=s(window.devicePixelRatio||1),r=80*o,l=48*o,c=3*o,u=2*o,f=3*o,d=15*o,p=74*o,h=30*o,L=document.createElement("canvas");L.width=r,L.height=l,L.style.cssText="width:80px;height:48px";var x=L.getContext("2d");return x.font="bold "+9*o+"px Helvetica,Arial,sans-serif",x.textBaseline="top",x.fillStyle=t,x.fillRect(0,0,r,l),x.fillStyle=e,x.fillText(a,c,u),x.fillRect(f,d,p,h),x.fillStyle=t,x.globalAlpha=.9,x.fillRect(f,d,p,h),{dom:L,update:function(g,M){n=Math.min(n,g),i=Math.max(i,g),x.fillStyle=t,x.globalAlpha=1,x.fillRect(0,0,r,d),x.fillStyle=e,x.fillText(s(g)+" "+a+" ("+s(n)+"-"+s(i)+")",c,u),x.drawImage(L,f+o,d,p-o,h,f,d,p-o,h),x.fillRect(f+p-o,d,o,h),x.fillStyle=t,x.globalAlpha=.9,x.fillRect(f+p-o,d,o,s((1-g/M)*h))}}};export{ln as D,wt as G,Cs as L,Ds as O,Pa as R,ot as S,zs as T,Ks as a,Bs as b,js as c,Qs as d,ks as e,Vs as f,Os as g,Hs as h,Zs as i,qs as l,Ys as s,Ws as u};
